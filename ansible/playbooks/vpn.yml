---
# COMPLIANCE_SENTINEL: TL-INFRA-004 | control=ssh-hardening
# COMPLIANCE_SENTINEL: TL-NET-003 | control=host-firewall
- name: Configure WireGuard VPN server
  hosts: all
  become: true

  vars:
    ansible_python_interpreter: /usr/bin/python3
    linux_security_baseline_manage_ufw: true
    linux_security_baseline_ufw_allow_rules:
      - { port: "22", proto: "tcp" }
      - { port: "{{ wireguard_port | string }}", proto: "udp" }
    linux_security_baseline_ssh_settings:
      - { key: "PermitRootLogin", value: "no" }
      - { key: "PasswordAuthentication", value: "no" }
      - { key: "PubkeyAuthentication", value: "yes" }
      - { key: "MaxAuthTries", value: "3" }
      - { key: "KbdInteractiveAuthentication", value: "no" }
    wireguard_interface: wg0
    wireguard_port: 51820
    wireguard_cidr: 10.200.0.1/24
    wireguard_clients_cidr: 10.200.0.0/24
    wireguard_client_subnet_prefix: 10.200.0
    wireguard_private_network_cidr: 10.100.0.0/16
    wireguard_client_allowed_ips: "{{ wireguard_private_network_cidr }}, {{ wireguard_clients_cidr }}"
    wireguard_dns_servers: "1.1.1.1, 8.8.8.8"
    wireguard_endpoint_discovery_url: http://169.254.169.254/hetzner/v1/metadata/public-ipv4
    wireguard_config_path: "/etc/wireguard/{{ wireguard_interface }}.conf"
    wireguard_uplink_interface: "{{ ansible_default_ipv4.interface }}"

  tasks:
    - name: Apply shared Linux security baseline
      ansible.builtin.import_tasks: tasks/linuxSecurityBaseline.yml

    - name: Install WireGuard packages
      ansible.builtin.apt:
        name:
          - wireguard
          - wireguard-tools
          - qrencode
        state: present
        update_cache: true

    - name: Enable IP forwarding for WireGuard
      ansible.builtin.copy:
        dest: /etc/sysctl.d/99-wireguard.conf
        content: |
          net.ipv4.ip_forward = 1
          net.ipv6.conf.all.forwarding = 1
        owner: root
        group: root
        mode: "0644"
      notify: Reload sysctl

    - name: Ensure WireGuard directory exists
      ansible.builtin.file:
        path: /etc/wireguard
        state: directory
        owner: root
        group: root
        mode: "0700"

    - name: Generate WireGuard server keys if missing
      ansible.builtin.shell:
        cmd: |
          set -euo pipefail
          wg genkey | tee /etc/wireguard/server_private.key | wg pubkey > /etc/wireguard/server_public.key
          chmod 600 /etc/wireguard/server_private.key
          chmod 644 /etc/wireguard/server_public.key
        executable: /bin/bash
      args:
        creates: /etc/wireguard/server_private.key
      no_log: true

    - name: Ensure WireGuard server public key exists
      ansible.builtin.shell:
        cmd: |
          set -euo pipefail
          wg pubkey < /etc/wireguard/server_private.key > /etc/wireguard/server_public.key
          chmod 644 /etc/wireguard/server_public.key
        executable: /bin/bash
      args:
        creates: /etc/wireguard/server_public.key

    - name: Read WireGuard server private key
      ansible.builtin.command:
        cmd: cat /etc/wireguard/server_private.key
      register: wg_private_key
      changed_when: false
      no_log: true

    - name: Check if WireGuard interface config exists
      ansible.builtin.stat:
        path: "{{ wireguard_config_path }}"
      register: wg_interface_conf

    - name: Create WireGuard interface config if missing
      ansible.builtin.copy:
        dest: "{{ wireguard_config_path }}"
        content: |
          [Interface]
          Address = {{ wireguard_cidr }}
          ListenPort = {{ wireguard_port }}
          PrivateKey = {{ wg_private_key.stdout }}
          PostUp = iptables -A FORWARD -i {{ wireguard_interface }} -j ACCEPT;iptables -t nat -A POSTROUTING -o {{ wireguard_uplink_interface }} -j MASQUERADE
          PostDown = iptables -D FORWARD -i {{ wireguard_interface }} -j ACCEPT;iptables -t nat -D POSTROUTING -o {{ wireguard_uplink_interface }} -j MASQUERADE
        owner: root
        group: root
        mode: "0600"
      when: not wg_interface_conf.stat.exists
      notify: Restart wireguard
      no_log: true

    - name: Ensure WireGuard clients directory exists
      ansible.builtin.file:
        path: /etc/wireguard/clients
        state: directory
        owner: root
        group: root
        mode: "0750"

    - name: Install helper script for adding WireGuard clients
      ansible.builtin.template:
        src: templates/wg-add-client.sh.j2
        dest: /usr/local/bin/wg-add-client
        owner: root
        group: root
        mode: "0750"

    - name: Enable and start WireGuard service
      ansible.builtin.systemd:
        name: "wg-quick@{{ wireguard_interface }}"
        enabled: true
        state: started

  handlers:
    - name: Restart sshd
      ansible.builtin.systemd:
        name: ssh
        state: restarted

    - name: Reload sysctl
      ansible.builtin.command:
        cmd: sysctl --system
      changed_when: true

    - name: Restart wireguard
      ansible.builtin.systemd:
        name: "wg-quick@{{ wireguard_interface }}"
        state: restarted
