---
- name: Configure WireGuard VPN server
  hosts: all
  become: true

  vars:
    ansible_python_interpreter: /usr/bin/python3
    linux_security_baseline_manage_ufw: true
    linux_security_baseline_ufw_allow_rules:
      - { port: "22", proto: "tcp" }
      - { port: "{{ wireguard_port | string }}", proto: "udp" }
    linux_security_baseline_ssh_settings:
      - { key: "PermitRootLogin", value: "no" }
      - { key: "PasswordAuthentication", value: "no" }
      - { key: "PubkeyAuthentication", value: "yes" }
      - { key: "MaxAuthTries", value: "3" }
      - { key: "KbdInteractiveAuthentication", value: "no" }
    wireguard_interface: wg0
    wireguard_port: 51820
    wireguard_cidr: 10.200.0.1/24
    wireguard_clients_cidr: 10.200.0.0/24
    wireguard_uplink_interface: "{{ ansible_default_ipv4.interface }}"

  tasks:
    - name: Apply shared Linux security baseline
      ansible.builtin.import_tasks: tasks/linuxSecurityBaseline.yml

    - name: Install WireGuard packages
      ansible.builtin.apt:
        name:
          - wireguard
          - wireguard-tools
          - qrencode
        state: present
        update_cache: true

    - name: Enable IP forwarding for WireGuard
      ansible.builtin.copy:
        dest: /etc/sysctl.d/99-wireguard.conf
        content: |
          net.ipv4.ip_forward = 1
          net.ipv6.conf.all.forwarding = 1
        owner: root
        group: root
        mode: "0644"
      notify: Reload sysctl

    - name: Ensure WireGuard directory exists
      ansible.builtin.file:
        path: /etc/wireguard
        state: directory
        owner: root
        group: root
        mode: "0700"

    - name: Generate WireGuard server private key
      ansible.builtin.command:
        cmd: wg genkey
        creates: /etc/wireguard/server_private.key
      register: wg_private_key_gen
      changed_when: wg_private_key_gen.rc == 0

    - name: Persist WireGuard server private key
      ansible.builtin.copy:
        dest: /etc/wireguard/server_private.key
        content: "{{ wg_private_key_gen.stdout }}\n"
        owner: root
        group: root
        mode: "0600"
      when: wg_private_key_gen is changed
      no_log: true

    - name: Generate WireGuard server public key
      ansible.builtin.shell:
        cmd: |
          set -euo pipefail
          wg pubkey < /etc/wireguard/server_private.key > /etc/wireguard/server_public.key
        executable: /bin/bash
      args:
        creates: /etc/wireguard/server_public.key

    - name: Read WireGuard server private key
      ansible.builtin.command:
        cmd: cat /etc/wireguard/server_private.key
      register: wg_private_key
      changed_when: false
      no_log: true

    - name: Check if WireGuard interface config exists
      ansible.builtin.stat:
        path: "/etc/wireguard/{{ wireguard_interface }}.conf"
      register: wg_interface_conf

    - name: Create WireGuard interface config if missing
      ansible.builtin.copy:
        dest: "/etc/wireguard/{{ wireguard_interface }}.conf"
        content: |
          [Interface]
          Address = {{ wireguard_cidr }}
          ListenPort = {{ wireguard_port }}
          PrivateKey = {{ wg_private_key.stdout }}
          PostUp = iptables -A FORWARD -i {{ wireguard_interface }} -j ACCEPT; iptables -t nat -A POSTROUTING -o {{ wireguard_uplink_interface }} -j MASQUERADE
          PostDown = iptables -D FORWARD -i {{ wireguard_interface }} -j ACCEPT; iptables -t nat -D POSTROUTING -o {{ wireguard_uplink_interface }} -j MASQUERADE
        owner: root
        group: root
        mode: "0600"
      when: not wg_interface_conf.stat.exists
      notify: Restart wireguard
      no_log: true

    - name: Ensure WireGuard clients directory exists
      ansible.builtin.file:
        path: /etc/wireguard/clients
        state: directory
        owner: root
        group: root
        mode: "0750"

    - name: Install helper script for adding WireGuard clients
      ansible.builtin.copy:
        dest: /usr/local/bin/wg-add-client
        owner: root
        group: root
        mode: "0750"
        content: |
          #!/usr/bin/env bash
          set -euo pipefail

          CLIENT_NAME="${1:-}"
          if [ -z "$CLIENT_NAME" ]; then
            echo "Usage: wg-add-client <client-name>"
            exit 1
          fi

          CLIENT_DIR="/etc/wireguard/clients/$CLIENT_NAME"
          mkdir -p "$CLIENT_DIR"

          wg genkey | tee "$CLIENT_DIR/private.key" | wg pubkey > "$CLIENT_DIR/public.key"
          chmod 600 "$CLIENT_DIR/private.key"

          LAST_IP=$(grep -oP 'AllowedIPs = 10\\.200\\.0\\.\\K[0-9]+' /etc/wireguard/{{ wireguard_interface }}.conf | sort -n | tail -1 || true)
          if [ -n "$LAST_IP" ]; then
            NEXT_IP=$((LAST_IP + 1))
          else
            NEXT_IP=2
          fi

          cat >> /etc/wireguard/{{ wireguard_interface }}.conf <<EOF

          [Peer]
          # $CLIENT_NAME
          PublicKey = $(cat "$CLIENT_DIR/public.key")
          AllowedIPs = 10.200.0.$NEXT_IP/32
          EOF

          SERVER_PUBLIC=$(cat /etc/wireguard/server_public.key)
          SERVER_IP=$(curl -fsSL http://169.254.169.254/hetzner/v1/metadata/public-ipv4)

          cat > "$CLIENT_DIR/$CLIENT_NAME.conf" <<EOF
          [Interface]
          PrivateKey = $(cat "$CLIENT_DIR/private.key")
          Address = 10.200.0.$NEXT_IP/24
          DNS = 1.1.1.1, 8.8.8.8

          [Peer]
          PublicKey = $SERVER_PUBLIC
          Endpoint = $SERVER_IP:{{ wireguard_port }}
          AllowedIPs = 0.0.0.0/0, ::/0
          PersistentKeepalive = 25
          EOF

          wg syncconf {{ wireguard_interface }} <(wg-quick strip {{ wireguard_interface }})
          echo "Client config: $CLIENT_DIR/$CLIENT_NAME.conf"
          qrencode -t ansiutf8 < "$CLIENT_DIR/$CLIENT_NAME.conf"

    - name: Enable and start WireGuard service
      ansible.builtin.systemd:
        name: "wg-quick@{{ wireguard_interface }}"
        enabled: true
        state: started

  handlers:
    - name: Restart sshd
      ansible.builtin.systemd:
        name: ssh
        state: restarted

    - name: Reload sysctl
      ansible.builtin.command:
        cmd: sysctl --system
      changed_when: true

    - name: Restart wireguard
      ansible.builtin.systemd:
        name: "wg-quick@{{ wireguard_interface }}"
        state: restarted
