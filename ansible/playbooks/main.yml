---
- name: Configure main server
  hosts: all
  become: true

  vars:
    ansible_python_interpreter: /usr/bin/python3
    domain: "{{ lookup('env', 'TF_VAR_STAGING_DOMAIN') | mandatory('TF_VAR_STAGING_DOMAIN environment variable is required') }}"
    certbot_email: "{{ lookup('env', 'CERTBOT_EMAIL') | mandatory('CERTBOT_EMAIL environment variable is required') }}"
    deploy_public_key: "{{ lookup('pipe', 'ssh-keygen -y -f ' ~ playbook_dir ~ '/../../.secrets/deploy.key') }}"
    nodejs_major_version: 24
    sites:
      - www
      - app
    web_root_directories:
      - www
      - app
      - downloads
    subdomains:
      - www
      - app
      - api
      - download
      - email
    patch_time: "03:00"
    patch_timezone: "UTC"
    postgresql_version: 16
    tuxedo_github_deploy_key_name: tuxedoGithubDeployKey
    tuxedo_github_deploy_key_path: "{{ playbook_dir }}/../../.secrets/tuxedoGithubDeployKey"
    # PostgreSQL backup configuration
    backup_dir: /var/backups/postgres
    backup_retention_days: 7
    backup_time: "02:00"
    backup_timezone: "UTC"
    # Audit logging configuration (compliance)
    audit_log_retention_days: 90
    audit_archive_retention_years: 6
    audit_archive_dir: /var/archive/audit-logs
    journald_system_max_use: 4G
    journald_runtime_max_use: 500M
    nginx_log_rotate_days: 90

  tasks:
    - name: Add GitHub Actions deploy key to authorized_keys
      ansible.posix.authorized_key:
        user: "{{ ansible_user }}"
        state: present
        key: "{{ deploy_public_key }}"

    - name: Ensure SSH directory exists for deploy key
      ansible.builtin.file:
        path: "/home/{{ ansible_user }}/.ssh"
        state: directory
        mode: "0700"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Install GitHub deploy key for tuxedo
      ansible.builtin.copy:
        src: "{{ tuxedo_github_deploy_key_path }}"
        dest: "/home/{{ ansible_user }}/.ssh/{{ tuxedo_github_deploy_key_name }}"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0600"

    - name: Configure GitHub SSH host alias for tuxedo deploy key
      ansible.builtin.blockinfile:
        path: "/home/{{ ansible_user }}/.ssh/config"
        create: true
        mode: "0600"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        block: |
          Host github.com-tuxedo
            HostName github.com
            User git
            IdentityFile /home/{{ ansible_user }}/.ssh/{{ tuxedo_github_deploy_key_name }}
            IdentitiesOnly yes

    - name: Add server user to systemd-journal group
      ansible.builtin.user:
        name: "{{ ansible_user }}"
        groups: systemd-journal
        append: true

    # COMPLIANCE_SENTINEL: TL-INFRA-004 | control=ssh-hardening
    # SSH hardening: comprehensive security configuration
    - name: Deploy hardened SSH configuration
      ansible.builtin.template:
        src: sshd_config.j2
        dest: /etc/ssh/sshd_config
        owner: root
        group: root
        mode: "0600"
        validate: 'sshd -t -f %s'
      notify: Restart sshd

    - name: Update apt cache and upgrade all packages
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
        upgrade: dist

    - name: Install required packages
      ansible.builtin.apt:
        name:
          - nginx
          - certbot
          - python3-certbot-nginx
          - ca-certificates
          - curl
          - redis-server
          - postgresql
          - postgresql-contrib
          - python3-psycopg2
          - ncurses-bin
          - ufw
          - fail2ban
        state: present

    # COMPLIANCE_SENTINEL: TL-NET-003 | control=host-firewall
    # UFW firewall configuration with default deny
    # Framework mappings:
    # - SOC2: CC6.6 (External Threat Protection)
    # - NIST SP 800-53: SC-7 (Boundary Protection)
    # - HIPAA: 164.312(e)(1) (Transmission Security)
    - name: Set UFW default incoming policy to deny
      community.general.ufw:
        default: deny
        direction: incoming

    - name: Set UFW default outgoing policy to allow
      community.general.ufw:
        default: allow
        direction: outgoing

    - name: Allow required traffic through UFW
      community.general.ufw:
        rule: allow
        port: "{{ item.port }}"
        proto: tcp
        comment: "{{ item.comment }}"
      loop:
        - { port: "22", comment: "SSH access" }
        - { port: "80", comment: "HTTP for certbot and redirects" }
        - { port: "443", comment: "HTTPS web traffic" }
        - { port: "25", comment: "SMTP mail reception" }

    - name: Enable UFW
      community.general.ufw:
        state: enabled

    # COMPLIANCE_SENTINEL: TL-KERN-001 | control=kernel-hardening
    # Sysctl kernel security hardening
    # Framework mappings:
    # - SOC2: CC6.1 (Logical Access Security)
    # - NIST SP 800-53: SC-5, SI-16 (DoS Protection, Memory Protection)
    - name: Deploy kernel hardening sysctl configuration
      ansible.builtin.template:
        src: 99-security-hardening.conf.j2
        dest: /etc/sysctl.d/99-security-hardening.conf
        owner: root
        group: root
        mode: "0644"
      notify: Reload sysctl

    # COMPLIANCE_SENTINEL: TL-AUTH-001 | control=brute-force-protection
    # Fail2ban for SSH brute-force protection
    # Framework mappings:
    # - SOC2: CC6.1 (Logical Access Security)
    # - NIST SP 800-53: AC-7 (Unsuccessful Logon Attempts)
    # - HIPAA: 164.312(d) (Person or Entity Authentication)
    - name: Deploy fail2ban SSH jail configuration
      ansible.builtin.template:
        src: fail2ban-sshd.conf.j2
        dest: /etc/fail2ban/jail.d/sshd.conf
        owner: root
        group: root
        mode: "0644"
      notify: Restart fail2ban

    - name: Enable and start fail2ban
      ansible.builtin.systemd:
        name: fail2ban
        state: started
        enabled: true

    # Ghostty terminal support
    - name: Copy Ghostty terminfo
      ansible.builtin.copy:
        src: files/ghostty.terminfo
        dest: /tmp/ghostty.terminfo
        mode: "0644"
      register: copy_terminfo_result

    - name: Check for existing compiled Ghostty terminfo
      ansible.builtin.stat:
        path: /usr/share/terminfo/g/ghostty
      register: compiled_terminfo_stat

    - name: Compile Ghostty terminfo system-wide
      ansible.builtin.command:
        cmd: tic -x -o /usr/share/terminfo /tmp/ghostty.terminfo
      when: copy_terminfo_result.changed or not compiled_terminfo_stat.stat.exists
      changed_when: true

    - name: Create keyrings directory
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"

    # Node.js installation for API
    - name: Download and dearmor NodeSource GPG key
      ansible.builtin.shell:
        cmd: set -o pipefail && curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg
        executable: /bin/bash
        creates: /etc/apt/keyrings/nodesource.gpg

    - name: Set permissions on NodeSource GPG key
      ansible.builtin.file:
        path: /etc/apt/keyrings/nodesource.gpg
        mode: "0644"

    - name: Add NodeSource repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_{{ nodejs_major_version }}.x nodistro main"
        state: present
        filename: nodesource

    - name: Install Node.js
      ansible.builtin.apt:
        name: nodejs
        state: present
        update_cache: true

    # Redis configuration
    - name: Configure Redis to bind to localhost only
      ansible.builtin.lineinfile:
        path: /etc/redis/redis.conf
        regexp: '^bind '
        line: 'bind 127.0.0.1 ::1'
      notify: Restart redis

    - name: Ensure Redis is running and enabled
      ansible.builtin.systemd:
        name: redis-server
        state: started
        enabled: true

    # PostgreSQL configuration
    - name: Configure PostgreSQL to listen on localhost only
      ansible.builtin.lineinfile:
        path: /etc/postgresql/{{ postgresql_version }}/main/postgresql.conf
        regexp: "^#?listen_addresses\\s*="
        line: "listen_addresses = 'localhost'"
      notify: Restart postgresql

    - name: Ensure PostgreSQL is running and enabled
      ansible.builtin.systemd:
        name: postgresql
        state: started
        enabled: true

    - name: Ensure Postgres service account exists
      community.postgresql.postgresql_user:
        name: "{{ lookup('env', 'POSTGRES_USER') | mandatory('POSTGRES_USER environment variable is required') }}"
        password: "{{ lookup('env', 'POSTGRES_PASSWORD') | mandatory('POSTGRES_PASSWORD environment variable is required') }}"
        role_attr_flags: "LOGIN"
        state: present
      become: true
      become_user: postgres

    - name: Ensure Postgres database exists
      community.postgresql.postgresql_db:
        name: "{{ lookup('env', 'POSTGRES_DATABASE') | mandatory('POSTGRES_DATABASE environment variable is required') }}"
        owner: "{{ lookup('env', 'POSTGRES_USER') | mandatory('POSTGRES_USER environment variable is required') }}"
        state: present
      become: true
      become_user: postgres

    # API directory and service
    - name: Create API directory
      ansible.builtin.file:
        path: /opt/tearleads-api
        state: directory
        owner: "{{ ansible_user }}"
        group: www-data
        mode: "0775"
        recurse: true

    - name: Create API environment file
      ansible.builtin.copy:
        dest: /opt/tearleads-api/.env
        content: |
          JWT_SECRET={{ lookup('env', 'JWT_SECRET') | mandatory('JWT_SECRET environment variable is required') }}
          OPENROUTER_API_KEY={{ lookup('env', 'OPENROUTER_API_KEY') | mandatory('OPENROUTER_API_KEY environment variable is required') }}
          POSTGRES_DATABASE={{ lookup('env', 'POSTGRES_DATABASE') | mandatory('POSTGRES_DATABASE environment variable is required') }}
          POSTGRES_HOST={{ lookup('env', 'POSTGRES_HOST') | mandatory('POSTGRES_HOST environment variable is required') }}
          POSTGRES_PASSWORD={{ lookup('env', 'POSTGRES_PASSWORD') | mandatory('POSTGRES_PASSWORD environment variable is required') }}
          POSTGRES_PORT={{ lookup('env', 'POSTGRES_PORT') | mandatory('POSTGRES_PORT environment variable is required') }}
          POSTGRES_USER={{ lookup('env', 'POSTGRES_USER') | mandatory('POSTGRES_USER environment variable is required') }}
        owner: "{{ ansible_user }}"
        group: www-data
        mode: "0640"
      no_log: true
      notify: Restart tearleads-api

    - name: Deploy tearleads-api systemd service
      ansible.builtin.template:
        src: tearleads-api.service.j2
        dest: /etc/systemd/system/tearleads-api.service
        owner: root
        group: root
        mode: "0644"
      notify:
        - Reload systemd
        - Restart tearleads-api

    - name: Enable tearleads-api service
      ansible.builtin.systemd:
        name: tearleads-api
        enabled: true
        daemon_reload: true

    # SMTP Listener directory and service
    - name: Create SMTP Listener directory
      ansible.builtin.file:
        path: /opt/tearleads-smtp-listener
        state: directory
        owner: "{{ ansible_user }}"
        group: www-data
        mode: "0775"
        recurse: true

    - name: Create SMTP Listener environment file
      ansible.builtin.copy:
        dest: /opt/tearleads-smtp-listener/.env
        content: |
          SMTP_RECIPIENT_DOMAINS={{ lookup('env', 'SMTP_RECIPIENT_DOMAINS') | mandatory('SMTP_RECIPIENT_DOMAINS environment variable is required') }}
        owner: "{{ ansible_user }}"
        group: www-data
        mode: "0640"
      no_log: true
      notify: Restart tearleads-smtp-listener

    - name: Deploy tearleads-smtp-listener systemd service
      ansible.builtin.template:
        src: tearleads-smtp-listener.service.j2
        dest: /etc/systemd/system/tearleads-smtp-listener.service
        owner: root
        group: root
        mode: "0644"
      notify:
        - Reload systemd
        - Restart tearleads-smtp-listener

    - name: Enable tearleads-smtp-listener service
      ansible.builtin.systemd:
        name: tearleads-smtp-listener
        enabled: true
        daemon_reload: true

    - name: Create web root directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ ansible_user }}"
        group: www-data
        mode: "0775"
        recurse: true
      loop: "{{ web_root_directories | map('regex_replace', '^', '/var/www/') | list }}"

    - name: Deploy nginx vhosts
      ansible.builtin.template:
        src: nginx-vhost.conf.j2
        dest: "/etc/nginx/sites-available/{{ item }}.conf"
        owner: root
        group: root
        mode: "0644"
      loop: "{{ sites }}"
      notify: Reload nginx

    - name: Enable nginx vhosts
      ansible.builtin.file:
        src: "/etc/nginx/sites-available/{{ item }}.conf"
        dest: "/etc/nginx/sites-enabled/{{ item }}.conf"
        state: link
      loop: "{{ sites }}"
      notify: Reload nginx

    - name: Remove default nginx site
      ansible.builtin.file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: Reload nginx

    # Certbot nginx configs (API reverse proxy, email/download subdomains for SSL)
    - name: Deploy certbot nginx configs
      ansible.builtin.template:
        src: "nginx-{{ item }}.conf.j2"
        dest: "/etc/nginx/sites-available/{{ item }}.conf"
        owner: root
        group: root
        mode: "0644"
      loop:
        - api
        - download
        - email
      notify: Reload nginx

    - name: Enable certbot nginx configs
      ansible.builtin.file:
        src: "/etc/nginx/sites-available/{{ item }}.conf"
        dest: "/etc/nginx/sites-enabled/{{ item }}.conf"
        state: link
      loop:
        - api
        - download
        - email
      notify: Reload nginx

    - name: Ensure nginx is running and enabled
      ansible.builtin.systemd:
        name: nginx
        state: started
        enabled: true

    - name: Flush handlers to ensure nginx config is active
      ansible.builtin.meta: flush_handlers

    # COMPLIANCE_SENTINEL: TL-VENDOR-004 | control=letsencrypt-vendor
    - name: Obtain SSL certificates with certbot
      ansible.builtin.command:
        cmd: >
          certbot --nginx
          --non-interactive
          --agree-tos
          --expand
          --email {{ certbot_email }}
          --domains {{ domain }},{{ subdomains | map('regex_replace', '$', '.' ~ domain) | join(',') }}
      register: certbot_result
      changed_when: "'Certificate not yet due for renewal' not in certbot_result.stdout"

    # Utility scripts
    - name: Deploy deliverMail script
      ansible.builtin.template:
        src: scripts/deliverMail.sh.j2
        dest: /usr/local/bin/deliverMail.sh
        owner: root
        group: root
        mode: "0755"

    - name: Deploy utility scripts
      ansible.builtin.copy:
        src: "files/scripts/{{ item }}.sh"
        dest: "/usr/local/bin/{{ item }}.sh"
        owner: root
        group: root
        mode: "0755"
      loop:
        - apiCli
        - tailApi
        - tailSmtpListener

    # Automatic daily patching
    - name: Deploy auto-patch script
      ansible.builtin.template:
        src: auto-patch.sh.j2
        dest: /usr/local/sbin/auto-patch.sh
        owner: root
        group: root
        mode: "0755"

    - name: Deploy auto-patch systemd service
      ansible.builtin.template:
        src: auto-patch.service.j2
        dest: /etc/systemd/system/auto-patch.service
        owner: root
        group: root
        mode: "0644"

    - name: Deploy auto-patch systemd timer
      ansible.builtin.template:
        src: auto-patch.timer.j2
        dest: /etc/systemd/system/auto-patch.timer
        owner: root
        group: root
        mode: "0644"

    - name: Enable and start auto-patch timer
      ansible.builtin.systemd:
        name: auto-patch.timer
        enabled: true
        state: started
        daemon_reload: true

    # Daily sync of lastActiveAt from Redis to PostgreSQL
    - name: Deploy sync-last-active systemd service
      ansible.builtin.template:
        src: sync-last-active.service.j2
        dest: /etc/systemd/system/sync-last-active.service
        owner: root
        group: root
        mode: "0644"

    - name: Deploy sync-last-active systemd timer
      ansible.builtin.template:
        src: sync-last-active.timer.j2
        dest: /etc/systemd/system/sync-last-active.timer
        owner: root
        group: root
        mode: "0644"

    - name: Enable and start sync-last-active timer
      ansible.builtin.systemd:
        name: sync-last-active.timer
        enabled: true
        state: started
        daemon_reload: true

    # PostgreSQL daily backup
    - name: Create PostgreSQL backup directory
      ansible.builtin.file:
        path: "{{ backup_dir }}"
        state: directory
        owner: postgres
        group: postgres
        mode: "0750"

    - name: Deploy PostgreSQL backup script
      ansible.builtin.template:
        src: scripts/postgres-backup.sh.j2
        dest: /usr/local/sbin/postgres-backup.sh
        owner: root
        group: root
        mode: "0755"

    - name: Deploy PostgreSQL restore script
      ansible.builtin.template:
        src: scripts/postgres-restore.sh.j2
        dest: /usr/local/sbin/postgres-restore.sh
        owner: root
        group: root
        mode: "0755"

    - name: Deploy PostgreSQL list-backups script
      ansible.builtin.template:
        src: scripts/postgres-list-backups.sh.j2
        dest: /usr/local/sbin/postgres-list-backups.sh
        owner: root
        group: root
        mode: "0755"

    - name: Deploy postgres-backup systemd service
      ansible.builtin.template:
        src: postgres-backup.service.j2
        dest: /etc/systemd/system/postgres-backup.service
        owner: root
        group: root
        mode: "0644"

    - name: Deploy postgres-backup systemd timer
      ansible.builtin.template:
        src: postgres-backup.timer.j2
        dest: /etc/systemd/system/postgres-backup.timer
        owner: root
        group: root
        mode: "0644"

    - name: Enable and start postgres-backup timer
      ansible.builtin.systemd:
        name: postgres-backup.timer
        enabled: true
        state: started
        daemon_reload: true

    # Audit Logging Configuration (Compliance)
    - name: Ensure journald conf.d directory exists
      ansible.builtin.file:
        path: /etc/systemd/journald.conf.d
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Deploy journald compliance configuration
      ansible.builtin.template:
        src: journald.conf.j2
        dest: /etc/systemd/journald.conf.d/compliance.conf
        owner: root
        group: root
        mode: "0644"
      notify: Restart systemd-journald

    - name: Deploy nginx logging configuration
      ansible.builtin.template:
        src: nginx-logging.conf.j2
        dest: /etc/nginx/conf.d/logging.conf
        owner: root
        group: root
        mode: "0644"
      notify: Reload nginx

    - name: Deploy nginx logrotate configuration
      ansible.builtin.template:
        src: nginx-logrotate.conf.j2
        dest: /etc/logrotate.d/nginx
        owner: root
        group: root
        mode: "0644"

    - name: Create audit archive directory
      ansible.builtin.file:
        path: "{{ audit_archive_dir }}"
        state: directory
        owner: root
        group: root
        mode: "0750"

    - name: Deploy audit log archive script
      ansible.builtin.template:
        src: scripts/audit-log-archive.sh.j2
        dest: /usr/local/sbin/audit-log-archive.sh
        owner: root
        group: root
        mode: "0755"

    - name: Deploy audit-log-archive systemd service
      ansible.builtin.template:
        src: audit-log-archive.service.j2
        dest: /etc/systemd/system/audit-log-archive.service
        owner: root
        group: root
        mode: "0644"

    - name: Deploy audit-log-archive systemd timer
      ansible.builtin.template:
        src: audit-log-archive.timer.j2
        dest: /etc/systemd/system/audit-log-archive.timer
        owner: root
        group: root
        mode: "0644"

    - name: Enable and start audit-log-archive timer
      ansible.builtin.systemd:
        name: audit-log-archive.timer
        enabled: true
        state: started
        daemon_reload: true

  handlers:
    - name: Reload nginx
      ansible.builtin.systemd:
        name: nginx
        state: reloaded

    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Restart sshd
      ansible.builtin.systemd:
        name: ssh
        state: restarted

    - name: Restart redis
      ansible.builtin.systemd:
        name: redis-server
        state: restarted

    - name: Restart postgresql
      ansible.builtin.systemd:
        name: postgresql
        state: restarted

    - name: Restart systemd-journald
      ansible.builtin.systemd:
        name: systemd-journald
        state: restarted

    - name: Reload sysctl
      ansible.builtin.command:
        cmd: sysctl --system
      changed_when: true

    - name: Restart fail2ban
      ansible.builtin.systemd:
        name: fail2ban
        state: restarted

    - name: Restart tearleads-api
      ansible.builtin.systemd:
        name: tearleads-api
        state: restarted

    - name: Restart tearleads-smtp-listener
      ansible.builtin.systemd:
        name: tearleads-smtp-listener
        state: restarted
