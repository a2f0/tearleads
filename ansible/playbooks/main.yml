---
- name: Configure main server
  hosts: all
  become: true

  vars:
    ansible_python_interpreter: /usr/bin/python3
    domain: "{{ lookup('env', 'TF_VAR_domain') | mandatory('TF_VAR_domain environment variable is required') }}"
    certbot_email: "{{ lookup('env', 'CERTBOT_EMAIL') | mandatory('CERTBOT_EMAIL environment variable is required') }}"
    deploy_public_key: "{{ lookup('pipe', 'ssh-keygen -y -f ' ~ playbook_dir ~ '/../../.secrets/deploy.key') }}"
    nodejs_major_version: 22
    sites:
      - www
      - app
    subdomains:
      - www
      - app
      - api
      - email
    patch_time: "03:00"
    patch_timezone: "UTC"
    postgresql_version: 16

  tasks:
    - name: Add GitHub Actions deploy key to authorized_keys
      ansible.posix.authorized_key:
        user: "{{ lookup('env', 'TF_VAR_server_username') | mandatory('TF_VAR_server_username environment variable is required') }}"
        state: present
        key: "{{ deploy_public_key }}"

    - name: Disable root SSH login
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PermitRootLogin'
        line: 'PermitRootLogin no'
        validate: 'sshd -t -f %s'
      notify: Restart sshd

    - name: Update apt cache and upgrade all packages
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
        upgrade: dist

    - name: Install required packages
      ansible.builtin.apt:
        name:
          - nginx
          - certbot
          - python3-certbot-nginx
          - ca-certificates
          - curl
          - redis-server
          - postgresql
          - postgresql-contrib
          - ncurses-bin
        state: present

    # Ghostty terminal support
    - name: Copy Ghostty terminfo
      ansible.builtin.copy:
        src: files/ghostty.terminfo
        dest: /tmp/ghostty.terminfo
        mode: "0644"
      register: copy_terminfo_result

    - name: Check for existing compiled Ghostty terminfo
      ansible.builtin.stat:
        path: /usr/share/terminfo/g/ghostty
      register: compiled_terminfo_stat

    - name: Compile Ghostty terminfo system-wide
      ansible.builtin.command:
        cmd: tic -x -o /usr/share/terminfo /tmp/ghostty.terminfo
      when: copy_terminfo_result.changed or not compiled_terminfo_stat.stat.exists
      changed_when: true

    - name: Create keyrings directory
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"

    # Node.js installation for API
    - name: Download and dearmor NodeSource GPG key
      ansible.builtin.shell:
        cmd: set -o pipefail && curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg
        executable: /bin/bash
        creates: /etc/apt/keyrings/nodesource.gpg

    - name: Set permissions on NodeSource GPG key
      ansible.builtin.file:
        path: /etc/apt/keyrings/nodesource.gpg
        mode: "0644"

    - name: Add NodeSource repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_{{ nodejs_major_version }}.x nodistro main"
        state: present
        filename: nodesource

    - name: Install Node.js
      ansible.builtin.apt:
        name: nodejs
        state: present
        update_cache: true

    # Redis configuration
    - name: Configure Redis to bind to localhost only
      ansible.builtin.lineinfile:
        path: /etc/redis/redis.conf
        regexp: '^bind '
        line: 'bind 127.0.0.1 ::1'
      notify: Restart redis

    - name: Ensure Redis is running and enabled
      ansible.builtin.systemd:
        name: redis-server
        state: started
        enabled: true

    # PostgreSQL configuration
    - name: Configure PostgreSQL to listen on localhost only
      ansible.builtin.lineinfile:
        path: /etc/postgresql/{{ postgresql_version }}/main/postgresql.conf
        regexp: "^#?listen_addresses\\s*="
        line: "listen_addresses = 'localhost'"
      notify: Restart postgresql

    - name: Ensure PostgreSQL is running and enabled
      ansible.builtin.systemd:
        name: postgresql
        state: started
        enabled: true

    # API directory and service
    - name: Create API directory
      ansible.builtin.file:
        path: /opt/rapid-api
        state: directory
        owner: "{{ lookup('env', 'TF_VAR_server_username') }}"
        group: www-data
        mode: "0775"
        recurse: true

    - name: Create API environment file
      ansible.builtin.copy:
        dest: /opt/rapid-api/.env
        content: "OPENROUTER_API_KEY={{ lookup('env', 'OPENROUTER_API_KEY') | mandatory('OPENROUTER_API_KEY environment variable is required') }}\n"
        owner: "{{ lookup('env', 'TF_VAR_server_username') }}"
        group: www-data
        mode: "0640"
      no_log: true
      notify: Restart rapid-api

    - name: Deploy rapid-api systemd service
      ansible.builtin.template:
        src: rapid-api.service.j2
        dest: /etc/systemd/system/rapid-api.service
        owner: root
        group: root
        mode: "0644"
      notify:
        - Reload systemd
        - Restart rapid-api

    - name: Enable rapid-api service
      ansible.builtin.systemd:
        name: rapid-api
        enabled: true
        daemon_reload: true

    # SMTP Listener directory and service
    - name: Create SMTP Listener directory
      ansible.builtin.file:
        path: /opt/rapid-smtp-listener
        state: directory
        owner: "{{ lookup('env', 'TF_VAR_server_username') }}"
        group: www-data
        mode: "0775"
        recurse: true

    - name: Deploy rapid-smtp-listener systemd service
      ansible.builtin.template:
        src: rapid-smtp-listener.service.j2
        dest: /etc/systemd/system/rapid-smtp-listener.service
        owner: root
        group: root
        mode: "0644"
      notify: Reload systemd

    - name: Enable rapid-smtp-listener service
      ansible.builtin.systemd:
        name: rapid-smtp-listener
        enabled: true
        daemon_reload: true

    - name: Create web root directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ lookup('env', 'TF_VAR_server_username') }}"
        group: www-data
        mode: "0775"
        recurse: true
      loop: "{{ sites | map('regex_replace', '^', '/var/www/') | list }}"

    - name: Deploy nginx vhosts
      ansible.builtin.template:
        src: nginx-vhost.conf.j2
        dest: "/etc/nginx/sites-available/{{ item }}.conf"
        owner: root
        group: root
        mode: "0644"
      loop: "{{ sites }}"
      notify: Reload nginx

    - name: Enable nginx vhosts
      ansible.builtin.file:
        src: "/etc/nginx/sites-available/{{ item }}.conf"
        dest: "/etc/nginx/sites-enabled/{{ item }}.conf"
        state: link
      loop: "{{ sites }}"
      notify: Reload nginx

    - name: Remove default nginx site
      ansible.builtin.file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: Reload nginx

    # Special nginx configs (API reverse proxy, email subdomain for certbot)
    - name: Deploy special nginx configs
      ansible.builtin.template:
        src: "nginx-{{ item }}.conf.j2"
        dest: "/etc/nginx/sites-available/{{ item }}.conf"
        owner: root
        group: root
        mode: "0644"
      loop:
        - api
        - email
      notify: Reload nginx

    - name: Enable special nginx configs
      ansible.builtin.file:
        src: "/etc/nginx/sites-available/{{ item }}.conf"
        dest: "/etc/nginx/sites-enabled/{{ item }}.conf"
        state: link
      loop:
        - api
        - email
      notify: Reload nginx

    - name: Ensure nginx is running and enabled
      ansible.builtin.systemd:
        name: nginx
        state: started
        enabled: true

    - name: Flush handlers to ensure nginx config is active
      ansible.builtin.meta: flush_handlers

    - name: Obtain SSL certificates with certbot
      ansible.builtin.command:
        cmd: >
          certbot --nginx
          --non-interactive
          --agree-tos
          --expand
          --email {{ certbot_email }}
          --domains {{ domain }},{{ subdomains | map('regex_replace', '$', '.' ~ domain) | join(',') }}
      register: certbot_result
      changed_when: "'Certificate not yet due for renewal' not in certbot_result.stdout"

    # Utility scripts
    - name: Deploy deliverMail script
      ansible.builtin.template:
        src: scripts/deliverMail.sh.j2
        dest: /usr/local/bin/deliverMail.sh
        owner: root
        group: root
        mode: "0755"

    # Automatic daily patching
    - name: Deploy auto-patch script
      ansible.builtin.template:
        src: auto-patch.sh.j2
        dest: /usr/local/sbin/auto-patch.sh
        owner: root
        group: root
        mode: "0755"

    - name: Deploy auto-patch systemd service
      ansible.builtin.template:
        src: auto-patch.service.j2
        dest: /etc/systemd/system/auto-patch.service
        owner: root
        group: root
        mode: "0644"

    - name: Deploy auto-patch systemd timer
      ansible.builtin.template:
        src: auto-patch.timer.j2
        dest: /etc/systemd/system/auto-patch.timer
        owner: root
        group: root
        mode: "0644"

    - name: Enable and start auto-patch timer
      ansible.builtin.systemd:
        name: auto-patch.timer
        enabled: true
        state: started
        daemon_reload: true

  handlers:
    - name: Reload nginx
      ansible.builtin.systemd:
        name: nginx
        state: reloaded

    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Restart sshd
      ansible.builtin.systemd:
        name: ssh
        state: restarted

    - name: Restart redis
      ansible.builtin.systemd:
        name: redis-server
        state: restarted

    - name: Restart postgresql
      ansible.builtin.systemd:
        name: postgresql
        state: restarted

    - name: Restart rapid-api
      ansible.builtin.systemd:
        name: rapid-api
        state: restarted
