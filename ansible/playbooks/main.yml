---
- name: Configure main server
  hosts: all
  become: true

  vars:
    ansible_python_interpreter: /usr/bin/python3
    domain: "{{ lookup('env', 'TF_VAR_domain') | mandatory('TF_VAR_domain environment variable is required') }}"
    certbot_email: "{{ lookup('env', 'CERTBOT_EMAIL') | mandatory('CERTBOT_EMAIL environment variable is required') }}"
    deploy_public_key: "{{ lookup('pipe', 'ssh-keygen -y -f ' ~ playbook_dir ~ '/../../.secrets/deploy.key') }}"
    nodejs_major_version: 22
    sites:
      - www
      - app
    subdomains:
      - www
      - app
      - api
    patch_time: "03:00"
    patch_timezone: "UTC"

  tasks:
    - name: Add GitHub Actions deploy key to authorized_keys
      ansible.posix.authorized_key:
        user: "{{ lookup('env', 'TF_VAR_server_username') | mandatory('TF_VAR_server_username environment variable is required') }}"
        state: present
        key: "{{ deploy_public_key }}"

    - name: Disable root SSH login
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PermitRootLogin'
        line: 'PermitRootLogin no'
        validate: 'sshd -t -f %s'
      notify: Restart sshd

    - name: Update apt cache and upgrade all packages
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
        upgrade: dist

    - name: Install required packages
      ansible.builtin.apt:
        name:
          - nginx
          - certbot
          - python3-certbot-nginx
          - ca-certificates
          - curl
          - redis-server
        state: present

    - name: Create keyrings directory
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"

    # Node.js installation for API
    - name: Download and dearmor NodeSource GPG key
      ansible.builtin.shell:
        cmd: set -o pipefail && curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg
        executable: /bin/bash
        creates: /etc/apt/keyrings/nodesource.gpg

    - name: Set permissions on NodeSource GPG key
      ansible.builtin.file:
        path: /etc/apt/keyrings/nodesource.gpg
        mode: "0644"

    - name: Add NodeSource repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_{{ nodejs_major_version }}.x nodistro main"
        state: present
        filename: nodesource

    - name: Install Node.js
      ansible.builtin.apt:
        name: nodejs
        state: present
        update_cache: true

    # Redis configuration
    - name: Configure Redis to bind to localhost only
      ansible.builtin.lineinfile:
        path: /etc/redis/redis.conf
        regexp: '^bind '
        line: 'bind 127.0.0.1 ::1'
      notify: Restart redis

    - name: Ensure Redis is running and enabled
      ansible.builtin.systemd:
        name: redis-server
        state: started
        enabled: true

    # API directory and service
    - name: Create API directory
      ansible.builtin.file:
        path: /opt/rapid-api
        state: directory
        owner: "{{ lookup('env', 'TF_VAR_server_username') }}"
        group: www-data
        mode: "0775"
        recurse: true

    - name: Deploy rapid-api systemd service
      ansible.builtin.template:
        src: rapid-api.service.j2
        dest: /etc/systemd/system/rapid-api.service
        owner: root
        group: root
        mode: "0644"
      notify: Reload systemd

    - name: Enable rapid-api service
      ansible.builtin.systemd:
        name: rapid-api
        enabled: true
        daemon_reload: true

    - name: Create web root directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ lookup('env', 'TF_VAR_server_username') }}"
        group: www-data
        mode: "0775"
        recurse: true
      loop: "{{ sites | map('regex_replace', '^', '/var/www/') | list }}"

    - name: Deploy nginx vhosts
      ansible.builtin.template:
        src: nginx-vhost.conf.j2
        dest: "/etc/nginx/sites-available/{{ item }}.conf"
        owner: root
        group: root
        mode: "0644"
      loop: "{{ sites }}"
      notify: Reload nginx

    - name: Enable nginx vhosts
      ansible.builtin.file:
        src: "/etc/nginx/sites-available/{{ item }}.conf"
        dest: "/etc/nginx/sites-enabled/{{ item }}.conf"
        state: link
      loop: "{{ sites }}"
      notify: Reload nginx

    - name: Remove default nginx site
      ansible.builtin.file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: Reload nginx

    # API nginx configuration
    - name: Deploy nginx API reverse proxy config
      ansible.builtin.template:
        src: nginx-api.conf.j2
        dest: /etc/nginx/sites-available/api.conf
        owner: root
        group: root
        mode: "0644"
      notify: Reload nginx

    - name: Enable nginx API config
      ansible.builtin.file:
        src: /etc/nginx/sites-available/api.conf
        dest: /etc/nginx/sites-enabled/api.conf
        state: link
      notify: Reload nginx

    - name: Ensure nginx is running and enabled
      ansible.builtin.systemd:
        name: nginx
        state: started
        enabled: true

    - name: Flush handlers to ensure nginx config is active
      ansible.builtin.meta: flush_handlers

    - name: Obtain SSL certificates with certbot
      ansible.builtin.command:
        cmd: >
          certbot --nginx
          --non-interactive
          --agree-tos
          --expand
          --email {{ certbot_email }}
          --domains {{ domain }},{{ subdomains | map('regex_replace', '$', '.' ~ domain) | join(',') }}
      register: certbot_result
      changed_when: "'Certificate not yet due for renewal' not in certbot_result.stdout"

    # Automatic daily patching
    - name: Deploy auto-patch script
      ansible.builtin.template:
        src: auto-patch.sh.j2
        dest: /usr/local/sbin/auto-patch.sh
        owner: root
        group: root
        mode: "0755"

    - name: Deploy auto-patch systemd service
      ansible.builtin.template:
        src: auto-patch.service.j2
        dest: /etc/systemd/system/auto-patch.service
        owner: root
        group: root
        mode: "0644"

    - name: Deploy auto-patch systemd timer
      ansible.builtin.template:
        src: auto-patch.timer.j2
        dest: /etc/systemd/system/auto-patch.timer
        owner: root
        group: root
        mode: "0644"

    - name: Enable and start auto-patch timer
      ansible.builtin.systemd:
        name: auto-patch.timer
        enabled: true
        state: started
        daemon_reload: true

  handlers:
    - name: Reload nginx
      ansible.builtin.systemd:
        name: nginx
        state: reloaded

    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Restart sshd
      ansible.builtin.systemd:
        name: ssh
        state: restarted

    - name: Restart redis
      ansible.builtin.systemd:
        name: redis-server
        state: restarted
