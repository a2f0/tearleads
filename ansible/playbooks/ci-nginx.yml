---
- name: Configure NGINX for CI
  hosts: localhost
  become: true
  vars:
    nginx_ci_site: "{{ nginx_ci_site | default('client') }}"
    workspace_root: "{{ lookup('ansible.builtin.env', 'GITHUB_WORKSPACE') | default(playbook_dir + '/../..', true) }}"
    client_root: "{{ workspace_root }}/packages/client/dist"
    website_root: "{{ workspace_root }}/packages/website/dist"
    sqlite_assets_root: "{{ workspace_root }}/packages/client/public/assets"
    nginx_port_map:
      api: 8443
      client: 8443
      website: 8444
  tasks:
    - name: Ensure NGINX is installed
      ansible.builtin.apt:
        name: nginx
        state: present
        update_cache: true

    - name: Remove default NGINX site
      ansible.builtin.file:
        path: /etc/nginx/sites-enabled/default
        state: absent

    - name: Render CI NGINX site config
      ansible.builtin.copy:
        dest: /etc/nginx/sites-available/ci-site.conf
        mode: "0644"
        content: |
          server {
            listen {{ nginx_port_map[nginx_ci_site] }} ssl;
            server_name localhost;

            ssl_certificate /etc/ssl/certs/localhost.crt;
            ssl_certificate_key /etc/ssl/private/localhost.key;

            {% if nginx_ci_site == 'api' %}
            location / {
              proxy_pass http://127.0.0.1:5001;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
            }
            {% elif nginx_ci_site == 'client' %}
            root {{ client_root }};
            index index.html;
            default_type application/octet-stream;
            types {
              application/javascript js mjs;
              application/wasm wasm;
              text/css css;
              text/html html;
              application/json json;
              image/svg+xml svg;
            }

            location /v1/ {
              proxy_pass http://127.0.0.1:5001/v1/;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
            }

            location = /sqlite {
              try_files /index.html =404;
            }

            location /sqlite/ {
              alias {{ sqlite_assets_root }}/;
              try_files $uri =404;
            }

            location /assets/ {
              try_files $uri =404;
            }

            location / {
              try_files $uri $uri/ /index.html;
            }
            {% else %}
            root {{ website_root }};
            index index.html;

            location / {
              try_files $uri $uri/ /index.html;
            }
            {% endif %}
          }

    - name: Enable CI NGINX site
      ansible.builtin.file:
        src: /etc/nginx/sites-available/ci-site.conf
        dest: /etc/nginx/sites-enabled/ci-site.conf
        state: link

    - name: Validate NGINX configuration
      ansible.builtin.command: nginx -t
      changed_when: false

    - name: Ensure NGINX is running
      ansible.builtin.service:
        name: nginx
        state: restarted
        enabled: true
