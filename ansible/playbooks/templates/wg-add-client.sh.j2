#!/usr/bin/env bash
set -euo pipefail

CLIENT_NAME="${1:-}"
if [ -z "$CLIENT_NAME" ]; then
  echo "Usage: wg-add-client <client-name>"
  exit 1
fi

CLIENT_DIR="/etc/wireguard/clients/$CLIENT_NAME"
mkdir -p "$CLIENT_DIR"

wg genkey | tee "$CLIENT_DIR/private.key" | wg pubkey > "$CLIENT_DIR/public.key"
chmod 600 "$CLIENT_DIR/private.key"

LAST_IP=$(grep -oP 'AllowedIPs = {{ wireguard_client_subnet_prefix | regex_replace("\\.", "\\\\.") }}\\.\\K[0-9]+' {{ wireguard_config_path }} | sort -n | tail -1 || true)
if [ -n "$LAST_IP" ]; then
  NEXT_IP=$((LAST_IP + 1))
else
  NEXT_IP=2
fi

cat >> {{ wireguard_config_path }} <<EOF

[Peer]
# $CLIENT_NAME
PublicKey = $(cat "$CLIENT_DIR/public.key")
AllowedIPs = {{ wireguard_client_subnet_prefix }}.$NEXT_IP/32
EOF

SERVER_PUBLIC=$(cat /etc/wireguard/server_public.key)
SERVER_IP=$(curl -fsSL {{ wireguard_endpoint_discovery_url }})

cat > "$CLIENT_DIR/$CLIENT_NAME.conf" <<EOF
[Interface]
PrivateKey = $(cat "$CLIENT_DIR/private.key")
Address = {{ wireguard_client_subnet_prefix }}.$NEXT_IP/24
DNS = {{ wireguard_dns_servers }}

[Peer]
PublicKey = $SERVER_PUBLIC
Endpoint = $SERVER_IP:{{ wireguard_port }}
AllowedIPs = {{ wireguard_client_allowed_ips }}
PersistentKeepalive = 25
EOF

wg syncconf {{ wireguard_interface }} <(wg-quick strip {{ wireguard_interface }})
echo "Client config: $CLIENT_DIR/$CLIENT_NAME.conf"
qrencode -t ansiutf8 < "$CLIENT_DIR/$CLIENT_NAME.conf"
