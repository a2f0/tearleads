#!/bin/bash
set -e

# PostgreSQL Backup Script
# Runs daily via systemd timer to create compressed pg_dump backups
# Logs are handled by systemd/journald: journalctl -u postgres-backup.service

BACKUP_DIR="{{ backup_dir }}"
RETENTION_DAYS="{{ backup_retention_days }}"
TIMESTAMP=$(date +%Y-%m-%dT%H-%M-%S)
BACKUP_FILE="${BACKUP_DIR}/tearleads-${TIMESTAMP}-Fc"

log() {
    echo "$1"
}

log "Starting PostgreSQL backup"

# Ensure backup directory exists
mkdir -p "${BACKUP_DIR}"

log "Creating backup: ${BACKUP_FILE}"

# Run pg_dump as postgres user with custom format (compressed)
sudo -u postgres pg_dump \
    --clean \
    --no-owner \
    -Fc \
    "{{ lookup('env', 'POSTGRES_DATABASE') }}" \
    > "${BACKUP_FILE}"

log "Backup created successfully: $(du -h "${BACKUP_FILE}" | cut -f1)"

# Clean up old backups
log "Removing backups older than ${RETENTION_DAYS} days"
find "${BACKUP_DIR}" -name "tearleads-*-Fc" -type f -mtime +${RETENTION_DAYS} -delete

# List current backups
log "Current backups:"
ls -lh "${BACKUP_DIR}"/tearleads-*-Fc 2>/dev/null || log "No backups found"

log "PostgreSQL backup complete"
