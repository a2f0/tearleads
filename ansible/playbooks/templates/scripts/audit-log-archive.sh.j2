#!/bin/bash
{# COMPLIANCE_SENTINEL: TL-AUDT-004 | policy=compliance/SOC2/policies/02-audit-logging-policy.md | procedure=compliance/SOC2/procedures/02-audit-logging-procedure.md | control=audit-log-archive #}
{# COMPLIANCE_SENTINEL: TL-NAUDT-004 | policy=compliance/NIST.SP.800-53/policies/02-audit-logging-policy.md | procedure=compliance/NIST.SP.800-53/procedures/02-audit-logging-procedure.md | control=audit-log-archive #}
{# COMPLIANCE_SENTINEL: TL-HAUDT-004 | policy=compliance/HIPAA/policies/02-audit-logging-policy.md | procedure=compliance/HIPAA/procedures/02-audit-logging-procedure.md | control=audit-log-archive #}
set -e

# Audit Log Archive Script
# Archives logs beyond operational retention for long-term compliance (HIPAA: 6 years)
# Logs are handled by systemd/journald: journalctl -u audit-log-archive.service

ARCHIVE_DIR="{{ audit_archive_dir }}"
NGINX_LOG_DIR="/var/log/nginx"
RETENTION_DAYS="{{ audit_log_retention_days }}"
ARCHIVE_RETENTION_YEARS="{{ audit_archive_retention_years }}"
TIMESTAMP=$(date +%Y-%m-%dT%H-%M-%S)

log() {
    echo "$1"
}

log "Starting audit log archive"

# Ensure archive directory exists with appropriate permissions
mkdir -p "${ARCHIVE_DIR}"
chmod 750 "${ARCHIVE_DIR}"

# Archive rotated nginx logs older than operational retention
NGINX_ARCHIVE="${ARCHIVE_DIR}/nginx-logs-${TIMESTAMP}.tar.gz"
log "Archiving nginx logs older than ${RETENTION_DAYS} days"
NGINX_FILES=$(find "${NGINX_LOG_DIR}" -name "*.gz" -mtime +${RETENTION_DAYS} 2>/dev/null || true)
if [ -n "${NGINX_FILES}" ]; then
    echo "${NGINX_FILES}" | tar -czvf "${NGINX_ARCHIVE}" -T - 2>/dev/null || true
    log "Created nginx archive: ${NGINX_ARCHIVE}"
    # Remove archived files
    echo "${NGINX_FILES}" | xargs rm -f
else
    log "No nginx logs to archive"
fi

# Export journald logs older than operational retention
JOURNAL_ARCHIVE="${ARCHIVE_DIR}/journald-${TIMESTAMP}.export.gz"
SINCE_DATE=$(date -d "-${RETENTION_DAYS} days" +%Y-%m-%d 2>/dev/null || date -v-${RETENTION_DAYS}d +%Y-%m-%d)
UNTIL_DATE=$(date -d "-$((RETENTION_DAYS - 1)) days" +%Y-%m-%d 2>/dev/null || date -v-$((RETENTION_DAYS - 1))d +%Y-%m-%d)
log "Exporting journald entries from ${SINCE_DATE} to ${UNTIL_DATE}"
journalctl --since "${SINCE_DATE}" --until "${UNTIL_DATE}" -o export 2>/dev/null | gzip > "${JOURNAL_ARCHIVE}" || true
if [ -s "${JOURNAL_ARCHIVE}" ]; then
    log "Created journald archive: ${JOURNAL_ARCHIVE}"
else
    rm -f "${JOURNAL_ARCHIVE}"
    log "No journald entries to archive"
fi

# Clean up archives older than long-term retention period
ARCHIVE_RETENTION_DAYS=$((ARCHIVE_RETENTION_YEARS * 365))
log "Removing archives older than ${ARCHIVE_RETENTION_YEARS} years (${ARCHIVE_RETENTION_DAYS} days)"
find "${ARCHIVE_DIR}" -type f -mtime +${ARCHIVE_RETENTION_DAYS} -delete

# List current archives
log "Current archives:"
ls -lh "${ARCHIVE_DIR}"/ 2>/dev/null || log "No archives found"

log "Audit log archive complete"
