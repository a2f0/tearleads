#!/bin/bash
set -e

# PostgreSQL Restore Script
# Usage: postgres-restore.sh <backup-file>
# Example: postgres-restore.sh /var/backups/postgres/tearleads-2024-01-15T03-00-00-Fc

BACKUP_DIR="{{ backup_dir }}"
DATABASE="{{ lookup('env', 'POSTGRES_DATABASE') }}"

if [ -z "$1" ]; then
    echo "Usage: postgres-restore.sh <backup-file>"
    echo "Example: postgres-restore.sh ${BACKUP_DIR}/tearleads-2024-01-15T03-00-00-Fc"
    echo ""
    echo "Available backups:"
    ls -lh "${BACKUP_DIR}"/tearleads-*-Fc 2>/dev/null || echo "No backups found"
    exit 1
fi

BACKUP_FILE="$1"

if [ ! -f "${BACKUP_FILE}" ]; then
    echo "Error: Backup file not found: ${BACKUP_FILE}"
    exit 1
fi

echo "=== PostgreSQL Restore ==="
echo "Backup file: ${BACKUP_FILE}"
echo "Target database: ${DATABASE}"
echo ""
echo "WARNING: This will DROP and recreate the database!"
read -p "Are you sure you want to continue? (yes/no): " CONFIRM

if [ "${CONFIRM}" != "yes" ]; then
    echo "Restore cancelled."
    exit 0
fi

echo ""
echo "Stopping tearleads-api service..."
systemctl stop tearleads-api || true

echo "Refreshing collation version..."
sudo -u postgres psql -c "ALTER DATABASE postgres REFRESH COLLATION VERSION;" 2>/dev/null || true
sudo -u postgres psql -c "ALTER DATABASE template1 REFRESH COLLATION VERSION;" 2>/dev/null || true

echo "Dropping database: ${DATABASE}"
sudo -u postgres dropdb --if-exists "${DATABASE}"

echo "Creating database: ${DATABASE}"
sudo -u postgres createdb "${DATABASE}"

echo "Restoring backup..."
sudo -u postgres pg_restore \
    --no-owner \
    -d "${DATABASE}" \
    "${BACKUP_FILE}"

echo "Starting tearleads-api service..."
systemctl start tearleads-api

echo ""
echo "=== Restore complete ==="
