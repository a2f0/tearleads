#!/bin/bash
set -e

LOGFILE="{{ auto_patch_logfile | default('/var/log/auto-patch.log') }}"

# Redirect stdout and stderr to the log file and the original stdout
exec > >(tee -a "$LOGFILE")
exec 2>&1

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1"
}

log "Starting automatic patching"

# Wait for any other package manager to finish
while fuser /var/lib/dpkg/lock >/dev/null 2>&1 || fuser /var/lib/apt/lists/lock >/dev/null 2>&1 || fuser /var/cache/apt/archives/lock >/dev/null 2>&1; do
    log "Waiting for other package manager to finish..."
    sleep 30
done

log "Updating package lists"
apt-get update

log "Upgrading packages"
DEBIAN_FRONTEND=noninteractive apt-get dist-upgrade -y \
    -o Dpkg::Options::="--force-confdef" \
    -o Dpkg::Options::="--force-confold"

log "Removing unused packages"
apt-get autoremove -y

log "Cleaning package cache"
apt-get autoclean

if [ -f /var/run/reboot-required ]; then
    log "Reboot required - scheduling reboot in 1 minute"
    shutdown -r +1 "System rebooting after automatic patching"
else
    log "No reboot required"
fi

log "Patching complete"
