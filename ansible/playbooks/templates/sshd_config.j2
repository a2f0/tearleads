# COMPLIANCE_SENTINEL: TL-INFRA-004 | control=ssh-hardening
# SSH Server Hardening Configuration
# Framework mappings:
# - SOC2: CC6.1, CC6.6 (Logical Access Security)
# - NIST SP 800-53: AC-17, IA-2, IA-5 (Remote Access, Identification and Authentication)
# - HIPAA: 164.312(d) (Person or Entity Authentication)

# Protocol and listening
Port 22
AddressFamily any
Protocol 2

# Authentication hardening
PermitRootLogin no
PubkeyAuthentication yes
PasswordAuthentication no
PermitEmptyPasswords no
ChallengeResponseAuthentication no
KbdInteractiveAuthentication no
UsePAM yes

# Limit authentication attempts (brute-force mitigation)
MaxAuthTries 3
MaxSessions 10
LoginGraceTime 60

# Session security
ClientAliveInterval 300
ClientAliveCountMax 2

# Disable unused features
X11Forwarding no
AllowTcpForwarding no
AllowAgentForwarding no
PermitTunnel no
GatewayPorts no
PermitUserEnvironment no

# Use privilege separation
UsePrivilegeSeparation sandbox

# Restrict users (optional - can be enabled with allowed_ssh_users variable)
{% if allowed_ssh_users is defined %}
AllowUsers {{ allowed_ssh_users | join(' ') }}
{% endif %}

# Logging
SyslogFacility AUTH
LogLevel VERBOSE

# Cryptographic settings (modern, secure algorithms only)
# Based on Mozilla Modern SSH guidelines
KexAlgorithms curve25519-sha256,curve25519-sha256@libssh.org,diffie-hellman-group16-sha512,diffie-hellman-group18-sha512
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com
MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com

# Host keys (prefer ed25519 and RSA)
HostKey /etc/ssh/ssh_host_ed25519_key
HostKey /etc/ssh/ssh_host_rsa_key

# Authorized keys location
AuthorizedKeysFile .ssh/authorized_keys

# SFTP subsystem (required for ansible file transfers)
Subsystem sftp /usr/lib/openssh/sftp-server

# Banner (optional - can be enabled with ssh_banner_file variable)
{% if ssh_banner_file is defined %}
Banner {{ ssh_banner_file }}
{% endif %}
