# COMPLIANCE_SENTINEL: TL-KERN-001 | control=kernel-hardening
# Kernel Security Hardening Configuration
# Framework mappings:
# - SOC2: CC6.1 (Logical Access Security)
# - NIST SP 800-53: SC-5, SI-16 (Denial of Service Protection, Memory Protection)
# - HIPAA: 164.312(e)(1) (Transmission Security)

# =============================================================================
# Network Security
# =============================================================================

# Enable reverse path filtering (prevent IP spoofing)
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1

# Disable IP forwarding (not a router)
net.ipv4.ip_forward = 0
net.ipv6.conf.all.forwarding = 0

# Disable ICMP redirects (prevent MITM attacks)
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv6.conf.all.accept_redirects = 0
net.ipv6.conf.default.accept_redirects = 0
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0
net.ipv4.conf.all.secure_redirects = 0
net.ipv4.conf.default.secure_redirects = 0

# Ignore ICMP broadcast requests (Smurf attack mitigation)
net.ipv4.icmp_echo_ignore_broadcasts = 1

# Ignore bogus ICMP errors
net.ipv4.icmp_ignore_bogus_error_responses = 1

# Log martian packets (packets with impossible addresses)
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1

# Disable source routing (prevent routing manipulation)
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv6.conf.all.accept_source_route = 0
net.ipv6.conf.default.accept_source_route = 0

# Enable TCP SYN cookies (SYN flood protection)
net.ipv4.tcp_syncookies = 1

# Reduce TCP TIME-WAIT sockets (resource exhaustion protection)
net.ipv4.tcp_max_tw_buckets = 1440000

# Disable IPv6 router advertisements if not needed
net.ipv6.conf.all.accept_ra = 0
net.ipv6.conf.default.accept_ra = 0

# =============================================================================
# Kernel Hardening
# =============================================================================

# Restrict kernel pointer exposure (address leak protection)
kernel.kptr_restrict = 2

# Restrict dmesg access to privileged users
kernel.dmesg_restrict = 1

# Restrict ptrace access (anti-debugging/anti-exploitation)
kernel.yama.ptrace_scope = 2

# Restrict sysrq key functions
kernel.sysrq = 0

# Enable address space layout randomization (ASLR)
kernel.randomize_va_space = 2

# Disable core dumps for setuid programs
fs.suid_dumpable = 0

# Restrict loading TTY line disciplines
dev.tty.ldisc_autoload = 0

# Restrict BPF JIT compiler (mitigate JIT spray attacks)
net.core.bpf_jit_harden = 2

# Restrict unprivileged BPF
kernel.unprivileged_bpf_disabled = 1

# Restrict userfaultfd (mitigate use-after-free exploits)
vm.unprivileged_userfaultfd = 0

# Restrict kernel profiling
kernel.perf_event_paranoid = 3

# =============================================================================
# File System Hardening
# =============================================================================

# Restrict symlink following (prevent symlink attacks)
fs.protected_symlinks = 1

# Restrict hardlink creation (prevent hardlink attacks)
fs.protected_hardlinks = 1

# Restrict FIFO special files (prevent data-spoofing attacks)
fs.protected_fifos = 2

# Restrict regular files (prevent data-spoofing attacks)
fs.protected_regular = 2
