---
# AI tools and language runtimes: mise, Node.js, uv, Claude Code, Codex, Gemini
# Expects facts from devToolchain.yml:
#   toolchain_is_linux, toolchain_is_darwin, toolchain_is_local,
#   toolchain_target_user, toolchain_user_home, toolchain_user_group
# Expects variables:
#   nodejs_major_version, claude_install_sha256

- name: Create keyrings directory
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: "0755"
  become: true
  when: toolchain_is_linux

- name: Download mise installer on Linux
  ansible.builtin.get_url:
    url: https://mise.run
    dest: /tmp/mise-install.sh
    mode: "0755"
  when: toolchain_is_linux and not (toolchain_user_home + '/.local/bin/mise') is file

- name: Run mise installer on Linux
  ansible.builtin.command:
    cmd: /tmp/mise-install.sh
    creates: "{{ toolchain_user_home }}/.local/bin/mise"
  become: "{{ not toolchain_is_local }}"
  become_user: "{{ toolchain_target_user }}"
  when: toolchain_is_linux

- name: Install mise via Homebrew on macOS
  ansible.builtin.command:
    cmd: brew install mise
  become: false
  register: brew_mise_result
  changed_when: "'already installed' not in brew_mise_result.stdout"
  when: toolchain_is_darwin

- name: Trust repo mise.toml
  ansible.builtin.command:
    cmd: mise trust "{{ playbook_dir }}/../../mise.toml"
  environment:
    PATH: "{{ toolchain_user_home }}/.local/bin:{{ ansible_env.PATH }}"
  become: "{{ not toolchain_is_local }}"
  become_user: "{{ toolchain_target_user }}"
  changed_when: true

- name: Install Node.js via mise
  ansible.builtin.shell:
    cmd: PATH="{{ toolchain_user_home }}/.local/bin:$PATH" mise use --global node@{{ nodejs_major_version }}
    executable: /bin/bash
  become: "{{ not toolchain_is_local }}"
  become_user: "{{ toolchain_target_user }}"
  register: mise_node_result
  changed_when: "'installed' in mise_node_result.stderr"

# uv (Python package manager) -- required by scripts/setupSerenaMcp.sh
- name: Check if uv is installed
  ansible.builtin.stat:
    path: "{{ toolchain_user_home }}/.local/bin/uv"
  register: uv_stat

- name: Install uv
  ansible.builtin.shell:
    cmd: set -o pipefail && curl -LsSf https://astral.sh/uv/install.sh | sh
    executable: /bin/bash
  become: "{{ not toolchain_is_local }}"
  become_user: "{{ toolchain_target_user }}"
  become_flags: "-H"
  environment:
    HOME: "{{ toolchain_user_home }}"
  when: not uv_stat.stat.exists
  changed_when: true

- name: Check if Claude Code is installed
  ansible.builtin.stat:
    path: "{{ toolchain_user_home }}/.claude/local/claude"
  register: claude_code_stat

- name: Ensure user cache directory exists
  ansible.builtin.file:
    path: "{{ toolchain_user_home }}/.cache"
    state: directory
    mode: "0755"
    owner: "{{ toolchain_target_user }}"
    group: "{{ toolchain_user_group }}"
  become: "{{ not toolchain_is_local }}"
  become_user: "{{ toolchain_target_user }}"
  become_flags: "-H"

# SECURITY NOTE: The Claude Code installer script is dynamically maintained by Anthropic.
# We still pin a known SHA-256 checksum (`claude_install_sha256`) for supply-chain integrity.
# When updating Claude Code installer behavior, refresh this checksum intentionally.
- name: Download Claude Code installer script
  ansible.builtin.get_url:
    url: https://claude.ai/install.sh
    dest: "{{ toolchain_user_home }}/.cache/claude-install.sh"
    mode: "0755"
    checksum: "sha256:{{ claude_install_sha256 }}"
  become: "{{ not toolchain_is_local }}"
  become_user: "{{ toolchain_target_user }}"
  become_flags: "-H"
  when: not claude_code_stat.stat.exists

- name: Install Claude Code CLI via native installer
  ansible.builtin.command:
    cmd: "{{ toolchain_user_home }}/.cache/claude-install.sh"
  become: "{{ not toolchain_is_local }}"
  become_user: "{{ toolchain_target_user }}"
  become_flags: "-H"
  environment:
    HOME: "{{ toolchain_user_home }}"
    USER: "{{ toolchain_target_user }}"
  when: not claude_code_stat.stat.exists
  changed_when: true

- name: Install AI CLIs if missing
  when: toolchain_is_linux or toolchain_is_darwin
  block:
    - name: Check if OpenAI Codex CLI is installed
      ansible.builtin.command:
        cmd: codex --version
      register: codex_cli_check
      changed_when: false
      failed_when: false
      become: false

    - name: Install OpenAI Codex CLI
      community.general.npm:
        name: "@openai/codex"
        global: true
        state: present
      become: false
      when: codex_cli_check.rc != 0

    - name: Check if Google Gemini CLI is installed
      ansible.builtin.command:
        cmd: gemini --version
      register: gemini_cli_check
      changed_when: false
      failed_when: false
      become: false

    - name: Install Google Gemini CLI
      community.general.npm:
        name: "@google/gemini-cli"
        global: true
        state: present
      become: false
      when: gemini_cli_check.rc != 0
