---
- name: Configure example server
  hosts: all
  become: true

  vars:
    domain: "{{ lookup('env', 'TF_VAR_domain') | mandatory('TF_VAR_domain environment variable is required') }}"
    certbot_email: "{{ lookup('env', 'CERTBOT_EMAIL') | mandatory('CERTBOT_EMAIL environment variable is required') }}"
    nodejs_major_version: 22
    sites:
      - example
      - app
    all_domains:
      - example
      - app
      - api

  tasks:
    - name: Update apt cache and upgrade all packages
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
        upgrade: dist

    - name: Install required packages
      ansible.builtin.apt:
        name:
          - nginx
          - certbot
          - python3-certbot-nginx
          - ca-certificates
          - curl
        state: present

    - name: Create keyrings directory
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"

    # Node.js installation for API
    - name: Download and dearmor NodeSource GPG key
      ansible.builtin.shell:
        cmd: set -o pipefail && curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg
        executable: /bin/bash
        creates: /etc/apt/keyrings/nodesource.gpg

    - name: Set permissions on NodeSource GPG key
      ansible.builtin.file:
        path: /etc/apt/keyrings/nodesource.gpg
        mode: "0644"

    - name: Add NodeSource repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_{{ nodejs_major_version }}.x nodistro main"
        state: present
        filename: nodesource

    - name: Install Node.js
      ansible.builtin.apt:
        name: nodejs
        state: present
        update_cache: true

    # API directory and service
    - name: Create API directory
      ansible.builtin.file:
        path: /opt/rapid-api
        state: directory
        owner: www-data
        group: www-data
        mode: "0755"

    - name: Deploy rapid-api systemd service
      ansible.builtin.template:
        src: ../templates/rapid-api.service.j2
        dest: /etc/systemd/system/rapid-api.service
        owner: root
        group: root
        mode: "0644"
      notify: Reload systemd

    - name: Enable rapid-api service
      ansible.builtin.systemd:
        name: rapid-api
        enabled: true
        daemon_reload: true

    - name: Create web root directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: www-data
        group: www-data
        mode: "0755"
      loop: "{{ sites | map('regex_replace', '^', '/var/www/') | list }}"

    - name: Deploy nginx vhosts
      ansible.builtin.template:
        src: ../templates/nginx-vhost.conf.j2
        dest: "/etc/nginx/sites-available/{{ item }}.conf"
        owner: root
        group: root
        mode: "0644"
      loop: "{{ sites }}"
      notify: Reload nginx

    - name: Enable nginx vhosts
      ansible.builtin.file:
        src: "/etc/nginx/sites-available/{{ item }}.conf"
        dest: "/etc/nginx/sites-enabled/{{ item }}.conf"
        state: link
      loop: "{{ sites }}"
      notify: Reload nginx

    - name: Remove default nginx site
      ansible.builtin.file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: Reload nginx

    # API nginx configuration
    - name: Deploy nginx API reverse proxy config
      ansible.builtin.template:
        src: ../templates/nginx-api.conf.j2
        dest: /etc/nginx/sites-available/api.conf
        owner: root
        group: root
        mode: "0644"
      notify: Reload nginx

    - name: Enable nginx API config
      ansible.builtin.file:
        src: /etc/nginx/sites-available/api.conf
        dest: /etc/nginx/sites-enabled/api.conf
        state: link
      notify: Reload nginx

    - name: Ensure nginx is running and enabled
      ansible.builtin.systemd:
        name: nginx
        state: started
        enabled: true

    - name: Flush handlers to ensure nginx config is active
      ansible.builtin.meta: flush_handlers

    - name: Obtain SSL certificates with certbot
      ansible.builtin.command:
        cmd: >
          certbot --nginx
          --non-interactive
          --agree-tos
          --expand
          --email {{ certbot_email }}
          --domains {{ all_domains | map('regex_replace', '$', '.' ~ domain) | join(',') }}
      register: certbot_result
      changed_when: "'Certificate not yet due for renewal' not in certbot_result.stdout"

  handlers:
    - name: Reload nginx
      ansible.builtin.systemd:
        name: nginx
        state: reloaded

    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true
