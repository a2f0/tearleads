---
# COMPLIANCE_SENTINEL: TL-INFRA-004 | control=ssh-hardening
- name: Bootstrap k8s cluster with ingress and cert-manager
  hosts: all
  become: true

  vars:
    ansible_python_interpreter: /usr/bin/python3
    cert_manager_version: "v1.14.4"
    cert_manager_url: "https://github.com/cert-manager/cert-manager/releases/download/{{ cert_manager_version }}/cert-manager.yaml"
    cert_manager_checksum: "sha256:fcaaf51002a56a59f65b64ca2da021a93a51733c21a8e8478e7263c00eff7cd0"
    nginx_ingress_version: "v1.10.0"
    nginx_ingress_base: "https://raw.githubusercontent.com/kubernetes/ingress-nginx"
    nginx_ingress_url: "{{ nginx_ingress_base }}/controller-{{ nginx_ingress_version }}/deploy/static/provider/cloud/deploy.yaml"
    nginx_ingress_checksum: "sha256:d3cce94986e23cdd6016d76a2ef6beb41856ed143b1aa956edf2d59b66fbe4f7"
    linux_security_baseline_manage_ufw: false
    linux_security_baseline_ufw_allow_rules: []
    linux_security_baseline_ssh_settings:
      - { key: "PermitRootLogin", value: "no" }
      - { key: "PasswordAuthentication", value: "no" }
      - { key: "PubkeyAuthentication", value: "yes" }
      - { key: "MaxAuthTries", value: "3" }
      - { key: "KbdInteractiveAuthentication", value: "no" }
    k3s_pod_cidr: "10.244.0.0/16"
    k8s_vpc_cidr: "10.42.0.0/16"

  tasks:
    - name: Apply shared Linux security baseline
      ansible.builtin.import_tasks: tasks/linuxSecurityBaseline.yml

    - name: Configure Tailscale
      when: tailscale_auth_key is defined and tailscale_auth_key | length > 0
      block:
        - name: Download Tailscale install script
          ansible.builtin.get_url:
            url: https://tailscale.com/install.sh
            dest: /tmp/install-tailscale.sh
            mode: "0755"
          when: not ansible_check_mode

        - name: Install Tailscale
          ansible.builtin.command:
            cmd: /tmp/install-tailscale.sh
            creates: /usr/bin/tailscale

        - name: Check Tailscale status
          ansible.builtin.command:
            cmd: tailscale status
          register: tailscale_status
          failed_when: false
          changed_when: false

        - name: Connect to Tailscale
          ansible.builtin.command:
            cmd: tailscale up --hostname=staging-k8s
          environment:
            TS_AUTHKEY: "{{ tailscale_auth_key }}"
          changed_when: true
          no_log: true
          when: tailscale_status.rc != 0

        - name: Verify Tailscale is running
          ansible.builtin.command:
            cmd: tailscale status
          changed_when: false

        - name: Ensure k3s config directory exists
          ansible.builtin.file:
            path: /etc/rancher/k3s
            state: directory
            owner: root
            group: root
            mode: "0755"

        - name: Ensure k3s TLS SAN includes Tailscale hostname
          ansible.builtin.lineinfile:
            path: /etc/rancher/k3s/config.yaml
            line: 'tls-san: ["staging-k8s"]'
            create: true
            owner: root
            group: root
            mode: "0644"
          notify: Restart k3s

    - name: Wait for k3s to be ready
      ansible.builtin.command:
        cmd: k3s kubectl get nodes
      register: k3s_nodes
      until: k3s_nodes.rc == 0
      retries: 30
      delay: 10
      changed_when: false

    - name: Check SNAT rule for pod traffic to VPC CIDR
      ansible.builtin.command:
        cmd: iptables -t nat -C POSTROUTING -s {{ k3s_pod_cidr }} -d {{ k8s_vpc_cidr }} -j MASQUERADE
      register: k3s_pod_snat_rule
      failed_when: false
      changed_when: false

    - name: Add SNAT rule for pod traffic to VPC CIDR
      ansible.builtin.command:
        cmd: iptables -t nat -A POSTROUTING -s {{ k3s_pod_cidr }} -d {{ k8s_vpc_cidr }} -j MASQUERADE
      register: k3s_pod_snat_apply
      when: k3s_pod_snat_rule.rc != 0
      changed_when: k3s_pod_snat_apply.rc == 0
      failed_when: k3s_pod_snat_apply.rc != 0

    - name: Download nginx-ingress manifest
      ansible.builtin.get_url:
        url: "{{ nginx_ingress_url }}"
        dest: "/tmp/nginx-ingress-{{ nginx_ingress_version }}.yaml"
        checksum: "{{ nginx_ingress_checksum }}"
        mode: "0644"

    - name: Install nginx-ingress controller
      ansible.builtin.command:
        cmd: k3s kubectl apply -f /tmp/nginx-ingress-{{ nginx_ingress_version }}.yaml
      register: nginx_ingress_result
      changed_when: "'created' in nginx_ingress_result.stdout or 'configured' in nginx_ingress_result.stdout"

    - name: Wait for nginx-ingress to be ready
      ansible.builtin.shell:
        cmd: |
          k3s kubectl -n ingress-nginx wait --for=condition=ready pod -l app.kubernetes.io/component=controller --timeout=300s
      register: nginx_wait
      until: nginx_wait.rc == 0
      retries: 5
      delay: 30
      changed_when: false

    - name: Download cert-manager manifest
      ansible.builtin.get_url:
        url: "{{ cert_manager_url }}"
        dest: "/tmp/cert-manager-{{ cert_manager_version }}.yaml"
        checksum: "{{ cert_manager_checksum }}"
        mode: "0644"

    - name: Install cert-manager
      ansible.builtin.command:
        cmd: k3s kubectl apply -f /tmp/cert-manager-{{ cert_manager_version }}.yaml
      register: cert_manager_result
      changed_when: "'created' in cert_manager_result.stdout or 'configured' in cert_manager_result.stdout"

    - name: Wait for cert-manager to be ready
      ansible.builtin.shell:
        cmd: |
          k3s kubectl -n cert-manager wait --for=condition=ready pod -l app.kubernetes.io/instance=cert-manager --timeout=300s
      register: cert_manager_wait
      until: cert_manager_wait.rc == 0
      retries: 5
      delay: 30
      changed_when: false

    - name: Display cluster status
      ansible.builtin.shell:
        cmd: |
          echo "=== Nodes ==="
          k3s kubectl get nodes
          echo ""
          echo "=== Ingress Controller ==="
          k3s kubectl -n ingress-nginx get pods
          echo ""
          echo "=== Cert Manager ==="
          k3s kubectl -n cert-manager get pods
      register: cluster_status
      changed_when: false

    - name: Show cluster status
      ansible.builtin.debug:
        var: cluster_status.stdout_lines

    - name: Clean up temporary files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "/tmp/nginx-ingress-{{ nginx_ingress_version }}.yaml"
        - "/tmp/cert-manager-{{ cert_manager_version }}.yaml"

  handlers:
    - name: Restart k3s
      ansible.builtin.systemd:
        name: k3s
        state: restarted

    - name: Restart sshd
      ansible.builtin.systemd:
        name: ssh
        state: restarted
