---
# COMPLIANCE_SENTINEL: TL-INFRA-004 | control=ssh-hardening
- name: Bootstrap k8s cluster with ingress and cert-manager
  hosts: all
  become: true

  vars:
    ansible_python_interpreter: /usr/bin/python3
    cert_manager_version: "v1.14.4"
    nginx_ingress_version: "v1.10.0"
    nginx_ingress_manifest: "{{ playbook_dir }}/../vendor/k8s/nginx-ingress-{{ nginx_ingress_version }}.yaml"
    cert_manager_manifest: "{{ playbook_dir }}/../vendor/k8s/cert-manager-{{ cert_manager_version }}.yaml"
    nerdctl_version: "1.7.6"
    nerdctl_checksum: "sha256:0326d6a42dbec5c104ed9d7aa8cbc62727433dbe000cf21cc29d06b22507e0f0"
    buildkit_version: "0.13.2"
    buildkit_checksum: "sha256:9cd121931b015f05d7e4337f08272e36a83f69724c40141947eb11246ca0bb9d"
    linux_security_baseline_manage_ufw: false
    linux_security_baseline_ufw_allow_rules: []
    linux_security_baseline_ssh_settings:
      - { key: "PermitRootLogin", value: "no" }
      - { key: "PasswordAuthentication", value: "no" }
      - { key: "PubkeyAuthentication", value: "yes" }
      - { key: "MaxAuthTries", value: "3" }
      - { key: "KbdInteractiveAuthentication", value: "no" }

  tasks:
    - name: Apply shared Linux security baseline
      ansible.builtin.import_tasks: tasks/linuxSecurityBaseline.yml

    - name: Download Tailscale install script
      ansible.builtin.get_url:
        url: https://tailscale.com/install.sh
        dest: /tmp/install-tailscale.sh
        mode: "0755"
      when:
        - tailscale_auth_key is defined and tailscale_auth_key | length > 0
        - not ansible_check_mode

    - name: Install Tailscale
      ansible.builtin.command:
        cmd: /tmp/install-tailscale.sh
        creates: /usr/bin/tailscale
      when: tailscale_auth_key is defined and tailscale_auth_key | length > 0

    - name: Check Tailscale status
      ansible.builtin.command:
        cmd: tailscale status
      register: tailscale_status
      failed_when: false
      changed_when: false
      when: tailscale_auth_key is defined and tailscale_auth_key | length > 0

    - name: Connect to Tailscale
      ansible.builtin.command:
        cmd: tailscale up --authkey={{ tailscale_auth_key }} --hostname=staging-k8s
      changed_when: true
      when:
        - tailscale_auth_key is defined and tailscale_auth_key | length > 0
        - tailscale_status.rc != 0

    - name: Verify Tailscale is running
      ansible.builtin.command:
        cmd: tailscale status
      changed_when: false
      when: tailscale_auth_key is defined and tailscale_auth_key | length > 0

    - name: Ensure k3s TLS SAN includes Tailscale hostname
      ansible.builtin.copy:
        dest: /etc/rancher/k3s/config.yaml
        content: |
          tls-san:
            - "staging-k8s"
        owner: root
        group: root
        mode: "0644"
      register: k3s_config
      when: tailscale_auth_key is defined and tailscale_auth_key | length > 0

    - name: Restart k3s to pick up TLS SAN change
      ansible.builtin.systemd:
        name: k3s
        state: restarted
      when:
        - tailscale_auth_key is defined and tailscale_auth_key | length > 0
        - k3s_config is changed

    - name: Wait for k3s to be ready
      ansible.builtin.command:
        cmd: k3s kubectl get nodes
      register: k3s_nodes
      until: k3s_nodes.rc == 0
      retries: 30
      delay: 10
      changed_when: false

    - name: Copy nginx-ingress manifest to target
      ansible.builtin.copy:
        src: "{{ nginx_ingress_manifest }}"
        dest: "/tmp/nginx-ingress-{{ nginx_ingress_version }}.yaml"
        mode: "0644"

    - name: Install nginx-ingress controller
      ansible.builtin.command:
        cmd: k3s kubectl apply -f /tmp/nginx-ingress-{{ nginx_ingress_version }}.yaml
      register: nginx_ingress_result
      changed_when: "'created' in nginx_ingress_result.stdout or 'configured' in nginx_ingress_result.stdout"

    - name: Wait for nginx-ingress to be ready
      ansible.builtin.shell:
        cmd: |
          k3s kubectl -n ingress-nginx wait --for=condition=ready pod -l app.kubernetes.io/component=controller --timeout=300s
      register: nginx_wait
      until: nginx_wait.rc == 0
      retries: 5
      delay: 30
      changed_when: false

    - name: Copy cert-manager manifest to target
      ansible.builtin.copy:
        src: "{{ cert_manager_manifest }}"
        dest: "/tmp/cert-manager-{{ cert_manager_version }}.yaml"
        mode: "0644"

    - name: Install cert-manager
      ansible.builtin.command:
        cmd: k3s kubectl apply -f /tmp/cert-manager-{{ cert_manager_version }}.yaml
      register: cert_manager_result
      changed_when: "'created' in cert_manager_result.stdout or 'configured' in cert_manager_result.stdout"

    - name: Wait for cert-manager to be ready
      ansible.builtin.shell:
        cmd: |
          k3s kubectl -n cert-manager wait --for=condition=ready pod -l app.kubernetes.io/instance=cert-manager --timeout=300s
      register: cert_manager_wait
      until: cert_manager_wait.rc == 0
      retries: 5
      delay: 30
      changed_when: false

    - name: Download nerdctl tarball
      ansible.builtin.get_url:
        # yamllint disable-line rule:line-length
        url: "https://github.com/containerd/nerdctl/releases/download/v{{ nerdctl_version }}/nerdctl-{{ nerdctl_version }}-linux-amd64.tar.gz"
        dest: "/tmp/nerdctl-{{ nerdctl_version }}-linux-amd64.tar.gz"
        checksum: "{{ nerdctl_checksum }}"
        mode: "0644"

    - name: Install nerdctl for building container images
      ansible.builtin.unarchive:
        src: "/tmp/nerdctl-{{ nerdctl_version }}-linux-amd64.tar.gz"
        dest: /usr/local/bin
        remote_src: true
        creates: /usr/local/bin/nerdctl

    - name: Download buildkit tarball
      ansible.builtin.get_url:
        # yamllint disable-line rule:line-length
        url: "https://github.com/moby/buildkit/releases/download/v{{ buildkit_version }}/buildkit-v{{ buildkit_version }}.linux-amd64.tar.gz"
        dest: "/tmp/buildkit-v{{ buildkit_version }}.linux-amd64.tar.gz"
        checksum: "{{ buildkit_checksum }}"
        mode: "0644"

    - name: Create buildkit installation directory
      ansible.builtin.file:
        path: /opt/buildkit
        state: directory
        mode: "0755"

    - name: Install buildkit for nerdctl
      ansible.builtin.unarchive:
        src: "/tmp/buildkit-v{{ buildkit_version }}.linux-amd64.tar.gz"
        dest: /opt/buildkit
        remote_src: true
        extra_opts:
          - --strip-components=1
        creates: /opt/buildkit/buildkitd

    - name: Create buildkit symlinks
      ansible.builtin.file:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        state: link
      loop:
        - { src: /opt/buildkit/buildkitd, dest: /usr/local/bin/buildkitd }
        - { src: /opt/buildkit/buildctl, dest: /usr/local/bin/buildctl }

    - name: Remove existing containerd directory
      ansible.builtin.file:
        path: /run/containerd
        state: absent

    - name: Create containerd socket symlink for nerdctl
      ansible.builtin.file:
        src: /run/k3s/containerd
        dest: /run/containerd
        state: link

    - name: Create buildkit config directory
      ansible.builtin.file:
        path: /etc/buildkit
        state: directory
        mode: "0755"

    - name: Create buildkit config for k3s containerd
      ansible.builtin.copy:
        dest: /etc/buildkit/buildkitd.toml
        content: |
          [worker.containerd]
            address = "/run/k3s/containerd/containerd.sock"
            enabled = true
            namespace = "k8s.io"
        owner: root
        group: root
        mode: "0644"
      notify: Restart buildkit

    - name: Create buildkit systemd service
      ansible.builtin.copy:
        dest: /etc/systemd/system/buildkit.service
        content: |
          [Unit]
          Description=BuildKit
          After=network.target k3s.service

          [Service]
          ExecStart=/usr/local/bin/buildkitd --config /etc/buildkit/buildkitd.toml --addr unix:///run/buildkit/buildkitd.sock
          Restart=always
          RestartSec=5

          [Install]
          WantedBy=multi-user.target
        owner: root
        group: root
        mode: "0644"
      notify: Restart buildkit

    - name: Create buildkit socket directory
      ansible.builtin.file:
        path: /run/buildkit
        state: directory
        mode: "0755"

    - name: Enable and start buildkit
      ansible.builtin.systemd:
        name: buildkit
        enabled: true
        state: restarted
        daemon_reload: true

    - name: Display cluster status
      ansible.builtin.shell:
        cmd: |
          echo "=== Nodes ==="
          k3s kubectl get nodes
          echo ""
          echo "=== Ingress Controller ==="
          k3s kubectl -n ingress-nginx get pods
          echo ""
          echo "=== Cert Manager ==="
          k3s kubectl -n cert-manager get pods
      register: cluster_status
      changed_when: false

    - name: Show cluster status
      ansible.builtin.debug:
        var: cluster_status.stdout_lines

    - name: Clean up temporary files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "/tmp/nginx-ingress-{{ nginx_ingress_version }}.yaml"
        - "/tmp/cert-manager-{{ cert_manager_version }}.yaml"
        - "/tmp/nerdctl-{{ nerdctl_version }}-linux-amd64.tar.gz"
        - "/tmp/buildkit-v{{ buildkit_version }}.linux-amd64.tar.gz"

  handlers:
    - name: Restart buildkit
      ansible.builtin.systemd:
        name: buildkit
        state: restarted
        daemon_reload: true

    - name: Restart sshd
      ansible.builtin.systemd:
        name: ssh
        state: restarted
