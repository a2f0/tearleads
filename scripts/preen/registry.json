{
  "categories": [
    {
      "id": "preen-typescript",
      "purpose": "Fix weak TypeScript typings (`any`, `as` casts, `@ts-ignore`)",
      "checklistLabel": "TypeScript types (`any`, `as` casts, `@ts-ignore`)",
      "qualityMetric": "Type safety findings (`any`, unsafe casts, `@ts-ignore`)",
      "security": false,
      "discoveryCommands": [
        "rg -n --glob '*.{ts,tsx}'",
        "  ': any|: any\\[\\]|<any>|as any|@ts-ignore|@ts-expect-error' .",
        "  | head -20"
      ],
      "metricCountCommand": "rg -n --glob '*.{ts,tsx}' ': any|: any\\[\\]|<any>|as any|@ts-ignore|@ts-expect-error' . | wc -l"
    },
    {
      "id": "preen-split-react-components",
      "purpose": "Split oversized React components into smaller files",
      "checklistLabel": "React component splitting",
      "qualityMetric": "Oversized React files",
      "security": false,
      "discoveryCommands": [
        "find . -name '*.tsx'",
        "  -not -path '*/node_modules/*'",
        "  -not -path '*/.next/*'",
        "  -not -path '*/dist/*'",
        "  -exec wc -l {} \\; 2>/dev/null",
        "  | awk '$1 > 300'",
        "  | sort -rn",
        "  | head -20"
      ],
      "metricCountCommand": "find . -name '*.tsx' -not -path '*/node_modules/*' -not -path '*/.next/*' -not -path '*/dist/*' -exec wc -l {} \\; 2>/dev/null | awk '$1 > 300' | wc -l"
    },
    {
      "id": "preen-deferred-fixes",
      "purpose": "Complete deferred follow-ups from merged PR reviews",
      "checklistLabel": "Deferred fixes from PR reviews",
      "qualityMetric": "Deferred issue count",
      "security": false,
      "discoveryCommands": [
        "REPO=$(gh repo view --json nameWithOwner -q .nameWithOwner 2>/dev/null);",
        "gh issue list -R \"$REPO\"",
        "  --label 'deferred'",
        "  --state open",
        "  --limit 20 2>/dev/null || true"
      ],
      "metricCountCommand": "REPO=$(gh repo view --json nameWithOwner -q .nameWithOwner 2>/dev/null); gh issue list -R \"$REPO\" --label 'deferred' --state open --json number --jq 'length' 2>/dev/null || echo 0"
    },
    {
      "id": "preen-optimize-test-execution",
      "purpose": "Tune CI impact analysis (workflow filters, package dependencies)",
      "checklistLabel": "CI impact/test execution tuning",
      "qualityMetric": "CI impact warnings",
      "security": false,
      "discoveryCommands": [
        "pnpm exec tsx scripts/ciImpact/ciImpact.ts",
        "  --base origin/main",
        "  --head HEAD",
        "  | head -40"
      ],
      "metricCountCommand": "pnpm exec tsx scripts/ciImpact/ciImpact.ts --base origin/main --head HEAD 2>/dev/null | jq '.warnings | length' 2>/dev/null || echo 0"
    },
    {
      "id": "preen-database-performance",
      "purpose": "Find and fix database performance issues (N+1 queries, inefficient joins, index gaps)",
      "checklistLabel": "Database performance (N+1, joins, indexes)",
      "qualityMetric": "N+1 loop/query anti-pattern matches",
      "security": false,
      "discoveryCommands": [
        "rg -n --multiline --multiline-dotall --glob '*.{ts,tsx}'",
        "  'for\\s*\\([^)]*\\)\\s*\\{.{0,400}?await\\s+[^\\n;]*db\\.(select|query|execute)'",
        "  packages | head -40 || true",
        "rg -n --glob '*.{ts,tsx}'",
        "  '\\.(leftJoin|innerJoin|rightJoin|fullJoin|crossJoin)\\('",
        "  packages | head -40 || true",
        "rg -n --glob '**/*.{test,spec}.{ts,tsx}'",
        "  'withRealDatabase\\(|createTestDatabase\\('",
        "  packages | head -40 || true"
      ],
      "metricCountCommand": "rg -n --multiline --multiline-dotall --glob '*.{ts,tsx}' 'for\\s*\\([^)]*\\)\\s*\\{.{0,400}?await\\s+[^\\n;]*db\\.(select|query|execute)' packages | wc -l"
    },
    {
      "id": "preen-api-security",
      "purpose": "Audit API for authorization, data access, and security issues",
      "checklistLabel": "API security boundaries",
      "qualityMetric": "API security findings in touched area",
      "security": true,
      "discoveryCommands": [
        "rg -n --glob '*.ts'",
        "  'router\\.(get|post|put|patch|delete)|authClaims|req\\.session|pool\\.query|client\\.query'",
        "  packages/api/src/routes | head -40"
      ],
      "metricCountCommand": "rg -L --glob '*.ts' 'authClaims|req\\.session' packages/api/src/routes | rg -v 'index\\.ts|shared\\.ts|test\\.' | wc -l"
    },
    {
      "id": "preen-dependency-security",
      "purpose": "Audit dependency vulnerabilities and unsafe versioning",
      "checklistLabel": "Dependency/security hygiene",
      "qualityMetric": "High/Critical dependency findings",
      "security": true,
      "discoveryCommands": [
        "pnpm audit --prod --audit-level high --json 2>/dev/null | head -40 || true",
        "rg -n --glob 'package.json'",
        "  'latest|next|canary|beta'",
        "  packages scripts . | head -20 || true"
      ],
      "metricCountCommand": "pnpm audit --prod --audit-level high --json 2>/dev/null | jq '[.. | objects | .severity? // empty | select(. == \"high\" or . == \"critical\")] | length' 2>/dev/null || echo 0"
    },
    {
      "id": "preen-test-flakiness",
      "purpose": "Reduce flaky tests and nondeterministic waiting patterns",
      "checklistLabel": "Test flakiness hardening",
      "qualityMetric": "Flaky-pattern matches in tests",
      "security": false,
      "discoveryCommands": [
        "rg -n --glob '**/*.{test,spec}.{ts,tsx}'",
        "  'setTimeout\\(|waitForTimeout\\(|sleep\\('",
        "  packages . | head -30 || true",
        "rg -n --glob '**/*.{test,spec}.{ts,tsx}'",
        "  'retry|retries|flaky|TODO.*flaky'",
        "  packages . | head -30 || true"
      ],
      "metricCountCommand": "rg -n --glob '**/*.{test,spec}.{ts,tsx}' 'setTimeout\\(|waitForTimeout\\(|sleep\\(|retry|retries|flaky|TODO.*flaky' packages . | wc -l"
    },
    {
      "id": "preen-msw-parity",
      "purpose": "Audit MSW handlers against API routes and improve test coverage assertions",
      "checklistLabel": "MSW/API parity and request-assertion wiring",
      "qualityMetric": "MSW parity risk count (missing + low-confidence)",
      "security": false,
      "discoveryCommands": [
        "./scripts/checks/checkMswParity.ts",
        "./scripts/checks/checkMswParity.ts --json | head -40"
      ],
      "metricCountCommand": "./scripts/checks/checkMswParity.ts --json | jq '.missingRouteCount + .lowConfidenceRouteCount'"
    },
    {
      "id": "preen-skill-tooling",
      "purpose": "Validate skills are wired into agentTool.ts and scriptTool.ts",
      "checklistLabel": "Skill tooling validation",
      "qualityMetric": "Skill parity/tooling issues",
      "security": false,
      "discoveryCommands": [
        "./scripts/checkPreenEcosystem.sh --summary"
      ],
      "metricCountCommand": "./scripts/checkPreenEcosystem.sh --count-issues"
    },
    {
      "id": "preen-skill-parity",
      "purpose": "Ensure skill definitions are consistent across OpenCode, Codex, Gemini, and Claude",
      "checklistLabel": "Skill parity across agents",
      "qualityMetric": "Cross-agent skill parity issues",
      "security": false,
      "discoveryCommands": [
        "./scripts/checkSkillParity.sh --summary"
      ],
      "metricCountCommand": "./scripts/checkSkillParity.sh --count-issues"
    },
    {
      "id": "preen-compliance-docs",
      "purpose": "Audit compliance documentation for gaps and cross-framework parity",
      "checklistLabel": "Compliance documentation gaps and parity",
      "qualityMetric": "Compliance documentation gaps (missing triads + unnumbered files)",
      "security": false,
      "discoveryCommands": [
        "for fw in HIPAA NIST.SP.800-53 SOC2; do",
        "  echo \"=== $fw ===\"",
        "  echo \"Policies: $(ls compliance/$fw/policies/*.md 2>/dev/null | wc -l | tr -d ' ')\"",
        "  echo \"Procedures: $(ls compliance/$fw/procedures/*.md 2>/dev/null | wc -l | tr -d ' ')\"",
        "  echo \"Controls: $(ls compliance/$fw/technical-controls/*.md 2>/dev/null | wc -l | tr -d ' ')\"",
        "done",
        "find compliance -name '*.md'",
        "  -not -name 'POLICY_INDEX.md'",
        "  -not -name 'AGENTS.md'",
        "  | xargs -I{} basename {}",
        "  | grep -v '^[0-9][0-9]-'",
        "  | head -10"
      ],
      "metricCountCommands": [
        "gaps=0",
        "for fw in HIPAA NIST.SP.800-53 SOC2; do",
        "  find \"compliance/$fw/policies\" -name '*-policy.md' -type f 2>/dev/null | while read -r policy_file; do",
        "    policy=$(basename \"$policy_file\" -policy.md)",
        "    [ ! -f \"compliance/$fw/procedures/${policy}-procedure.md\" ] && gaps=$((gaps + 1))",
        "    [ ! -f \"compliance/$fw/technical-controls/${policy}-control-map.md\" ] && gaps=$((gaps + 1))",
        "  done",
        "done",
        "unnumbered=$(find compliance -name '*.md' -not -name 'POLICY_INDEX.md' -not -name 'AGENTS.md' | xargs -I{} basename {} | grep -v '^[0-9][0-9]-' | wc -l)",
        "echo $((gaps + unnumbered))"
      ]
    },
    {
      "id": "preen-package-docs",
      "purpose": "Audit and generate missing package README.md files",
      "checklistLabel": "Package documentation (README.md files)",
      "qualityMetric": "Packages missing README.md",
      "security": false,
      "discoveryCommands": [
        "echo '=== Packages missing README ==='",
        "for pkg in packages/*/; do",
        "  [ ! -f \"${pkg}README.md\" ] && basename \"$pkg\"",
        "done",
        "echo '=== Summary ==='",
        "total=$(ls -d packages/*/ | wc -l | tr -d ' ')",
        "with_readme=$(ls packages/*/README.md 2>/dev/null | wc -l | tr -d ' ')",
        "echo \"$with_readme/$total packages have READMEs\""
      ],
      "metricCountCommand": "count=0; for pkg in packages/*/; do [ ! -f \"${pkg}README.md\" ] && count=$((count + 1)); done; echo $count"
    },
    {
      "id": "preen-review-instructions",
      "purpose": "Audit and update code review instructions (REVIEW.md, .gemini/INSTRUCTIONS.md)",
      "checklistLabel": "Review instruction completeness and sync",
      "qualityMetric": "Review instruction gaps (missing sections + Gemini drift)",
      "security": false,
      "discoveryCommands": [
        "echo '=== REVIEW.md sections ==='",
        "rg '^##' REVIEW.md | head -20",
        "echo '=== Gemini sections ==='",
        "rg '^##' .gemini/INSTRUCTIONS.md | head -20",
        "echo '=== Section comparison ==='",
        "echo \"REVIEW.md: $(rg '^## ' REVIEW.md | wc -l | tr -d ' ')\"",
        "echo \"Gemini: $(rg '^## ' .gemini/INSTRUCTIONS.md | wc -l | tr -d ' ')\""
      ],
      "metricCountCommands": [
        "GAPS=0",
        "for section in 'TypeScript Standards' 'API Security' 'React Standards' 'Database Performance' 'Testing Standards'; do",
        "  [ -z \"$(rg --fixed-strings -- \"$section\" REVIEW.md 2>/dev/null)\" ] && GAPS=$((GAPS + 1))",
        "done",
        "REVIEW_SECTIONS=$(rg '^## ' REVIEW.md 2>/dev/null | wc -l | tr -d ' ')",
        "GEMINI_SECTIONS=$(rg '^## ' .gemini/INSTRUCTIONS.md 2>/dev/null | wc -l | tr -d ' ')",
        "[ \"$GEMINI_SECTIONS\" -lt $((REVIEW_SECTIONS / 2)) ] && GAPS=$((GAPS + 1))",
        "echo $GAPS"
      ]
    },
    {
      "id": "preen-i18n",
      "purpose": "Audit i18n translation coverage, missing keys, and hardcoded strings",
      "checklistLabel": "i18n translation coverage and consistency",
      "qualityMetric": "i18n gaps (missing translation keys + hardcoded strings)",
      "security": false,
      "discoveryCommands": [
        "echo '=== Translation Files ==='",
        "find packages -path '*/i18n/translations/*.ts'",
        "  -not -name 'types.ts'",
        "  -not -name 'index.ts' | head -20",
        "echo '=== Key Count by Language ==='",
        "for lang in en es ua pt; do",
        "  count=$(rg -o \"^\\s+\\w+:\" packages/client/src/i18n/translations/${lang}.ts 2>/dev/null | wc -l | tr -d ' ')",
        "  echo \"${lang}: ${count} keys\"",
        "done",
        "echo '=== Potential Hardcoded Strings ==='",
        "rg -n --glob '*.tsx'",
        "  '>\\s*[A-Z][a-z]+(\\s+[a-z]+)*\\s*<'",
        "  packages | rg -v 'test\\.' | head -20"
      ],
      "metricCountCommands": [
        "EN_KEYS=$(rg -o \"^\\s+\\w+:\" packages/client/src/i18n/translations/en.ts 2>/dev/null | wc -l | tr -d ' ')",
        "GAPS=0",
        "for lang in es ua pt; do",
        "  LANG_KEYS=$(rg -o \"^\\s+\\w+:\" packages/client/src/i18n/translations/${lang}.ts 2>/dev/null | wc -l | tr -d ' ')",
        "  [ \"$LANG_KEYS\" -lt \"$EN_KEYS\" ] && GAPS=$((GAPS + EN_KEYS - LANG_KEYS))",
        "done",
        "HARDCODED=$(rg -c --glob '*.tsx' '>\\s*[A-Z][a-z]+(\\s+[a-z]+)*\\s*<' packages 2>/dev/null | rg -v 'test\\.' | awk -F: '{sum+=$2} END {print sum+0}')",
        "echo $((GAPS + HARDCODED))"
      ]
    },
    {
      "id": "preen-docs-internationalization",
      "purpose": "Translate and sync documentation across all supported languages",
      "checklistLabel": "Documentation internationalization coverage",
      "qualityMetric": "Missing or orphaned doc translations",
      "security": false,
      "discoveryCommands": [
        "echo '=== Translation Coverage ==='",
        "echo \"English (source): $(ls docs/en/*.md 2>/dev/null | wc -l | tr -d ' ')\"",
        "echo \"Spanish: $(ls docs/es/*.md 2>/dev/null | wc -l | tr -d ' ')\"",
        "echo \"Ukrainian: $(ls docs/ua/*.md 2>/dev/null | wc -l | tr -d ' ')\"",
        "echo \"Portuguese: $(ls docs/pt/*.md 2>/dev/null | wc -l | tr -d ' ')\"",
        "echo '=== Missing Translations ==='",
        "for lang in es ua pt; do",
        "  for file in docs/en/*.md; do",
        "    target=\"docs/$lang/$(basename \"$file\")\"",
        "    [ -f \"$target\" ] || echo \"Missing: $target\"",
        "  done",
        "done"
      ],
      "metricCountCommands": [
        "EN_COUNT=$(ls docs/en/*.md 2>/dev/null | wc -l | tr -d ' ')",
        "GAPS=0",
        "for lang in es ua pt; do",
        "  LANG_COUNT=$(ls docs/$lang/*.md 2>/dev/null | wc -l | tr -d ' ')",
        "  [ \"$LANG_COUNT\" -lt \"$EN_COUNT\" ] && GAPS=$((GAPS + EN_COUNT - LANG_COUNT))",
        "done",
        "echo $GAPS"
      ]
    },
    {
      "id": "preen-window-consistency",
      "purpose": "Normalize window components and standardize refresh patterns into window-manager",
      "checklistLabel": "Window component consistency and refresh patterns",
      "qualityMetric": "Non-standardized window patterns (manual refresh, drag, resize)",
      "security": false,
      "discoveryCommands": [
        "rg -n --glob '*.tsx'",
        "  'lastRefreshTokenRef|lastRefreshToken'",
        "  packages | rg -v 'window-manager' | head -20",
        "rg -n --glob '*.tsx'",
        "  'dragOverId.*useState|setDragOver.*Id'",
        "  packages | rg -v 'window-manager' | head -20",
        "rg -n --glob '*.tsx'",
        "  'cursor-col-resize.*onMouseDown|handleResize.*MouseEvent'",
        "  packages | rg -v 'window-manager' | head -20"
      ],
      "metricCountCommands": [
        "MANUAL_REFRESH=$(rg -c --glob '*.tsx' 'lastRefreshTokenRef|lastRefreshToken' packages 2>/dev/null | rg -v 'window-manager' | awk -F: '{sum+=$NF} END {print sum+0}')",
        "MANUAL_DRAG=$(rg -c --glob '*.tsx' 'dragOverId.*useState|setDragOver.*Id' packages 2>/dev/null | rg -v 'window-manager' | awk -F: '{sum+=$NF} END {print sum+0}')",
        "MANUAL_RESIZE=$(rg -c --glob '*.tsx' 'cursor-col-resize.*onMouseDown|handleResize.*MouseEvent' packages 2>/dev/null | rg -v 'window-manager' | awk -F: '{sum+=$NF} END {print sum+0}')",
        "echo $((MANUAL_REFRESH + MANUAL_DRAG + MANUAL_RESIZE))"
      ]
    },
    {
      "id": "preen-file-limits",
      "purpose": "Break down large files exceeding project size limits (500 lines or 20,000 bytes)",
      "checklistLabel": "Large files exceeding project limits",
      "qualityMetric": "Files exceeding size limits (500 lines or 20,000 bytes)",
      "security": false,
      "discoveryCommands": [
        "./scripts/checks/checkFileLimits.sh --all 2>&1 | head -40"
      ],
      "metricCountCommand": "./scripts/checks/checkFileLimits.sh --all 2>&1 | grep \"^  - \" | wc -l"
    },
    {
      "id": "preen-knip",
      "purpose": "Reduce knip findings by removing unused dependencies, exports, and files in coherent slices",
      "checklistLabel": "Knip unused dependency/export cleanup",
      "qualityMetric": "Knip finding count (dependencies + devDependencies + unlisted + unresolved + exports + types)",
      "security": false,
      "discoveryCommands": [
        "pnpm exec knip --config knip.ts --use-tsconfig-files --reporter compact | head -80 || true"
      ],
      "metricCountCommands": [
        "KNIP_JSON=$(mktemp)",
        "pnpm exec knip --config knip.ts --use-tsconfig-files --reporter json > \"$KNIP_JSON\" 2>/dev/null || true",
        "jq '[",
        "  .issues[]? |",
        "  (.dependencies // []),",
        "  (.devDependencies // []),",
        "  (.unlisted // []),",
        "  (.unresolved // []),",
        "  (.exports // []),",
        "  (.types // [])",
        "] | flatten | length' \"$KNIP_JSON\" 2>/dev/null",
        "rm -f \"$KNIP_JSON\""
      ]
    }
  ]
}
