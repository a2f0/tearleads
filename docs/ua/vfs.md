# VFS (Віртуальна Файлова Система)

Статус: проектування в процесі (відстежується в GitHub issue #1220).

Цей документ фіксує поточний напрямок проектування VFS для Tearleads. Мета полягає у підтримці зашифрованого, багатокористувацького спільного доступу до доменних об'єктів (контакти, фото, нотатки, файли) з гнучкою ієрархією та надійним управлінням ключами.

## Цілі

- Організувати доменні об'єкти в ієрархію (папки та вкладені структури)
- Ділитися об'єктами або підгілками між користувачами
- Дозволити одному об'єкту з'являтися в кількох місцях
- Зберігати контент зашифрованим наскрізно з явним обгортанням ключів

## Основна модель даних

### `vfs_registry`

Таблиця ідентичності для всіх елементів, що беруть участь у VFS.

- `id`: спільний первинний ключ для об'єкта
- `object_type`: `folder`, `contact`, `photo`, `note` тощо.
- `owner_id`: id користувача-власника
- `encrypted_session_key`: ключ шифрування контенту (зашифрований у стані спокою)
- `public_hierarchical_key`: публічний ключ для спільного доступу до підгілки
- `encrypted_private_hierarchical_key`: зашифрований приватний ієрархічний ключ

### `vfs_folders`

Специфічні для папки метадані для елементів реєстру типу `folder`.

- `id`: зовнішній ключ до `vfs_registry.id`
- `encrypted_name`: назва папки, зашифрована сесійним ключем елемента

### `vfs_links`

Зв'язки батько-дитина між елементами реєстру.

- `parent_id`, `child_id`
- `wrapped_session_key`: сесійний ключ дитини, обгорнутий ієрархічним ключем батька
- `wrapped_hierarchical_key`: обгорнутий ієрархічний ключ дитини (опціонально)
- `visible_children`: опціональна фільтрація дітей для перегляду часткового спільного доступу

Це підтримує структуру типу DAG, де один об'єкт може бути пов'язаний з кількома батьками.

### `user_keys`

Матеріал ключів для кожного користувача.

- публічний ключ шифрування (для отримання спільних доступів)
- публічний ключ підпису
- зашифровані приватні ключі
- сіль Argon2 для деривації на основі пароля

### `vfs_access`

Прямі надання від елемента до користувача.

- обгорнуті ключі елемента для отримувача
- рівень дозволу (`read`, `write`, `admin`)
- опціональні метадані закінчення терміну дії

## Патерн реєстру

Доменні таблиці мають спільні первинні ключі з `vfs_registry`.

Приклад:

```sql
CREATE TABLE contacts (
  id UUID PRIMARY KEY REFERENCES vfs_registry(id) ON DELETE CASCADE,
  encrypted_data BYTEA NOT NULL
);
```

Це підтримує сильну референційну цілісність і дозволяє операціям VFS працювати з доменними об'єктами через єдиний рівень ідентичності.

## Модель спільного доступу та обходу

### Відкриття кореня

1. Читання прямих надань у `vfs_access`
2. Розшифрування обгорнутих ключів приватним ключем користувача
3. Відображення кореневих елементів

### Обхід дітей

1. Запит `vfs_links` за `parent_id`
2. Розгортання ключів дітей за допомогою ієрархічного ключа батька
3. Рекурсивне повторення

### Спільний доступ до підгілки

1. Обгортання кореневих ключів для користувача-отримувача
2. Вставка надання в `vfs_access`
3. Отримувач обходить підгілку через обгорнуті ключі зв'язку

### Множинне розміщення

Той самий об'єкт може бути пов'язаний з кількома батьками шляхом додавання нових рядків `vfs_links`. Кожен зв'язок може мати незалежні обмеження видимості.

## Напрямок шифрування

Поточний напрямок проектування:

- шифрування контенту: `AES-256-GCM`
- деривація пароля: `Argon2id` + `HKDF`
- спільний доступ/обгортання ключів: гібридний `ML-KEM-768 + X25519`
- підписи: `ML-DSA` (або `Ed25519`, де потрібно)

Намір проектування - глибокий захист плюс шлях до постквантової стійкості.

## Приклад ієрархії

```text
Папка "Люди"
  - Контакт "Іван Петренко"
    - Фото (аватар)
    - Нотатка "Познайомився на конференції"

Папка "Робочі контакти"
  - Контакт "Іван Петренко" (той самий об'єкт, інший зв'язок)
```

Різні зв'язки з тим самим дитячим елементом можуть відкривати різні підмножини нащадків.

## Примітки щодо OPFS

Очікується, що бінарні дані (фото/файли) зберігатимуться в OPFS із шифруванням на рівні елемента. Реєстр VFS зберігає метадані та обгорнуті ключі; бінарні байти залишаються в сховищі, керованому клієнтом.

## Фази впровадження

1. Основні таблиці та примітиви життєвого циклу ключів
2. Криптографічна інфраструктура (генерація ключів, обгортання, потоки розгортання)
3. Операції VFS (зв'язування, спільний доступ, скасування спільного доступу, обхід)
4. Доменні інтеграції (контакти/фото/нотатки + зашифровані поля)
5. Розширені функції (`visible_children`, ротація ключів, закінчення терміну дії, відновлення)

## Поточні застереження

- Це еволюціонуючий проектний документ, а не фіналізована специфікація.
- Обмеження типу батько/дитина наразі очікуються на рівні застосунку.
- Потоки ротації ключів та відновлення заплановані, але не завершені.
