apiVersion: v1
kind: ConfigMap
metadata:
  name: garage-config
  namespace: tearleads
data:
  garage.toml: |
    metadata_dir = "/var/lib/garage/meta"
    data_dir = "/var/lib/garage/data"
    db_engine = "sqlite"

    replication_factor = 1

    rpc_bind_addr = "[::]:3901"
    rpc_public_addr = "garage:3901"
    rpc_secret = "${GARAGE_RPC_SECRET}"

    [s3_api]
    s3_region = "us-east-1"
    api_bind_addr = "[::]:3900"
    root_domain = ".s3.garage.localhost"

    [s3_web]
    bind_addr = "[::]:3902"
    root_domain = ".web.garage.localhost"

    [admin]
    api_bind_addr = "[::]:3903"
    admin_token = "${GARAGE_ADMIN_TOKEN}"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: garage-meta
  namespace: tearleads
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: garage-data
  namespace: tearleads
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: garage
  namespace: tearleads
spec:
  replicas: 1
  selector:
    matchLabels:
      app: garage
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: garage
    spec:
      initContainers:
        - name: render-config
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              # busybox lacks envsubst; use sed to replace placeholders
              sed \
                -e "s|\${GARAGE_RPC_SECRET}|${GARAGE_RPC_SECRET}|g" \
                -e "s|\${GARAGE_ADMIN_TOKEN}|${GARAGE_ADMIN_TOKEN}|g" \
                /etc/garage-template/garage.toml > /etc/garage-rendered/garage.toml
          env:
            - name: GARAGE_RPC_SECRET
              valueFrom:
                secretKeyRef:
                  name: tearleads-secrets
                  key: GARAGE_RPC_SECRET
            - name: GARAGE_ADMIN_TOKEN
              valueFrom:
                secretKeyRef:
                  name: tearleads-secrets
                  key: GARAGE_ADMIN_TOKEN
          volumeMounts:
            - name: config
              mountPath: /etc/garage-template
            - name: rendered-config
              mountPath: /etc/garage-rendered
      containers:
        - name: garage
          image: dxflrs/garage:v2.2.0
          ports:
            - containerPort: 3900
              name: s3
            - containerPort: 3901
              name: rpc
            - containerPort: 3902
              name: web
            - containerPort: 3903
              name: admin
          env:
            - name: GARAGE_RPC_SECRET
              valueFrom:
                secretKeyRef:
                  name: tearleads-secrets
                  key: GARAGE_RPC_SECRET
            - name: GARAGE_ADMIN_TOKEN
              valueFrom:
                secretKeyRef:
                  name: tearleads-secrets
                  key: GARAGE_ADMIN_TOKEN
          volumeMounts:
            - name: rendered-config
              mountPath: /etc/garage.toml
              subPath: garage.toml
            - name: meta
              mountPath: /var/lib/garage/meta
            - name: data
              mountPath: /var/lib/garage/data
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          startupProbe:
            tcpSocket:
              port: 3903
            initialDelaySeconds: 5
            periodSeconds: 5
            failureThreshold: 60
          readinessProbe:
            httpGet:
              path: /health
              port: 3903
            initialDelaySeconds: 10
            periodSeconds: 5
          livenessProbe:
            tcpSocket:
              port: 3903
            initialDelaySeconds: 30
            periodSeconds: 10
      volumes:
        - name: config
          configMap:
            name: garage-config
        - name: rendered-config
          emptyDir: {}
        - name: meta
          persistentVolumeClaim:
            claimName: garage-meta
        - name: data
          persistentVolumeClaim:
            claimName: garage-data
---
apiVersion: v1
kind: Service
metadata:
  name: garage
  namespace: tearleads
spec:
  publishNotReadyAddresses: true
  selector:
    app: garage
  ports:
    - port: 3900
      targetPort: 3900
      name: s3
    - port: 3901
      targetPort: 3901
      name: rpc
    - port: 3902
      targetPort: 3902
      name: web
    - port: 3903
      targetPort: 3903
      name: admin
---
apiVersion: batch/v1
kind: Job
metadata:
  name: garage-setup
  namespace: tearleads
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      initContainers:
        - name: wait-for-garage
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for Garage admin port to accept connections..."
              until wget -S -O /dev/null --timeout=2 http://garage:3903/health 2>&1 | grep -q "HTTP/"; do
                echo "Garage not ready, waiting..."
                sleep 2
              done
              echo "Garage admin port is reachable"
      containers:
        - name: setup
          image: busybox:1.36
          env:
            - name: GARAGE_ADMIN_TOKEN
              valueFrom:
                secretKeyRef:
                  name: tearleads-secrets
                  key: GARAGE_ADMIN_TOKEN
            - name: VFS_BLOB_S3_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: tearleads-secrets
                  key: VFS_BLOB_S3_ACCESS_KEY_ID
            - name: VFS_BLOB_S3_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: tearleads-secrets
                  key: VFS_BLOB_S3_SECRET_ACCESS_KEY
          command:
            - sh
            - -c
            - |
              set -e
              ADMIN="http://garage:3903"
              AUTH="Authorization: Bearer $GARAGE_ADMIN_TOKEN"

              # Best-effort helper: succeed even if the call returns an HTTP error
              api_post_ok() {
                local path="$1" body="$2"
                wget -q -O - --header="$AUTH" --header="Content-Type: application/json" \
                  --post-data="$body" "$ADMIN$path" 2>&1 || true
              }

              # Get node ID from cluster status
              STATUS=$(wget -q -O - --header="$AUTH" "$ADMIN/v2/GetClusterStatus")
              NODE_ID=$(echo "$STATUS" | sed -n 's/.*"nodes":\[{"id":"\([^"]*\)".*/\1/p')
              echo "Node ID: $NODE_ID"

              # Assign layout to node (1GB, zone dc1) — idempotent
              echo "Assigning layout..."
              api_post_ok "/v2/UpdateClusterLayout" \
                "{\"roles\":[{\"id\":\"$NODE_ID\",\"zone\":\"dc1\",\"capacity\":1000000000,\"tags\":[]}]}"

              # Apply layout — may fail if already applied at this version
              echo "Applying layout..."
              api_post_ok "/v2/ApplyClusterLayout" '{"version":1}'

              # Import access key — idempotent (re-imports existing GK-format key)
              echo "Importing access key..."
              api_post_ok "/v2/ImportKey" \
                "{\"accessKeyId\":\"$VFS_BLOB_S3_ACCESS_KEY_ID\",\"secretAccessKey\":\"$VFS_BLOB_S3_SECRET_ACCESS_KEY\",\"name\":\"vfs-blob-key\"}"
              echo ""

              # Create bucket — idempotent (returns existing bucket)
              echo "Creating bucket..."
              BUCKET_RESP=$(api_post_ok "/v2/CreateBucket" '{"globalAlias":"vfs-blobs"}')
              BUCKET_ID=$(echo "$BUCKET_RESP" | sed -n 's/.*"id":"\([^"]*\)".*/\1/p')
              echo "Bucket ID: $BUCKET_ID"

              # Grant permissions
              if [ -n "$BUCKET_ID" ]; then
                echo "Granting bucket permissions..."
                api_post_ok "/v2/AllowBucketKey" \
                  "{\"bucketId\":\"$BUCKET_ID\",\"accessKeyId\":\"$VFS_BLOB_S3_ACCESS_KEY_ID\",\"permissions\":{\"read\":true,\"write\":true,\"owner\":true}}"
              fi

              echo "Garage setup complete"
      volumes:
        - name: config
          configMap:
            name: garage-config
