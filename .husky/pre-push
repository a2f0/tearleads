set -e

./scripts/checkBinaryFiles.sh --from-upstream

pnpm lint
pnpm lint:scripts
pnpm lint:md
pnpm exec tsc -b
pnpm build

if ! command -v bundle >/dev/null 2>&1; then
  echo "Error: bundle is not installed. Please install Ruby and Bundler." >&2
  exit 1
fi
pnpm lint:rubocop

if ! command -v ansible-lint >/dev/null 2>&1; then
  echo "Error: ansible-lint is not installed. Run: pipx install ansible-lint && pipx inject ansible-lint ansible" >&2
  exit 1
fi
pnpm lint:ansible

# Run tests with coverage thresholds
pnpm --filter @tearleads/shared test:coverage
pnpm --filter @tearleads/ui test:coverage
pnpm --filter @tearleads/api test:coverage
pnpm --filter @tearleads/client test:coverage
pnpm --filter @tearleads/chrome-extension test:coverage
pnpm --filter @tearleads/website test:coverage
