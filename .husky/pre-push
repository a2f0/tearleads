#!/usr/bin/env sh
set -eu

LOCK_DIR="${TMPDIR:-/tmp}/tearleads-pre-push.lock"

release_lock() {
  if [ -d "$LOCK_DIR" ] && [ -f "$LOCK_DIR/pid" ]; then
    lock_pid="$(cat "$LOCK_DIR/pid" 2>/dev/null || true)"
    if [ "$lock_pid" = "$$" ]; then
      rm -rf "$LOCK_DIR"
    fi
  fi
}

acquire_lock() {
  wait_step_seconds=2
  wait_log_interval_seconds=30
  waited_since_log=0
  total_waited=0
  while ! mkdir "$LOCK_DIR" 2>/dev/null; do
    if [ -f "$LOCK_DIR/pid" ]; then
      lock_pid="$(cat "$LOCK_DIR/pid" 2>/dev/null || true)"
      if [ -n "$lock_pid" ] && ! kill -0 "$lock_pid" 2>/dev/null; then
        rm -rf "$LOCK_DIR"
        continue
      fi
    fi
    if [ "$waited_since_log" -eq 0 ]; then
      echo "[pre-push] WAIT  another pre-push is active; waiting..." >&2
    elif [ "$waited_since_log" -ge "$wait_log_interval_seconds" ]; then
      echo "[pre-push] WAIT  still waiting for lock (${total_waited}s elapsed)" >&2
      waited_since_log=0
    fi
    sleep "$wait_step_seconds"
    waited_since_log=$((waited_since_log + wait_step_seconds))
    total_waited=$((total_waited + wait_step_seconds))
  done
  printf '%s\n' "$$" > "$LOCK_DIR/pid"
}

trap 'release_lock' EXIT INT TERM HUP
acquire_lock

run_step() (
  label="$1"
  shift

  start=$(date +%s)
  echo "[pre-push] START ${label}" >&2

  set +e
  "$@"
  status=$?
  set -e

  end=$(date +%s)
  elapsed=$((end - start))

  if [ "$status" -ne 0 ]; then
    echo "[pre-push] FAIL  ${label} (${elapsed}s, exit ${status})" >&2
    exit "$status"
  fi

  echo "[pre-push] OK    ${label} (${elapsed}s)" >&2
)

run_step "checkNodeVersion" ./scripts/checks/checkNodeVersion.sh
run_step "checkFileLimits" ./scripts/checks/checkFileLimits.sh --from-upstream
run_step "checkSentinelMarkdownLinks" ./scripts/checks/checkSentinelMarkdownLinks.sh --all
run_step "checkBinaryFiles" ./scripts/checks/checkBinaryFiles.sh --from-upstream
run_step "checkJs" ./scripts/checks/checkJs.sh --from-upstream
run_step "checkFileNames" ./scripts/checks/checkFileNames.sh --from-upstream
run_step "checkClientBoundary" ./scripts/checks/checkClientBoundary.sh --from-upstream
run_step "checkApiBoundary" ./scripts/checks/checkApiBoundary.sh --from-upstream
run_step "checkPreenEcosystem" ./scripts/checks/preen/checkPreenEcosystem.ts --strict
run_step "checkCircularImports" ./scripts/checks/checkCircularImports.ts
run_step "checkTailwindSources" ./scripts/checks/checkTailwindSources.ts
run_step "checkGitHubActions" ./scripts/checks/checkGithubActions.sh --from-upstream
run_step "checkTerraform" ./scripts/checks/checkTerraform.sh
run_step "typecheckSolutionBuild" pnpm exec tsc -b
run_step "enforceTypeScriptIncrementalBuilds" pnpm enforceTypeScriptIncrementalBuilds
run_step "runImpactedQuality" pnpm exec tsx scripts/ciImpact/runImpactedQuality.ts --base origin/main --head HEAD
# Run impacted package coverage tests with conservative full-run fallback.
run_step "runImpactedTests" pnpm exec tsx scripts/ciImpact/runImpactedTests.ts --base origin/main --head HEAD
