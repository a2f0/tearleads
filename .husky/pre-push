set -e

# Initialize version managers (rbenv, pyenv, nvm) for non-interactive shells
. "$(dirname "$0")/../scripts/init-env.sh"

pnpm lint
pnpm lint:scripts
pnpm lint:md
pnpm exec tsc -b
pnpm build

if ! command -v bundle >/dev/null 2>&1; then
  echo "Error: bundle is not installed. Please install Ruby and Bundler." >&2
  exit 1
fi
pnpm lint:rubocop

if ! command -v ansible-lint >/dev/null 2>&1; then
  echo "Error: ansible-lint is not installed. Run: pipx install ansible-lint && pipx inject ansible-lint ansible" >&2
  exit 1
fi
pnpm lint:ansible

# Run shell tests (skip if bats not installed)
if command -v bats >/dev/null 2>&1; then
  pnpm test:shell
else
  echo "Note: bats not installed, skipping shell tests. Install with: brew install bats-core"
fi

# Run tests with coverage thresholds
pnpm --filter @rapid/shared test:coverage
pnpm --filter @rapid/ui test:coverage
pnpm --filter @rapid/api test:coverage
pnpm --filter @rapid/client test:coverage
pnpm --filter @rapid/chrome-extension test:coverage
pnpm --filter @rapid/website test:coverage
