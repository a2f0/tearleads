#!/usr/bin/env sh
set -eu

run_step() (
  label="$1"
  shift

  start=$(date +%s)
  echo "[pre-push] START ${label}" >&2

  set +e
  "$@"
  status=$?
  set -e

  end=$(date +%s)
  elapsed=$((end - start))

  if [ "$status" -ne 0 ]; then
    echo "[pre-push] FAIL  ${label} (${elapsed}s, exit ${status})" >&2
    exit "$status"
  fi

  echo "[pre-push] OK    ${label} (${elapsed}s)" >&2
)

run_step "checkNodeVersion" ./scripts/checkNodeVersion.sh
run_step "checkFileLimits" ./scripts/preen/checkFileLimits.sh --from-upstream
run_step "checkSentinelMarkdownLinks" ./scripts/preen/checkSentinelMarkdownLinks.sh --all
run_step "checkBinaryFiles" ./scripts/checkBinaryFiles.sh --from-upstream
run_step "checkJs" ./scripts/preen/checkJs.sh --from-upstream
run_step "checkClientBoundary" ./scripts/preen/checkClientBoundary.sh --from-upstream
run_step "checkPreenEcosystem" ./scripts/checkPreenEcosystem.sh --strict
run_step "checkCircularImports" ./scripts/preen/checkCircularImports.ts
run_step "checkGitHubActions" ./scripts/checkGithubActions.sh --from-upstream
run_step "checkTerraform" ./scripts/checkTerraform.sh
run_step "typecheckSolutionBuild" pnpm exec tsc -b
run_step "enforceTypeScriptIncrementalBuilds" pnpm enforceTypeScriptIncrementalBuilds
run_step "runImpactedQuality" pnpm exec tsx scripts/ciImpact/runImpactedQuality.ts --base origin/main --head HEAD
# Run impacted package coverage tests with conservative full-run fallback.
run_step "runImpactedTests" pnpm exec tsx scripts/ciImpact/runImpactedTests.ts --base origin/main --head HEAD
