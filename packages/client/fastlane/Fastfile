default_platform(:ios)

platform :ios do
  desc "Build debug iOS app"
  lane :build_debug do
    build_app(
      workspace: "./ios/App/App.xcworkspace",
      scheme: "App",
      configuration: "Debug",
      export_method: "development",
      skip_codesigning: true,
      skip_archive: true,
      destination: "generic/platform=iOS Simulator"
    )
  end

  desc "Build release iOS app"
  lane :build_release do
    build_app(
      workspace: "./ios/App/App.xcworkspace",
      scheme: "App",
      configuration: "Release",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "Rapid.ipa"
    )
  end

  desc "Run iOS tests"
  lane :test do
    run_tests(
      workspace: "./ios/App/App.xcworkspace",
      scheme: "App",
      devices: ["iPhone 15"],
      clean: true
    )
  end

  desc "Deploy to TestFlight"
  lane :deploy_testflight do
    build_release
    upload_to_testflight(
      skip_waiting_for_build_processing: true
    )
  end

  desc "Promote TestFlight build to App Store"
  lane :promote_to_production do
    deliver(
      skip_binary_upload: true,
      skip_screenshots: true,
      skip_metadata: true,
      submit_for_review: true,
      automatic_release: false
    )
  end

  desc "Sync certificates and provisioning profiles"
  lane :sync_certs do
    match(type: "development")
    match(type: "appstore")
  end

  desc "Register new device"
  lane :add_device do |options|
    device_name = options[:name]
    device_udid = options[:udid]
    register_devices(
      devices: {
        device_name => device_udid
      }
    )
    match(type: "development", force_for_new_devices: true)
  end

  desc "Increment build number"
  lane :bump_build do
    increment_build_number(
      xcodeproj: "./ios/App/App.xcodeproj"
    )
  end

  desc "Increment version number"
  lane :bump_version do |options|
    increment_version_number(
      xcodeproj: "./ios/App/App.xcodeproj",
      bump_type: options[:type] || "patch"
    )
  end

  desc "Clean build artifacts"
  lane :clean do
    clear_derived_data
  end
end

platform :android do
  desc "Build debug APK"
  lane :build_debug do
    run_gradle(task: "assembleDebug")
  end

  desc "Build release APK"
  lane :build_release do
    run_gradle(task: "assembleRelease")
  end

  desc "Build release AAB for Play Store"
  lane :build_aab do
    run_gradle(task: "bundleRelease")
  end

  desc "Build and deploy to Play Store internal track"
  lane :deploy_internal do
    build_aab
    upload_to_play_store(
      track: "internal",
      aab: "android/app/build/outputs/bundle/release/app-release.aab",
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
  end

  desc "Promote internal to beta"
  lane :promote_to_beta do
    upload_to_play_store(
      track: "internal",
      track_promote_to: "beta",
      skip_upload_changelogs: true
    )
  end

  desc "Promote beta to production"
  lane :promote_to_production do
    upload_to_play_store(
      track: "beta",
      track_promote_to: "production",
      skip_upload_changelogs: true
    )
  end

  desc "Run Android unit tests"
  lane :test do
    run_gradle(task: "test")
  end

  desc "Run Android instrumented tests (requires device/emulator)"
  lane :test_instrumented do
    run_gradle(task: "connectedAndroidTest")
  end

  desc "Clean build artifacts"
  lane :clean do
    run_gradle(task: "clean")
  end

  private_lane :run_gradle do |options|
    gradle(
      project_dir: "./android",
      task: options[:task]
    )
  end
end
