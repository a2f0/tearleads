appId: com.tearleads.rapid
env:
  PASSWORD_1: 'orphantest123'
---
# Orphan Cleanup Test - Verifies the app handles orphaned registry entries
#
# This test verifies that:
# 1. When an instance exists in the registry but has no valid setup (no salt/KCV),
#    it gets cleaned up during app initialization
# 2. The app creates a fresh instance when all instances are orphaned
# 3. The HUD shows warning logs about pruned orphans
#
# Note: This test cannot fully simulate Android Keystore orphans (which survive app
# uninstall) because Maestro's clearState also clears IndexedDB. However, it tests
# the registry orphan detection which uses the same cleanup mechanism.

- launchApp:
    clearState: true

- assertVisible: "Tearleads"

# Load shared database helper functions
- runFlow: helpers/db-helpers.yaml

# Navigate to SQLite page
- evalScript: document.querySelector('[data-testid="sqlite-link"]').click()

# Wait for SQLite page to load
- evalScript: window.waitFor(() => document.querySelector('[data-testid="database-test"]'), 'Database Test component not found')

# Reset database to ensure clean state
- evalScript: document.querySelector('[data-testid="db-reset-button"]').click()

# Wait for reset to complete
- evalScript: window.waitForResult('success')

# Verify database is in "Not Set Up" state
- evalScript: window.waitForStatus('Not Set Up')

# Setup first instance
- evalScript: window.setPassword('${PASSWORD_1}')
- evalScript: document.querySelector('[data-testid="db-setup-button"]').click()
- evalScript: window.waitForResult('success')
- evalScript: window.waitForStatus('Unlocked')

# Write test data to verify this instance is real
- evalScript: document.querySelector('[data-testid="db-write-button"]').click()
- evalScript: window.waitForResult('success', 'Wrote test data:')

# Create a second instance (this one will remain not set up)
- evalScript: |
    const switcher = document.querySelector('[data-testid="account-switcher-button"]');
    if (!switcher) throw new Error('Account switcher button not found');
    switcher.click();
    return 'ok';

# Wait for dropdown and click create
- evalScript: |
    window.waitFor(
      () => document.querySelector('[data-testid="create-instance-button"]'),
      'Create instance button not found'
    )

- evalScript: document.querySelector('[data-testid="create-instance-button"]').click()

# Wait for new instance - should be not set up
- evalScript: window.waitForStatus('Not Set Up')

# DON'T set up the second instance - this creates an "orphaned" registry entry
# (registry entry exists but no salt/KCV)

# Verify we now have 2 instances
- evalScript: |
    const switcher = document.querySelector('[data-testid="account-switcher-button"]');
    switcher.click();
    return 'ok';

- evalScript: |
    window.waitFor(
      () => {
        const instances = document.querySelectorAll('[data-testid^="instance-"]:not([data-testid*="unlocked"]):not([data-testid*="locked"]):not([data-testid*="delete"])');
        return instances.length === 2;
      },
      'Expected 2 instances'
    )

# Close the dropdown by clicking elsewhere
- evalScript: document.body.click()

# Now restart the app WITHOUT clearing state
# This simulates the orphan detection on app startup
- stopApp

- launchApp:
    clearState: false

- assertVisible: "Tearleads"

# Re-load helper functions
- runFlow: helpers/db-helpers.yaml

# Navigate to SQLite page
- evalScript: document.querySelector('[data-testid="sqlite-link"]').click()

# Wait for SQLite page to load
- evalScript: window.waitFor(() => document.querySelector('[data-testid="database-test"]'), 'Database Test component not found after relaunch')

# The app should have pruned the orphaned instance (the one without setup)
# and we should be on the first instance which was set up

# Wait for status to stabilize - should be either "Locked" or "Unlocked"
# (depending on session persistence)
- evalScript: |
    window.waitFor(
      () => {
        const status = document.querySelector('[data-testid="db-status"]');
        return status && (status.textContent === 'Locked' || status.textContent === 'Unlocked');
      },
      'Status should be Locked or Unlocked (not "Not Set Up")'
    )

# If locked, unlock it
- evalScript: |
    const status = document.querySelector('[data-testid="db-status"]');
    if (status.textContent === 'Locked') {
      window.setPassword('${PASSWORD_1}');
      document.querySelector('[data-testid="db-unlock-button"]').click();
    }
    return 'ok';

- evalScript: window.waitForStatus('Unlocked')

# Verify we can read the data we wrote earlier
- evalScript: document.querySelector('[data-testid="db-read-button"]').click()
- evalScript: window.waitForResult('success', 'Read test data:')

# Verify the orphaned instance was cleaned up - we should only have 1 instance now
- evalScript: |
    const switcher = document.querySelector('[data-testid="account-switcher-button"]');
    switcher.click();
    return 'ok';

- evalScript: |
    window.waitFor(
      () => {
        const instances = document.querySelectorAll('[data-testid^="instance-"]:not([data-testid*="unlocked"]):not([data-testid*="locked"]):not([data-testid*="delete"])');
        // Should be 1 instance (the orphaned one was pruned)
        if (instances.length !== 1) {
          throw new Error('Expected 1 instance after orphan cleanup, got ' + instances.length);
        }
        return true;
      },
      'Orphan cleanup did not remove the orphaned instance'
    )

# Check the HUD for the warning log about pruned orphans
# First close the dropdown
- evalScript: document.body.click()

# Open the HUD to check logs
- evalScript: |
    const hudTrigger = document.querySelector('[data-testid="hud-trigger"]');
    if (hudTrigger) {
      hudTrigger.click();
    }
    return 'ok';

# Look for warning about pruned orphans in the logs tab
# The log should contain "Pruned" and "orphaned"
# Note: The warning log might not be visible if cleanup happened before HUD was ready.
# The main test assertion is that the orphan was cleaned up (verified above).
# This step just clicks the logs tab to visually confirm if the warning is there.
- evalScript: |
    // Click logs tab if it exists
    const logsTab = document.querySelector('[data-testid="hud-logs-tab"]');
    if (logsTab) logsTab.click();
    return 'ok';

# Final cleanup
- evalScript: document.querySelector('[data-testid="db-reset-button"]')?.click() || 'ok'
