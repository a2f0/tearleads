appId: com.tearleads.rapid
---
- launchApp:
    clearState: true

- assertVisible: "Tearleads"

# Navigate to settings with mobile/desktop handling
- evalScript: |
    (async () => {
      const waitFor = async (predicate, errorMessage, timeout = 8000) => {
        const interval = 200;
        const maxTries = Math.ceil(timeout / interval);
        for (let i = 0; i < maxTries; i++) {
          if (predicate()) return 'ok';
          await new Promise(r => setTimeout(r, interval));
        }
        throw new Error(errorMessage);
      };
      const isVisible = (el) =>
        !!(el && (el.getClientRects().length || el.offsetParent));

      const mobileButton = document.querySelector(
        '[data-testid="mobile-menu-button"]'
      );
      if (isVisible(mobileButton)) {
        mobileButton.click();
        await waitFor(
          () => document.querySelector('[data-testid="mobile-menu-dropdown"]'),
          'Mobile menu dropdown not found'
        );
        const mobileLink = document.querySelector(
          '[data-testid="mobile-menu-dropdown"] [data-testid="settings-link"]'
        );
        if (!mobileLink) {
          throw new Error('Settings link not found in mobile menu');
        }
        mobileLink.scrollIntoView({ block: 'center' });
        await new Promise(r => setTimeout(r, 100));
        mobileLink.click();
        return 'clicked-mobile';
      }

      const sidebarLink = document.querySelector(
        'aside [data-testid="settings-link"]'
      );
      if (!sidebarLink) {
        throw new Error('Settings link not found in sidebar');
      }
      sidebarLink.scrollIntoView({ block: 'center' });
      await new Promise(r => setTimeout(r, 100));
      sidebarLink.click();
      return 'clicked-sidebar';
    })()

# Wait for Settings page to load (WebView-friendly)
- evalScript: |
    (async () => {
      const waitFor = async (predicate, errorMessage, timeout = 10000) => {
        const interval = 200;
        const maxTries = Math.ceil(timeout / interval);
        for (let i = 0; i < maxTries; i++) {
          if (predicate()) return 'ok';
          await new Promise(r => setTimeout(r, interval));
        }
        throw new Error(errorMessage);
      };
      return waitFor(
        () => document.querySelector('[data-testid="theme-selector-grid"]'),
        'Settings page did not render theme selector'
      );
    })()

# Tap the dark theme option (starts in light mode by default)
- evalScript: document.querySelector('[data-testid="theme-option-dark"]').click()

# Poll until dark mode is applied
- evalScript: |
    (async () => {
      for (let i = 0; i < 30; i++) {
        if (document.documentElement.classList.contains('dark')) {
          return 'ok';
        }
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      throw new Error('Expected dark mode');
    })()

# Tap light theme option to switch back to light
- evalScript: document.querySelector('[data-testid="theme-option-light"]').click()

# Poll until light mode is applied
- evalScript: |
    (async () => {
      for (let i = 0; i < 30; i++) {
        if (!document.documentElement.classList.contains('dark')) {
          return 'ok';
        }
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      throw new Error('Expected light mode');
    })()
