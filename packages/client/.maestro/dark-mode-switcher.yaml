appId: com.tearleads.app
androidWebViewHierarchy: devtools
---
- launchApp:
    clearState: true

- assertVisible: "Tearleads"

- # Stabilize initial render
- extendedWaitUntil:
    visible: "Files"
    timeout: 8000
    optional: true

# Load shared UI helper functions
- runFlow: helpers/ui-helpers.yaml

# Navigate to settings with mobile/desktop handling
- evalScript: |
    (async () => {
      const isAndroid = /Android/i.test(navigator.userAgent);
      if (isAndroid) {
        let homeSettings = null;
        try {
          await window.waitForElement('[data-icon-path="/settings"]', 6000);
          homeSettings = document.querySelector(
            '[data-icon-path="/settings"]'
          );
        } catch (error) {
          // Fall back to history navigation if the home icon is missing.
        }
        if (homeSettings) {
          homeSettings.click();
          return 'clicked-android-home-settings';
        }
        window.history.pushState({}, '', '/settings');
        window.dispatchEvent(new PopStateEvent('popstate'));
        return 'navigated-android';
      }

      const settingsButton = document.querySelector(
        '[data-testid="settings-button"]'
      );
      if (settingsButton && settingsButton.offsetParent !== null) {
        settingsButton.click();
        try {
          await window.waitForElement('[data-testid="settings-sheet"]', 1500);
          return 'opened-settings-sheet';
        } catch (error) {
          // Fall back to sidebar navigation if SettingsSheet isn't available.
        }
      }

      const mobileButton = document.querySelector(
        '[data-testid="mobile-menu-button"]'
      );
      if (mobileButton && mobileButton.offsetParent !== null) {
        mobileButton.click();
        await window.waitForElement('[data-testid="mobile-menu-dropdown"]');
        const mobileLink = document.querySelector(
          '[data-testid="mobile-menu-dropdown"] [data-testid="settings-link"]'
        );
        if (!mobileLink) {
          throw new Error('Settings link not found in mobile menu');
        }
        mobileLink.scrollIntoView({ block: 'center' });
        mobileLink.click();
        return 'clicked-mobile';
      }

      let sidebarLink = document.querySelector(
        'aside [data-testid="settings-link"]'
      );
      if (!sidebarLink) {
        const startButton = document.querySelector(
          '[data-testid="start-button"]'
        );
        if (startButton) {
          startButton.click();
          await window.waitForElement('aside [data-testid="settings-link"]');
          sidebarLink = document.querySelector(
            'aside [data-testid="settings-link"]'
          );
        }
      }
      if (sidebarLink) {
        sidebarLink.scrollIntoView({ block: 'center' });
        sidebarLink.click();
        return 'clicked-sidebar';
      }

      const homeSettings = document.querySelector(
        '[data-icon-path="/settings"]'
      );
      if (homeSettings) {
        homeSettings.scrollIntoView({ block: 'center' });
        homeSettings.click();
        return 'clicked-home-settings';
      }

      throw new Error('Settings navigation failed');
    })()

# Wait for Settings page/sheet to load (WebView-friendly)
- evalScript: |
    (async () => {
      return window.waitForElement(
        '[data-testid="theme-selector-container"]',
        10000
      );
    })()

# Tap the dark theme option (starts in light mode by default)
- evalScript: |
    (async () => {
      await new Promise((r) => setTimeout(r, 250));
      const option = document.querySelector('[data-testid="theme-option-dark"]');
      if (!option) throw new Error('Dark theme option not found');
      option.scrollIntoView({ block: 'center', inline: 'center' });
      option.click();
    })()

# Poll until dark option is selected
- evalScript: |
    (async () => {
      return window.waitForAttribute(
        '[data-testid="theme-option-dark"]',
        'aria-pressed',
        'true',
        3000
      );
    })()

# Tap light theme option to switch back to light
- evalScript: |
    (async () => {
      await new Promise((r) => setTimeout(r, 250));
      const option = document.querySelector(
        '[data-testid="theme-option-light"]'
      );
      if (!option) throw new Error('Light theme option not found');
      option.scrollIntoView({ block: 'center', inline: 'center' });
      option.click();
    })()

# Poll until light option is selected
- evalScript: |
    (async () => {
      return window.waitForAttribute(
        '[data-testid="theme-option-light"]',
        'aria-pressed',
        'true',
        3000
      );
    })()
