appId: com.tearleads.rapid
---
- launchApp:
    clearState: true

- assertVisible: "Tearleads"

# Navigate to settings - check if sidebar is visible, use mobile menu if not
- evalScript: |
    (async () => {
      const sidebar = document.querySelector('aside');
      const sidebarDisplay = sidebar ? getComputedStyle(sidebar).display : 'no-sidebar';
      const isSidebarVisible = sidebar && sidebarDisplay !== 'none';
      console.log('Sidebar visibility:', sidebarDisplay, 'visible:', isSidebarVisible);

      if (isSidebarVisible) {
        const link = document.querySelector('aside [data-testid="settings-link"]');
        if (link) {
          link.scrollIntoView({ behavior: 'instant', block: 'center' });
          link.click();
          return 'sidebar-clicked';
        }
        return 'sidebar-visible-but-no-link';
      }

      const menuButton = document.querySelector('[data-testid="mobile-menu-button"]');
      console.log('Menu button found:', !!menuButton);
      if (!menuButton) {
        return 'no-menu-button';
      }

      menuButton.click();
      console.log('Clicked menu button');

      for (let i = 0; i < 30; i++) {
        await new Promise(r => setTimeout(r, 100));
        const dropdown = document.querySelector('[data-testid="mobile-menu-dropdown"]');
        if (dropdown) {
          console.log('Dropdown found at iteration', i);
          const link = dropdown.querySelector('[data-testid="settings-link"]');
          if (link) {
            console.log('Settings link found, clicking...');
            link.click();
            return 'mobile-clicked';
          }
          return 'dropdown-no-link';
        }
      }
      return 'dropdown-never-appeared';
    })()

# Wait for Settings page to load
- extendedWaitUntil:
    visible: "Settings"
    timeout: 10000

# Tap the dark mode switch (starts in light mode by default)
- evalScript: document.querySelector('[data-testid="dark-mode-switch"]').click()

# Poll until dark mode is applied
- evalScript: |
    (async () => {
      for (let i = 0; i < 30; i++) {
        if (document.documentElement.classList.contains('dark')) {
          return 'ok';
        }
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      throw new Error('Expected dark mode');
    })()

# Tap again to switch back to light
- evalScript: document.querySelector('[data-testid="dark-mode-switch"]').click()

# Poll until light mode is applied
- evalScript: |
    (async () => {
      for (let i = 0; i < 30; i++) {
        if (!document.documentElement.classList.contains('dark')) {
          return 'ok';
        }
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      throw new Error('Expected light mode');
    })()
