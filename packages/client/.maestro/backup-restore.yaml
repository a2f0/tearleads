appId: com.tearleads.rapid
---
# Backup & Restore Test - Tests database backup and restore UI on native platforms
# Note: Full file picker interaction is limited in Maestro, so this focuses on UI flows

- launchApp:
    clearState: true

- assertVisible: "Tearleads"

# Load shared database helper functions
- runFlow: helpers/db-helpers.yaml

# Navigate to SQLite page and setup database first
- evalScript: document.querySelector('[data-testid="sqlite-link"]').click()

# Wait for SQLite page to load
- evalScript: window.waitFor(() => document.querySelector('[data-testid="database-test"]'), 'Database Test component not found')

# Reset database to ensure clean state
- evalScript: document.querySelector('[data-testid="db-reset-button"]').click()

# Wait for reset to complete
- evalScript: window.waitForResult('success')

# Verify database is in "Not Set Up" state
- evalScript: window.waitForStatus('Not Set Up')

# Setup database with password
- evalScript: window.setPassword('testpassword123')
- evalScript: document.querySelector('[data-testid="db-setup-button"]').click()
- evalScript: window.waitForResult('success')
- evalScript: window.waitForStatus('Unlocked')

# Write some test data before testing backup
- evalScript: document.querySelector('[data-testid="db-write-button"]').click()
- evalScript: window.waitForResult('success', 'Wrote test data:')

# Store the written value for later verification
- evalScript: |
    (() => {
      const testData = document.querySelector('[data-testid="db-test-data"]');
      if (testData && /^test-value-\d+$/.test(testData.textContent)) {
        window.__backupTestValue = testData.textContent;
        return 'ok';
      }
      throw new Error('Expected test data, got: ' + (testData ? testData.textContent : 'null'));
    })()

# Navigate to Settings page
- evalScript: document.querySelector('[data-testid="settings-link"]').click()

# Wait for Settings page to load
- evalScript: |
    window.waitFor(
      () => document.querySelector('[data-testid="backup-export-button"]'),
      'Settings page with backup button not found'
    )

# Verify Backup & Restore section is visible
- evalScript: |
    (() => {
      const title = document.body.textContent.includes('Backup & Restore');
      const desc = document.body.textContent.includes('Export your encrypted database');
      if (!title || !desc) throw new Error('Backup section not found');
      return 'ok';
    })()

# Verify export button is present and enabled
- evalScript: |
    (() => {
      const btn = document.querySelector('[data-testid="backup-export-button"]');
      if (!btn) throw new Error('Export button not found');
      if (btn.disabled) throw new Error('Export button is disabled');
      if (!btn.textContent.includes('Create Backup')) throw new Error('Export button text incorrect');
      return 'ok';
    })()

# Verify restore section is visible
- evalScript: |
    (() => {
      const restoreLabel = document.body.textContent.includes('Restore from Backup');
      const dropzone = document.querySelector('[data-testid="dropzone-native"]') ||
                       document.querySelector('[data-testid="dropzone"]');
      if (!restoreLabel) throw new Error('Restore label not found');
      if (!dropzone) throw new Error('Dropzone not found');
      return 'ok';
    })()

# Click export button and verify loading state
- evalScript: |
    (() => {
      const btn = document.querySelector('[data-testid="backup-export-button"]');
      if (!btn) throw new Error('Export button not found');

      // Store initial state for comparison
      window.__exportBtnInitialText = btn.textContent;

      // Click the button
      btn.click();
      return 'ok';
    })()

# On mobile, this triggers the Share API which we can't fully test in Maestro
# but we can verify the button works and doesn't throw errors
# Wait a moment for any errors to surface
- evalScript: |
    window.waitFor(
      () => {
        // Check that no error message appeared
        const error = document.querySelector('.bg-destructive\\/10');
        if (error && error.textContent.includes('failed')) {
          throw new Error('Export failed: ' + error.textContent);
        }
        // Button should be enabled again after export completes
        const btn = document.querySelector('[data-testid="backup-export-button"]');
        return btn && !btn.disabled;
      },
      'Export did not complete successfully',
      15000
    )

# Verify export button is back to normal state
- evalScript: |
    (() => {
      const btn = document.querySelector('[data-testid="backup-export-button"]');
      if (!btn) throw new Error('Export button not found after export');
      if (btn.disabled) throw new Error('Export button still disabled after export');
      // Button text should contain "Create Backup" (not "Exporting...")
      if (!btn.textContent.includes('Create Backup')) {
        throw new Error('Export button text not reset: ' + btn.textContent);
      }
      return 'ok';
    })()

# Navigate back to debug to verify database is still intact after export
- evalScript: document.querySelector('[data-testid="sqlite-link"]').click()

# Wait for SQLite page to load
- evalScript: window.waitFor(() => document.querySelector('[data-testid="database-test"]'), 'Database Test component not found')

# Verify database is still unlocked
- evalScript: window.waitForStatus('Unlocked')

# Read data to verify export didn't corrupt anything
- evalScript: document.querySelector('[data-testid="db-read-button"]').click()
- evalScript: window.waitForResult('success', 'Read test data:')

# Verify the data matches what we wrote earlier
- evalScript: |
    (() => {
      const testData = document.querySelector('[data-testid="db-test-data"]');
      if (!testData || testData.textContent !== window.__backupTestValue) {
        throw new Error('Data mismatch after export. Expected: ' + window.__backupTestValue + ', got: ' + (testData ? testData.textContent : 'null'));
      }
      return 'ok';
    })()

# Navigate back to Settings to test restore UI elements
- evalScript: document.querySelector('[data-testid="settings-link"]').click()

# Wait for Settings page
- evalScript: |
    window.waitFor(
      () => document.querySelector('[data-testid="backup-export-button"]'),
      'Settings page with backup button not found'
    )

# Verify the "Choose Files" button is visible on native (Dropzone renders differently)
- evalScript: |
    (() => {
      const nativeDropzone = document.querySelector('[data-testid="dropzone-native"]');
      const chooseFilesBtn = document.querySelector('[data-testid="dropzone-choose-files"]');
      if (nativeDropzone && chooseFilesBtn) {
        return 'ok';
      }
      // On web, dropzone is different
      const webDropzone = document.querySelector('[data-testid="dropzone"]');
      if (webDropzone) {
        return 'ok';
      }
      throw new Error('Neither native nor web dropzone found');
    })()

# Test that export is disabled when database is locked
# First, lock the database
- evalScript: document.querySelector('[data-testid="sqlite-link"]').click()
- evalScript: window.waitFor(() => document.querySelector('[data-testid="database-test"]'), 'Database Test component not found')

# Setup database again since we're in a fresh state after previous tests
- evalScript: |
    (() => {
      const status = document.querySelector('[data-testid="db-status"]');
      if (status && status.textContent === 'Not Set Up') {
        window.setPassword('testpassword123');
        document.querySelector('[data-testid="db-setup-button"]').click();
      }
      return 'ok';
    })()
- evalScript: window.waitForStatus('Unlocked')

# Lock the database
- evalScript: document.querySelector('[data-testid="db-lock-button"]').click()
- evalScript: window.waitForStatus('Locked')

# Navigate to settings
- evalScript: document.querySelector('[data-testid="settings-link"]').click()
- evalScript: |
    window.waitFor(
      () => document.querySelector('[data-testid="backup-export-button"]'),
      'Settings page with backup button not found'
    )

# Verify export button is disabled when database is locked
- evalScript: |
    (() => {
      const btn = document.querySelector('[data-testid="backup-export-button"]');
      if (!btn) throw new Error('Export button not found');
      if (!btn.disabled) throw new Error('Export button should be disabled when database is locked');
      return 'ok';
    })()

# Navigate back to debug and unlock
- evalScript: document.querySelector('[data-testid="sqlite-link"]').click()
- evalScript: window.waitFor(() => document.querySelector('[data-testid="database-test"]'), 'Database Test component not found')
- evalScript: window.setPassword('testpassword123')
- evalScript: document.querySelector('[data-testid="db-unlock-button"]').click()
- evalScript: window.waitForStatus('Unlocked')

# Verify export is enabled again after unlock
- evalScript: document.querySelector('[data-testid="settings-link"]').click()
- evalScript: |
    window.waitFor(
      () => document.querySelector('[data-testid="backup-export-button"]'),
      'Settings page with backup button not found'
    )
- evalScript: |
    (() => {
      const btn = document.querySelector('[data-testid="backup-export-button"]');
      if (!btn) throw new Error('Export button not found');
      if (btn.disabled) throw new Error('Export button should be enabled when database is unlocked');
      return 'ok';
    })()

# Clean up - reset database
- evalScript: document.querySelector('[data-testid="sqlite-link"]').click()
- evalScript: window.waitFor(() => document.querySelector('[data-testid="database-test"]'), 'Database Test component not found')
- evalScript: document.querySelector('[data-testid="db-reset-button"]').click()
- evalScript: window.waitForStatus('Not Set Up')
