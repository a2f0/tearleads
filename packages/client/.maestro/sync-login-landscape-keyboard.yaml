appId: com.tearleads.app
---
# Test: Sync login form accessibility in landscape mode with keyboard open
# Run with: maestro test .maestro/sync-login-landscape-keyboard.yaml

- launchApp:
    clearState: true

- assertVisible: "Tearleads"

# Wait for home to load and settle (extended timeout for CI environments under load)
- extendedWaitUntil:
    visible: "Files"
    timeout: 120000
    optional: true

# CI can intermittently stall after first launch; retry once with a warm relaunch.
- runFlow:
    when:
      notVisible: "Files"
    commands:
      - stopApp
      - launchApp:
          clearState: false
      - extendedWaitUntil:
          visible: "Files"
          timeout: 120000

# Navigate to Sync page using Maestro native swipe and tap
# IMPORTANT: JavaScript navigation (window.location.href, Link.click()) does NOT work
# reliably in Maestro's evalScript on Android API 33+. Use native Maestro commands instead.
# Swipe up to reveal more icons (Sync is near the bottom of the icon grid)
- swipe:
    start: 50%, 80%
    end: 50%, 30%

# Wait for swipe animation
- extendedWaitUntil:
    visible: "Sync"
    timeout: 3000
    optional: true

# Try tapping on Sync icon
- tapOn:
    text: "Sync"
    optional: true

# If Sync not found, swipe again
- swipe:
    start: 50%, 80%
    end: 50%, 20%
    optional: true

# Try tapping again
- tapOn:
    text: "Sync"
    optional: true

# Wait for the login form
- extendedWaitUntil:
    visible: "Email"
    timeout: 20000

# Debug: Log viewport before keyboard
- evalScript: |
    (() => {
      const vv = window.visualViewport;
      return 'Before keyboard - visualViewport.height: ' + (vv ? vv.height : 'N/A') + ', innerHeight: ' + window.innerHeight;
    })()

# Focus email input using Maestro tap
- tapOn:
    id: "email-input"
    optional: true

# Fallback: focus via JS if tap didn't work
- evalScript: |
    (() => {
      const emailInput = document.querySelector('input[type="email"]');
      if (emailInput) {
        emailInput.focus();
        emailInput.click();
        return 'focused email via JS';
      }
      throw new Error('Email input not found');
    })()

# Type in the email field - this triggers keyboard
- inputText: "test@example.com"

# Small delay to let keyboard appear
- extendedWaitUntil:
    visible: "Email"
    timeout: 3000
    optional: true

# Debug: Log viewport AFTER keyboard should be visible
- evalScript: |
    (() => {
      const vv = window.visualViewport;
      const appContainer = document.querySelector('[data-testid="app-container"]');
      const containerHeight = appContainer ? appContainer.getBoundingClientRect().height : 'N/A';
      const info = {
        visualViewportHeight: vv ? Math.round(vv.height) : 'N/A',
        innerHeight: window.innerHeight,
        containerHeight: containerHeight,
        documentHeight: document.documentElement.clientHeight
      };
      console.log('VIEWPORT_DEBUG_AFTER_KEYBOARD:', JSON.stringify(info));
      return 'After keyboard - ' + JSON.stringify(info);
    })()

# Try to focus password field
- evalScript: |
    (() => {
      const passwordInput = document.querySelector('input[type="password"]');
      if (!passwordInput) {
        throw new Error('Password input not found');
      }

      // Get position info before scrolling
      const rectBefore = passwordInput.getBoundingClientRect();
      const vv = window.visualViewport;
      const viewportHeight = vv ? vv.height : window.innerHeight;

      const beforeInfo = 'BEFORE scroll - rect.top=' + Math.round(rectBefore.top) +
        ', rect.bottom=' + Math.round(rectBefore.bottom) +
        ', viewportHeight=' + Math.round(viewportHeight);
      console.log(beforeInfo);

      // Scroll into view
      passwordInput.scrollIntoView({ behavior: 'instant', block: 'center' });
      passwordInput.focus();

      // Get position after scroll
      const rectAfter = passwordInput.getBoundingClientRect();
      const afterInfo = 'AFTER scroll - rect.top=' + Math.round(rectAfter.top) +
        ', rect.bottom=' + Math.round(rectAfter.bottom);
      console.log(afterInfo);

      return beforeInfo + ' | ' + afterInfo;
    })()

# Type in password field
- inputText: "testpassword"

# Final verification: is password field visible?
- evalScript: |
    (() => {
      const passwordInput = document.querySelector('input[type="password"]');
      if (!passwordInput) {
        throw new Error('Password input not found');
      }

      const rect = passwordInput.getBoundingClientRect();
      const vv = window.visualViewport;
      const viewportHeight = vv ? vv.height : window.innerHeight;

      const info = 'rect.top=' + Math.round(rect.top) +
        ', rect.bottom=' + Math.round(rect.bottom) +
        ', viewportHeight=' + Math.round(viewportHeight) +
        ', innerHeight=' + window.innerHeight;

      // Check if password field is visible in viewport
      if (rect.bottom > viewportHeight) {
        throw new Error('FAIL: Password field bottom (' + Math.round(rect.bottom) + ') is below viewport (' + Math.round(viewportHeight) + '): ' + info);
      }
      if (rect.top < 0) {
        throw new Error('FAIL: Password field top is above viewport: ' + info);
      }

      // Check if password field has value
      if (passwordInput.value !== 'testpassword') {
        throw new Error('Password field value incorrect: ' + passwordInput.value);
      }

      return 'SUCCESS - Password field visible and has correct value: ' + info;
    })()
