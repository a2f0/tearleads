appId: com.tearleads.rapid
env:
  INITIAL_PASSWORD: "testpassword123"
  NEW_PASSWORD: "newpassword456"
---
# Database Change Password Test - Verifies rekey flow and data persistence

- launchApp:
    clearState: true

- assertVisible: "Tearleads"

# Load shared database helper functions
- runFlow: helpers/db-helpers.yaml

# Navigate to SQLite page
- evalScript: document.querySelector('[data-testid="sqlite-link"]').click()

# Wait for SQLite page to load
- evalScript: window.waitFor(() => document.querySelector('[data-testid="database-test"]'), 'Database Test component not found')

# Reset database to ensure clean state
- evalScript: document.querySelector('[data-testid="db-reset-button"]').click()

# Wait for reset to complete
- evalScript: window.waitForResult('success')

# Verify database is in "Not Set Up" state
- evalScript: window.waitForStatus('Not Set Up')

# Set initial password and set up database
- evalScript: window.setPassword('${INITIAL_PASSWORD}')

- evalScript: document.querySelector('[data-testid="db-setup-button"]').click()

# Wait for setup to complete
- evalScript: window.waitForResult('success')

# Verify database is unlocked
- evalScript: window.waitForStatus('Unlocked')

# Write test data
- evalScript: document.querySelector('[data-testid="db-write-button"]').click()

# Wait for write to complete
- evalScript: window.waitForResult('success', 'Wrote test data:')

# Store written value for later comparison
- evalScript: |
    (async () => {
      const testData = document.querySelector('[data-testid="db-test-data"]');
      if (testData && /^test-value-\d+$/.test(testData.textContent)) {
        window.__writtenValue = testData.textContent;
        return 'ok';
      }
      throw new Error('Expected test data, got: ' + (testData ? testData.textContent : 'null'));
    })()

# Open change password UI
- evalScript: document.querySelector('[data-testid="db-change-password-toggle"]').click()

# Ensure current password is set before rekey
- evalScript: window.setPassword('${INITIAL_PASSWORD}')

# Set new password
- evalScript: window.setNewPassword('${NEW_PASSWORD}')

# Submit password change
- evalScript: document.querySelector('[data-testid="db-change-password-button"]').click()

# Wait for change to complete
- evalScript: window.waitForResult('success', 'Password changed successfully')

# Verify database remains unlocked
- evalScript: window.waitForStatus('Unlocked')

# Lock the database
- evalScript: document.querySelector('[data-testid="db-lock-button"]').click()

# Wait for lock to complete
- evalScript: window.waitForStatus('Locked')

# Try to unlock with old password (should fail)
- evalScript: window.setPassword('${INITIAL_PASSWORD}')

- evalScript: document.querySelector('[data-testid="db-unlock-button"]').click()

- evalScript: window.waitForResult('error', 'Wrong password')

# Unlock with new password
- evalScript: window.setPassword('${NEW_PASSWORD}')

- evalScript: document.querySelector('[data-testid="db-unlock-button"]').click()

- evalScript: window.waitForStatus('Unlocked')

# Read data and verify it persisted across rekey
- evalScript: document.querySelector('[data-testid="db-read-button"]').click()

- evalScript: window.waitForResult('success', 'Read test data:')

- evalScript: |
    window.waitFor(
      () => {
        const testData = document.querySelector('[data-testid="db-test-data"]');
        return testData?.textContent === window.__writtenValue;
      },
      'Data did not persist across password change'
    )
