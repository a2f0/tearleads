---
interface Props {
  'data-testid'?: string;
}

const { 'data-testid': testId } = Astro.props;
---

<section class="container mx-auto px-4 py-8">
  <div class="rounded-xl border bg-card p-6 shadow-sm">
    <div class="doc-content overflow-x-auto" data-testid={testId}>
      <slot />
    </div>
  </div>
</section>

<script>
  const rootElement = document.documentElement;
  const contentRoot = document.querySelector('.doc-content');
  const MERMAID_SCRIPT_ID = 'mermaid-esm-script';
  const MERMAID_SRC = 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js';

  const loadMermaid = async () => {
    if (typeof window === 'undefined') {
      return null;
    }

    if (window['mermaid']) {
      return window['mermaid'];
    }

    await new Promise((resolve, reject) => {
      const existingScript = document.getElementById(MERMAID_SCRIPT_ID);
      if (existingScript) {
        existingScript.addEventListener('load', resolve, { once: true });
        existingScript.addEventListener('error', reject, { once: true });
        return;
      }

      const scriptElement = document.createElement('script');
      scriptElement.id = MERMAID_SCRIPT_ID;
      scriptElement.src = MERMAID_SRC;
      scriptElement.async = true;
      scriptElement.addEventListener('load', resolve, { once: true });
      scriptElement.addEventListener('error', reject, { once: true });
      document.head.appendChild(scriptElement);
    });

    return window['mermaid'] ?? null;
  };

  const getMermaidTheme = () => rootElement.classList.contains('dark') ? 'dark' : 'default';

  const initializeMermaid = (mermaid) => {
    mermaid.initialize({
      startOnLoad: false,
      theme: getMermaidTheme(),
    });
  };

  const syncMermaidContainers = () => {
    if (!contentRoot) {
      return;
    }
    const codeBlocks = contentRoot.querySelectorAll('pre > code.language-mermaid');

    for (const codeBlock of codeBlocks) {
      const preElement = codeBlock.parentElement;
      if (!(preElement instanceof HTMLElement)) {
        continue;
      }

      const source = codeBlock.textContent?.trim() ?? '';
      if (source.length === 0) {
        continue;
      }

      let container = preElement.nextElementSibling;
      if (!(container instanceof HTMLElement) || !container.classList.contains('mermaid-client')) {
        container = document.createElement('div');
        container.className = 'mermaid mermaid-client my-4';
        preElement.insertAdjacentElement('afterend', container);
      }

      container.dataset.source = source;
      container.textContent = source;
      preElement.style.display = 'none';
    }
  };

  const rerenderMermaid = async () => {
    if (!contentRoot) {
      return;
    }
    const containers = contentRoot.querySelectorAll('.mermaid-client');
    if (containers.length === 0) {
      return;
    }

    const mermaid = await loadMermaid();
    if (!mermaid) {
      return;
    }

    initializeMermaid(mermaid);

    for (const container of containers) {
      if (!(container instanceof HTMLElement)) {
        continue;
      }
      container.removeAttribute('data-processed');
      container.textContent = container.dataset.source ?? '';
    }

    await mermaid.run({
      nodes: Array.from(containers),
      suppressErrors: false,
    });
  };

  const setupThemeObserver = () => {
    const observer = new MutationObserver(async (mutations) => {
      const classChanged = mutations.some((mutation) => mutation.attributeName === 'class');
      if (!classChanged) {
        return;
      }
      try {
        await rerenderMermaid();
      } catch (error) {
        console.error('Failed to re-render Mermaid diagrams on theme change:', error);
      }
    });

    observer.observe(rootElement, { attributes: true, attributeFilter: ['class'] });
  };

  const bootstrapMermaid = async () => {
    if (!contentRoot) {
      return;
    }
    syncMermaidContainers();
    try {
      await rerenderMermaid();
    } catch (error) {
      console.error('Failed to render Mermaid diagrams on initial load:', error);
    }
    setupThemeObserver();
  };

  void bootstrapMermaid();
</script>

<style>
  .doc-content :global(h1),
  .doc-content :global(h2),
  .doc-content :global(h3) {
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
    font-weight: 600;
  }

  .doc-content :global(h1) {
    font-size: 1.875rem;
  }

  .doc-content :global(h2) {
    font-size: 1.5rem;
  }

  .doc-content :global(h3) {
    font-size: 1.25rem;
  }

  .doc-content :global(p) {
    margin-bottom: 1rem;
    color: var(--color-muted-foreground);
  }

  .doc-content :global(svg) {
    max-width: 100%;
    height: auto;
    min-width: 600px;
  }

  .doc-content :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
  }

  .doc-content :global(th),
  .doc-content :global(td) {
    border: 1px solid var(--color-border);
    padding: 0.5rem 1rem;
    text-align: left;
  }

  .doc-content :global(th) {
    background-color: var(--color-muted);
    font-weight: 600;
  }

  .doc-content :global(ul),
  .doc-content :global(ol) {
    margin-bottom: 1rem;
    padding-left: 1.5rem;
    color: var(--color-muted-foreground);
  }

  .doc-content :global(li) {
    margin-bottom: 0.25rem;
  }

  .doc-content :global(code) {
    background-color: var(--color-muted);
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
  }

  .doc-content :global(pre) {
    background-color: var(--color-muted);
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin-bottom: 1rem;
  }

  .doc-content :global(pre code) {
    background-color: transparent;
    padding: 0;
  }
</style>
