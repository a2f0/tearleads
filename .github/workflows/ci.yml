name: CI

on:
  push:
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.vscode/**'
      - 'LICENSE'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      core: ${{ steps.filter.outputs.core }}
      client-src: ${{ steps.filter.outputs.client-src }}
      api: ${{ steps.filter.outputs.api }}
      mobile: ${{ steps.filter.outputs.mobile }}
      electron: ${{ steps.filter.outputs.electron }}
      web-e2e-tests: ${{ steps.filter.outputs.web-e2e-tests }}
      website: ${{ steps.filter.outputs.website }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            core:
              - 'packages/shared/**'
              - 'packages/ui/**'
              - '.github/workflows/ci.yml'
              - 'package.json'
              - 'pnpm-lock.yaml'
              - 'pnpm-workspace.yaml'
              - 'turbo.json'
            client-src:
              - 'packages/client/src/**'
            api:
              - 'packages/api/**'
            mobile:
              - 'packages/client/android/**'
              - 'packages/client/ios/**'
              - 'packages/client/.maestro/**'
              - 'packages/client/capacitor.config.ts'
              - 'packages/client/fastlane/**'
            electron:
              - 'packages/client/electron/**'
              - 'packages/client/tests/electron/**'
            web-e2e-tests:
              - 'packages/client/tests/*.spec.ts'
              - 'packages/client/playwright.config.ts'
            website:
              - 'packages/website/**'

  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3.0'
          bundler-cache: true
          working-directory: packages/client

      - name: Install dependencies
        run: pnpm install

      - name: Download SQLite WASM
        run: ./scripts/downloadSqliteWasm.sh

      - name: Install Playwright for mermaid rendering
        run: pnpm --filter @rapid/website exec playwright install chromium

      - name: Lint
        run: pnpm lint

      - name: Lint scripts
        run: pnpm lint:scripts

      - name: Lint Markdown
        run: pnpm lint:md

      - name: Lint RuboCop
        run: pnpm lint:rubocop

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version-file: '.python-version'

      - name: Install ansible-lint
        run: pip install ansible-lint ansible

      - name: Install Ansible collections
        run: ansible-galaxy collection install -r ansible/requirements.yml

      - name: Lint Ansible
        run: pnpm lint:ansible

      - name: Type check
        run: pnpm exec tsc -b

      - name: Build
        run: pnpm build

      - name: Test with Coverage
        run: |
          pnpm --filter @rapid/shared test:coverage
          pnpm --filter @rapid/ui test:coverage
          pnpm --filter @rapid/api test:coverage
          pnpm --filter @rapid/client test:coverage
          pnpm --filter @rapid/chrome-extension test:coverage
          pnpm --filter @rapid/website test:coverage

      - name: Upload Coverage Reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            packages/shared/coverage/
            packages/ui/coverage/
            packages/api/coverage/
            packages/client/coverage/
            packages/chrome-extension/coverage/
            packages/website/coverage/
          retention-days: 30

      - name: Coverage Summary
        run: |
          echo "## Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for pkg in shared ui api client chrome-extension website; do
            if [ -f "packages/$pkg/coverage/coverage-summary.json" ]; then
              echo "### @rapid/$pkg" >> $GITHUB_STEP_SUMMARY
              node -e "
                const summary = require('./packages/$pkg/coverage/coverage-summary.json');
                const total = summary.total;
                console.log('| Metric | Coverage |');
                console.log('|--------|----------|');
                console.log('| Lines | ' + total.lines.pct + '% |');
                console.log('| Statements | ' + total.statements.pct + '% |');
                console.log('| Functions | ' + total.functions.pct + '% |');
                console.log('| Branches | ' + total.branches.pct + '% |');
              " >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done

  web-e2e:
    name: Web E2E Tests
    needs: [detect-changes]
    if: >-
      github.event_name == 'workflow_dispatch' ||
      needs.detect-changes.outputs.core == 'true' ||
      needs.detect-changes.outputs.client-src == 'true' ||
      needs.detect-changes.outputs.api == 'true' ||
      needs.detect-changes.outputs.web-e2e-tests == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Download SQLite WASM
        run: ./scripts/downloadSqliteWasm.sh

      - name: Build client for production
        run: pnpm --filter @rapid/client build
        env:
          VITE_API_URL: https://localhost:8443/v1

      - name: Generate self-signed certificate
        run: |
          sudo mkdir -p /etc/ssl/private
          sudo openssl req -x509 -nodes -days 1 \
            -newkey rsa:2048 \
            -keyout /etc/ssl/private/localhost.key \
            -out /etc/ssl/certs/localhost.crt \
            -subj "/CN=localhost" \
            -addext "subjectAltName=DNS:localhost,IP:127.0.0.1"
          sudo chmod 644 /etc/ssl/certs/localhost.crt
          sudo chmod 600 /etc/ssl/private/localhost.key

      - name: Verify build output
        run: |
          echo "=== Checking dist folder ==="
          ls -la packages/client/dist/
          echo "=== Checking index.html ==="
          head -5 packages/client/dist/index.html
          echo "=== Checking assets folder ==="
          ls packages/client/dist/assets/ | head -10

      - name: Make workspace accessible to NGINX
        run: |
          # NGINX runs as www-data and needs execute permission on ALL parent directories
          # to traverse the path, plus read permission on files
          sudo chmod a+x /home/runner /home/runner/work /home/runner/work/rapid /home/runner/work/rapid/rapid
          sudo chmod -R a+rX $GITHUB_WORKSPACE

      - name: Install and configure NGINX
        run: |
          sudo apt-get update && sudo apt-get install -y nginx
          sed "s|/workspace|$GITHUB_WORKSPACE|g" .github/ci/nginx-client.conf | sudo tee /etc/nginx/sites-available/client
          sudo ln -sf /etc/nginx/sites-available/client /etc/nginx/sites-enabled/client
          sudo rm -f /etc/nginx/sites-enabled/default
          sudo nginx -t
          sudo systemctl restart nginx

      - name: Start API server
        run: |
          pnpm --filter @rapid/api dev &
          echo "Waiting for API server to be ready..."
          timeout 30 bash -c 'until curl -f http://localhost:5001/v1/ping; do sleep 1; done'

      - name: Verify NGINX is serving
        run: |
          echo "=== NGINX static file test ==="
          curl -k https://localhost:8443/ -I
          echo "=== NGINX API proxy test ==="
          curl -k https://localhost:8443/v1/ping
          echo "=== NGINX SQLite WASM test ==="
          curl -k https://localhost:8443/sqlite/sqlite3.wasm -I
          curl -k https://localhost:8443/sqlite/sqlite3.js -I
          echo "=== NGINX error log (if any) ==="
          sudo tail -20 /var/log/nginx/error.log || true

      - name: Get Playwright version
        id: playwright-version
        run: echo "version=$(pnpm --filter @rapid/client exec playwright --version)" >> $GITHUB_OUTPUT

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: pnpm --filter @rapid/client exec playwright install chromium

      - name: Run Playwright tests
        run: pnpm --filter @rapid/client test:e2e
        env:
          BASE_URL: https://localhost:8443

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: packages/client/playwright-report/
          retention-days: 30

  website-e2e:
    name: Website E2E Tests
    needs: [detect-changes]
    if: >-
      github.event_name == 'workflow_dispatch' ||
      needs.detect-changes.outputs.core == 'true' ||
      needs.detect-changes.outputs.website == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Get Playwright version
        id: playwright-version
        run: echo "version=$(pnpm --filter @rapid/website exec playwright --version)" >> $GITHUB_OUTPUT

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-website-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: pnpm --filter @rapid/website exec playwright install --with-deps chromium firefox webkit

      - name: Install Playwright dependencies
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: pnpm --filter @rapid/website exec playwright install-deps

      - name: Build API OpenAPI spec
        run: pnpm --filter @rapid/api buildOpenapi

      - name: Install Playwright for mermaid rendering
        run: pnpm --filter @rapid/website exec playwright install chromium

      - name: Build website
        run: pnpm --filter @rapid/website build

      - name: Generate self-signed certificate
        run: |
          sudo mkdir -p /etc/ssl/private
          sudo openssl req -x509 -nodes -days 1 \
            -newkey rsa:2048 \
            -keyout /etc/ssl/private/localhost.key \
            -out /etc/ssl/certs/localhost.crt \
            -subj "/CN=localhost" \
            -addext "subjectAltName=DNS:localhost,IP:127.0.0.1"
          sudo chmod 644 /etc/ssl/certs/localhost.crt
          sudo chmod 600 /etc/ssl/private/localhost.key

      - name: Make workspace accessible to NGINX
        run: |
          # NGINX runs as www-data and needs execute permission on ALL parent directories
          sudo chmod a+x /home/runner /home/runner/work /home/runner/work/rapid /home/runner/work/rapid/rapid
          sudo chmod -R a+rX $GITHUB_WORKSPACE

      - name: Install and configure NGINX
        run: |
          sudo apt-get update && sudo apt-get install -y nginx
          sed "s|/workspace|$GITHUB_WORKSPACE|g" .github/ci/nginx-website.conf | sudo tee /etc/nginx/sites-available/website
          sudo ln -sf /etc/nginx/sites-available/website /etc/nginx/sites-enabled/website
          sudo rm -f /etc/nginx/sites-enabled/default
          sudo nginx -t
          sudo systemctl restart nginx

      - name: Verify NGINX is serving
        run: curl -k https://localhost:8444/ -I

      - name: Run Playwright tests
        run: pnpm --filter @rapid/website test:e2e
        env:
          BASE_URL: https://localhost:8444

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: website-playwright-report
          path: packages/website/playwright-report/
          retention-days: 30

  electron-e2e:
    name: Electron E2E Tests
    needs: [detect-changes]
    if: >-
      github.event_name == 'workflow_dispatch' ||
      needs.detect-changes.outputs.core == 'true' ||
      needs.detect-changes.outputs.client-src == 'true' ||
      needs.detect-changes.outputs.electron == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Install system dependencies for Electron
        run: sudo apt-get install -y xvfb libnss3 libatk1.0-0t64 libatk-bridge2.0-0t64 libcups2t64 libdrm2 libxkbcommon0 libxcomposite1 libxdamage1 libxfixes3 libxrandr2 libgbm1 libasound2t64

      - name: Download SQLite WASM
        run: ./scripts/downloadSqliteWasm.sh

      - name: Generate self-signed certificate
        run: |
          sudo mkdir -p /etc/ssl/private
          sudo openssl req -x509 -nodes -days 1 \
            -newkey rsa:2048 \
            -keyout /etc/ssl/private/localhost.key \
            -out /etc/ssl/certs/localhost.crt \
            -subj "/CN=localhost" \
            -addext "subjectAltName=DNS:localhost,IP:127.0.0.1"
          sudo chmod 644 /etc/ssl/certs/localhost.crt
          sudo chmod 600 /etc/ssl/private/localhost.key
          # Copy cert to workspace for Electron to access
          cp /etc/ssl/certs/localhost.crt $GITHUB_WORKSPACE/.github/ci/localhost.crt

      - name: Install and configure NGINX for API proxy
        run: |
          sudo apt-get update && sudo apt-get install -y nginx
          sed "s|/workspace|$GITHUB_WORKSPACE|g" .github/ci/nginx-api.conf | sudo tee /etc/nginx/sites-available/api
          sudo ln -sf /etc/nginx/sites-available/api /etc/nginx/sites-enabled/api
          sudo rm -f /etc/nginx/sites-enabled/default
          sudo nginx -t
          sudo systemctl restart nginx

      - name: Start API server
        run: |
          pnpm --filter @rapid/api dev &
          echo "Waiting for API server to be ready..."
          timeout 30 bash -c 'until curl -f http://localhost:5001/v1/ping; do sleep 1; done'

      - name: Verify NGINX is proxying API
        run: curl -k https://localhost:8443/v1/ping

      - name: Build Electron app
        run: pnpm --filter @rapid/client electron:build
        env:
          VITE_API_URL: https://localhost:8443/v1

      - name: Run Electron tests
        run: xvfb-run --auto-servernum -- pnpm --filter @rapid/client electron:test
        env:
          NODE_EXTRA_CA_CERTS: ${{ github.workspace }}/.github/ci/localhost.crt

  android:
    name: Android Instrumented Tests
    needs: [detect-changes]
    if: >-
      github.event_name == 'workflow_dispatch' ||
      needs.detect-changes.outputs.core == 'true' ||
      needs.detect-changes.outputs.client-src == 'true' ||
      needs.detect-changes.outputs.mobile == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc

      - uses: actions/checkout@v4

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version-file: '.java-version'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3.0'
          bundler-cache: true
          working-directory: packages/client

      - name: Install dependencies
        run: pnpm install

      - name: Download SQLite WASM
        run: ./scripts/downloadSqliteWasm.sh

      - name: Install ImageMagick
        run: |
          sudo sed -i 's|http://azure.archive.ubuntu.com/ubuntu|http://archive.ubuntu.com/ubuntu|g' /etc/apt/sources.list
          sudo apt-get install -y --no-install-recommends imagemagick librsvg2-bin

      - name: Build web assets
        run: pnpm --filter @rapid/client build

      - name: Generate Android images
        run: ./packages/client/scripts/buildAndroidImageAssets.sh

      - name: Sync Capacitor
        run: pnpm --filter @rapid/client run cap:sync

      - name: Download Gradle wrapper
        run: ./packages/client/scripts/downloadGradleWrapper.sh

      - name: Run Android unit tests
        run: bundle exec fastlane android test
        working-directory: packages/client

      - name: Run Android instrumented tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 31
          arch: x86_64
          working-directory: packages/client
          emulator-boot-timeout: 900
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none -no-metrics
          disable-animations: true
          script: |
            adb wait-for-device
            adb shell input keyevent 82
            bundle exec fastlane android test_instrumented

  android-maestro-release:
    name: Android Maestro Tests (Release)
    needs: [detect-changes]
    if: >-
      github.event_name == 'workflow_dispatch' ||
      needs.detect-changes.outputs.core == 'true' ||
      needs.detect-changes.outputs.mobile == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc

      - uses: actions/checkout@v4

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version-file: '.java-version'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3.0'
          bundler-cache: true
          working-directory: packages/client

      - name: Install dependencies
        run: pnpm install

      - name: Download SQLite WASM
        run: ./scripts/downloadSqliteWasm.sh

      - name: Install ImageMagick
        run: |
          sudo sed -i 's|http://azure.archive.ubuntu.com/ubuntu|http://archive.ubuntu.com/ubuntu|g' /etc/apt/sources.list
          sudo apt-get install -y --no-install-recommends imagemagick librsvg2-bin

      - name: Build web assets
        run: pnpm --filter @rapid/client build

      - name: Generate Android images
        run: ./packages/client/scripts/buildAndroidImageAssets.sh

      - name: Sync Capacitor
        run: pnpm --filter @rapid/client run cap:sync

      - name: Download Gradle wrapper
        run: ./packages/client/scripts/downloadGradleWrapper.sh

      - name: Setup Android keystore
        run: |
          mkdir -p .secrets
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > .secrets/tearleads-release.keystore

      - name: Create keystore.properties
        run: |
          cat > packages/client/android/keystore.properties << EOF
          storeFile=${{ github.workspace }}/.secrets/tearleads-release.keystore
          storePassword=${{ secrets.ANDROID_KEYSTORE_STORE_PASS }}
          keyAlias=tearleads
          keyPassword=${{ secrets.ANDROID_KEYSTORE_KEY_PASS }}
          EOF

      - name: Install Maestro
        run: |
          ./packages/client/scripts/downloadMaestro.sh
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Run Maestro tests (Release)
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 31
          arch: x86_64
          working-directory: packages/client
          emulator-boot-timeout: 900
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none -no-metrics
          disable-animations: true
          script: |
            adb wait-for-device
            adb shell input keyevent 82
            bundle exec fastlane android test_maestro_release

      - name: Upload Maestro artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: android-maestro-release-artifacts
          path: packages/client/maestro-debug/
          retention-days: 7
          if-no-files-found: ignore

  ios-maestro-release:
    name: iOS Maestro Tests (Release)
    needs: [detect-changes]
    if: >-
      github.event_name == 'workflow_dispatch' ||
      needs.detect-changes.outputs.core == 'true' ||
      needs.detect-changes.outputs.mobile == 'true'
    runs-on: macos-latest
    timeout-minutes: 35

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3.0'
          bundler-cache: true
          working-directory: packages/client

      - name: Install dependencies
        run: pnpm install

      - name: Download SQLite WASM
        run: ./scripts/downloadSqliteWasm.sh

      - name: Build web assets
        run: pnpm --filter @rapid/client build

      - name: Install ImageMagick
        run: brew install imagemagick

      - name: Generate iOS images
        run: ./packages/client/scripts/buildIosImageAssets.sh

      - name: Install CocoaPods dependencies
        run: pod install
        working-directory: packages/client/ios/App

      - name: Sync Capacitor
        run: pnpm --filter @rapid/client run cap:sync

      - name: Build iOS release app for simulator
        run: bundle exec fastlane ios build_release_simulator
        working-directory: packages/client

      - name: Install Maestro
        run: curl -Ls "https://get.maestro.mobile.dev" | bash

      - name: Boot iOS simulator
        run: |
          # List available devices for debugging
          echo "Available simulators:"
          xcrun simctl list devices available | head -20

          # Prefer iPhone SE for faster boot and lower resource usage
          DEVICE=$(xcrun simctl list devices available | grep "iPhone SE" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')

          if [ -z "$DEVICE" ]; then
            echo "No iPhone SE found, trying iPhone 16/15"
            DEVICE=$(xcrun simctl list devices available | grep -E "iPhone (16|15)" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')
          fi

          if [ -z "$DEVICE" ]; then
            echo "No iPhone 15/16 found, trying any iPhone"
            DEVICE=$(xcrun simctl list devices available | grep "iPhone" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')
          fi

          if [ -z "$DEVICE" ]; then
            echo "ERROR: No iPhone simulator found"
            exit 1
          fi

          echo "Using simulator: $DEVICE"
          xcrun simctl boot "$DEVICE" || true
          echo "SIMULATOR_UDID=$DEVICE" >> $GITHUB_ENV

      - name: Install app on simulator
        run: |
          # Release build outputs to DerivedData-Release
          APP_PATH="packages/client/build/DerivedData-Release/Build/Products/Release-iphonesimulator/App.app"
          if [ ! -d "$APP_PATH" ]; then
            echo "App not found at expected path, searching..."
            APP_PATH=$(find . -name "App.app" -path "*Release-iphonesimulator*" -type d | head -1)
          fi
          echo "Installing release app from: $APP_PATH"
          xcrun simctl install "$SIMULATOR_UDID" "$APP_PATH"

      - name: Run Maestro tests
        run: |
          # Run Maestro tests
          $HOME/.maestro/bin/maestro test .maestro/ --output maestro-debug/report.xml --debug-output maestro-debug --format junit || true
          MAESTRO_EXIT=$?

          # Capture final screenshot
          xcrun simctl io "$SIMULATOR_UDID" screenshot maestro-debug/02-after-tests.png || true

          # Get device logs
          xcrun simctl spawn "$SIMULATOR_UDID" log show --last 5m --predicate 'subsystem contains "com.tearleads"' > maestro-debug/device-logs.txt 2>&1 || true

          exit $MAESTRO_EXIT
        working-directory: packages/client

      - name: Upload Maestro artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ios-maestro-release-artifacts
          path: packages/client/maestro-debug/
          retention-days: 7
          if-no-files-found: ignore
