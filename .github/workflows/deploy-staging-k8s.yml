name: Deploy Staging K8s

on:
  workflow_call:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    name: Rollout Staging Deployments
    runs-on: ${{ vars.USE_SELF_HOSTED == 'true' && 'self-hosted' || 'ubuntu-latest' }}
    timeout-minutes: 20
    env:
      AWS_REGION: us-east-1

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}
          fetch-depth: 0

      - name: Validate OIDC role configuration
        run: |
          if [ -z "${{ vars.AWS_STAGING_ECR_ROLE_ARN }}" ]; then
            echo "::error::Repository variable AWS_STAGING_ECR_ROLE_ARN is not set."
            exit 1
          fi

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ vars.AWS_STAGING_ECR_ROLE_ARN }}
          role-session-name: github-actions-staging-k8s-deploy

      - name: Connect to Tailscale
        uses: tailscale/github-action@v3
        with:
          oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TAILSCALE_OAUTH_CLIENT_SECRET }}
          tags: tag:ci

      - name: Install kubectl
        uses: azure/setup-kubectl@v4

      - name: Configure kubeconfig
        run: |
          set -eu
          mkdir -p ~/.kube
          echo "${{ secrets.STAGING_KUBECONFIG_B64 }}" | base64 -d > ~/.kube/config
          sed -i 's|server:.*|server: https://staging-k8s:6443|' ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Verify cluster connectivity
        run: kubectl get nodes

      - name: Refresh ECR pull secret
        run: |
          set -eu
          AWS_ACCOUNT_ID="$(aws sts get-caller-identity --query Account --output text)"
          ECR_REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          ECR_TOKEN="$(aws ecr get-login-password --region "$AWS_REGION")"

          kubectl delete secret ecr-registry -n tearleads 2>/dev/null || true
          kubectl create secret docker-registry ecr-registry \
            --namespace=tearleads \
            --docker-server="${ECR_REGISTRY}" \
            --docker-username=AWS \
            --docker-password="${ECR_TOKEN}"

      - name: Pin deployments to published image tag
        run: |
          set -eu
          AWS_ACCOUNT_ID="$(aws sts get-caller-identity --query Account --output text)"
          ECR_REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          IMAGE_TAG="${GITHUB_SHA}"

          kubectl set image deployment/api \
            api="${ECR_REGISTRY}/tearleads-staging/api:${IMAGE_TAG}" \
            -n tearleads
          kubectl set image deployment/client \
            client="${ECR_REGISTRY}/tearleads-staging/client:${IMAGE_TAG}" \
            -n tearleads
          kubectl set image deployment/website \
            website="${ECR_REGISTRY}/tearleads-staging/website:${IMAGE_TAG}" \
            -n tearleads

      - name: Rollout staging deployments
        run: |
          set -eu
          kubectl rollout restart deployment/api deployment/client deployment/website -n tearleads
          kubectl rollout status deployment/api -n tearleads --timeout=300s
          kubectl rollout status deployment/client -n tearleads --timeout=300s
          kubectl rollout status deployment/website -n tearleads --timeout=300s
