name: Deploy iOS Apps to TestFlight (Matrix)

on:
  workflow_call:
    inputs:
      apps:
        description: 'JSON array of app IDs to build (e.g., ["tearleads"])'
        required: false
        default: '["tearleads"]'
        type: string
  workflow_dispatch:
    inputs:
      apps:
        description: 'Comma-separated app IDs (leave empty for default: tearleads)'
        required: false
        default: ''
        type: string

permissions:
  contents: write

jobs:
  determine-apps:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install --filter @tearleads/app-builder

      - name: Determine apps to build
        id: set-matrix
        run: |
          if [ -n "${{ inputs.apps }}" ]; then
            # Check if input is already JSON array (from workflow_call)
            if echo "${{ inputs.apps }}" | jq -e 'type == "array"' > /dev/null 2>&1; then
              APPS='${{ inputs.apps }}'
            else
              # Convert comma-separated to JSON array (from workflow_dispatch)
              APPS=$(echo "${{ inputs.apps }}" | jq -R 'split(",") | map(gsub("\\s+"; "")) | map(select(. != ""))')
            fi
          else
            # Auto-discover all apps from app-builder
            cd packages/app-builder
            APPS=$(pnpm tsx src/cli.ts list --json)
          fi
          echo "Building apps: $APPS"
          echo "matrix={\"app\":$APPS}" >> $GITHUB_OUTPUT

  deploy:
    name: Deploy ${{ matrix.app }} to TestFlight
    needs: determine-apps
    runs-on: ${{ vars.USE_SELF_HOSTED == 'true' && 'self-hosted' || 'macos-latest' }}
    timeout-minutes: 20
    strategy:
      matrix: ${{ fromJson(needs.determine-apps.outputs.matrix) }}
      fail-fast: false

    env:
      XCODE_VERSION: 'latest-stable'
      APP_ID: ${{ matrix.app }}

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.sha }}
          fetch-depth: 0

      - name: Load app config
        id: config
        run: |
          npm install -g tsx
          cd packages/app-builder
          CONFIG=$(tsx src/cli.ts dump --app $APP_ID --format json)
          echo "bundle_id=$(echo $CONFIG | jq -r '.bundleIds.ios')" >> $GITHUB_OUTPUT
          echo "display_name=$(echo $CONFIG | jq -r '.displayName')" >> $GITHUB_OUTPUT
          echo "App: $(echo $CONFIG | jq -r '.displayName') ($APP_ID)"
          echo "Bundle ID: $(echo $CONFIG | jq -r '.bundleIds.ios')"

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3.0'
          bundler-cache: true
          working-directory: packages/client

      - name: Install dependencies
        run: pnpm install

      - name: Generate app configs
        run: |
          cd packages/app-builder
          tsx src/cli.ts generate --app $APP_ID
          echo "Generated config files for $APP_ID"

      - name: Download SQLite WASM
        run: ./scripts/downloadSqliteWasm.sh

      - name: Build app dependencies
        run: |
          cd packages/app-builder
          # Generate build commands for this app's enabled packages
          tsx src/cli.ts build-deps --app $APP_ID --shell | while read cmd; do
            echo "Running: $cmd"
            eval "$cmd"
          done

      - name: Build web assets
        run: pnpm --filter @tearleads/client build
        env:
          VITE_API_URL: https://api.${{ secrets.DEPLOY_DOMAIN_PROD }}/v1

      - name: Install ImageMagick
        run: brew install imagemagick

      - name: Generate iOS images
        run: ./packages/client/scripts/buildIosImageAssets.sh

      - name: Sync Capacitor
        run: pnpm --filter @tearleads/client run cap:sync

      - name: Apply CI version from source commit
        id: ci_version
        run: |
          ./scripts/applyCiVersionFromSha.sh \
            --source-sha "${{ github.sha }}" \
            --apply \
            --github-output "$GITHUB_OUTPUT"

      # Use per-app secrets with fallback to default secrets
      # Secret naming: {APP_ID_UPPER}_SECRET_NAME or SECRET_NAME
      - name: Setup App Store Connect API Key
        run: |
          mkdir -p .secrets
          KEY_ID="${{ secrets[format('{0}_APP_STORE_CONNECT_KEY_ID', env.APP_ID)] || secrets.APP_STORE_CONNECT_KEY_ID }}"
          echo "${{ secrets[format('{0}_APP_STORE_CONNECT_API_KEY', env.APP_ID)] || secrets.APP_STORE_CONNECT_API_KEY }}" | base64 -d > .secrets/AuthKey_${KEY_ID}.p8

      - name: Get local and TestFlight build numbers
        id: version_check
        run: |
          LOCAL_VERSION=$(grep -E 'CURRENT_PROJECT_VERSION = [0-9]+' ios/App/App.xcodeproj/project.pbxproj | head -1 | sed 's/.*= \([0-9]*\).*/\1/')
          echo "local_version=$LOCAL_VERSION" >> $GITHUB_OUTPUT
          echo "Local build number: $LOCAL_VERSION"

          TESTFLIGHT_VERSION=$(bundle exec fastlane ios get_testflight_build_number 2>&1 | grep -oE 'Latest TestFlight build number: [0-9]+' | grep -oE '[0-9]+' || echo "0")
          echo "testflight_version=$TESTFLIGHT_VERSION" >> $GITHUB_OUTPUT
          echo "TestFlight build number: $TESTFLIGHT_VERSION"
        working-directory: packages/client
        env:
          CI: true
          APP_STORE_CONNECT_KEY_ID: ${{ secrets[format('{0}_APP_STORE_CONNECT_KEY_ID', env.APP_ID)] || secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets[format('{0}_APP_STORE_CONNECT_ISSUER_ID', env.APP_ID)] || secrets.APP_STORE_CONNECT_ISSUER_ID }}

      - name: Validate version is newer than TestFlight
        id: check_build
        run: |
          LOCAL=${{ steps.version_check.outputs.local_version }}
          TESTFLIGHT=${{ steps.version_check.outputs.testflight_version }}

          echo "Comparing: local=$LOCAL vs TestFlight=$TESTFLIGHT"

          if [ "$LOCAL" -lt "$TESTFLIGHT" ]; then
            echo "ERROR: Local version ($LOCAL) is OLDER than TestFlight ($TESTFLIGHT)."
            exit 1
          elif [ "$LOCAL" -eq "$TESTFLIGHT" ]; then
            echo "Local version ($LOCAL) already exists in TestFlight. Skipping."
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "Local version ($LOCAL) is newer than TestFlight ($TESTFLIGHT). Proceeding."
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Cache CocoaPods
        if: steps.check_build.outputs.skip != 'true'
        uses: actions/cache@v4
        with:
          path: packages/client/ios/App/Pods
          key: pods-${{ runner.os }}-${{ matrix.app }}-${{ hashFiles('packages/client/ios/App/Podfile.lock') }}
          restore-keys: |
            pods-${{ runner.os }}-${{ matrix.app }}-
            pods-${{ runner.os }}-

      - name: Install CocoaPods
        if: steps.check_build.outputs.skip != 'true'
        run: bundle exec pod install
        working-directory: packages/client/ios/App

      - name: Build for TestFlight
        if: steps.check_build.outputs.skip != 'true'
        run: bundle exec fastlane ios build_for_testflight
        working-directory: packages/client
        env:
          CI: true
          APP_DISPLAY_NAME: ${{ steps.config.outputs.display_name }}
          APPLE_ID: ${{ secrets[format('{0}_APPLE_ID', env.APP_ID)] || secrets.APPLE_ID }}
          TEAM_ID: ${{ secrets[format('{0}_TEAM_ID', env.APP_ID)] || secrets.TEAM_ID }}
          ITC_TEAM_ID: ${{ secrets[format('{0}_ITC_TEAM_ID', env.APP_ID)] || secrets.ITC_TEAM_ID }}
          APP_STORE_CONNECT_KEY_ID: ${{ secrets[format('{0}_APP_STORE_CONNECT_KEY_ID', env.APP_ID)] || secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets[format('{0}_APP_STORE_CONNECT_ISSUER_ID', env.APP_ID)] || secrets.APP_STORE_CONNECT_ISSUER_ID }}
          MATCH_GIT_URL: ${{ secrets[format('{0}_MATCH_GIT_URL', env.APP_ID)] || secrets.MATCH_GIT_URL }}
          MATCH_PASSWORD: ${{ secrets[format('{0}_MATCH_PASSWORD', env.APP_ID)] || secrets.MATCH_PASSWORD }}
          MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets[format('{0}_MATCH_GIT_BASIC_AUTHORIZATION', env.APP_ID)] || secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
          MATCH_ALLOW_PROFILE_CREATION: 'true'

      - name: Verify clean build
        if: steps.check_build.outputs.skip != 'true'
        run: ./scripts/verifyCleanIosBuild.sh

      - name: Upload to TestFlight
        if: steps.check_build.outputs.skip != 'true'
        run: bundle exec fastlane ios upload_testflight
        working-directory: packages/client
        env:
          CI: true
          APP_DISPLAY_NAME: ${{ steps.config.outputs.display_name }}
          APP_STORE_CONNECT_KEY_ID: ${{ secrets[format('{0}_APP_STORE_CONNECT_KEY_ID', env.APP_ID)] || secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets[format('{0}_APP_STORE_CONNECT_ISSUER_ID', env.APP_ID)] || secrets.APP_STORE_CONNECT_ISSUER_ID }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        if: always()
        run: |
          echo "### iOS Deploy Summary: ${{ steps.config.outputs.display_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- App ID: $APP_ID" >> $GITHUB_STEP_SUMMARY
          echo "- Bundle ID: ${{ steps.config.outputs.bundle_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ steps.version_check.outputs.local_version }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_build.outputs.skip }}" = "true" ]; then
            echo "- Status: Skipped (already in TestFlight)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Status: Deployed" >> $GITHUB_STEP_SUMMARY
          fi
