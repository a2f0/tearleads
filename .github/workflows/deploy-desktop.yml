name: Deploy Desktop

on:
  workflow_call:

jobs:
  deploy:
    name: Deploy Desktop (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    env:
      DESKTOP_APP_IDENTIFIER: com.tearleads.app
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Setup Ruby (macOS)
        if: runner.os == 'macOS'
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3.0'
          bundler-cache: true
          working-directory: packages/client

      - name: Install dependencies
        run: pnpm install

      - name: Apply CI version from source commit
        id: ci_version
        run: |
          ./scripts/applyCiVersionFromSha.sh \
            --source-sha "${{ github.sha }}" \
            --apply \
            --github-output "$GITHUB_OUTPUT"
        shell: bash

      - name: Download SQLite WASM
        run: ./scripts/downloadSqliteWasm.sh
        shell: bash

      - name: Install ImageMagick (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y imagemagick

      - name: Install ImageMagick (macOS)
        if: runner.os == 'macOS'
        run: brew install imagemagick

      - name: Install ImageMagick (Windows)
        if: runner.os == 'Windows'
        run: choco install imagemagick --no-progress

      - name: Generate Electron image assets
        run: ./packages/client/scripts/buildElectronImageAssets.sh
        shell: bash

      - name: Build API (for OpenAPI spec)
        run: pnpm --filter @tearleads/api build

      - name: Build window-manager
        run: pnpm --filter @tearleads/window-manager build

      - name: Build UI
        run: pnpm --filter @tearleads/ui build

      - name: Build notes
        run: pnpm --filter @tearleads/notes build

      - name: Build email
        run: pnpm --filter @tearleads/email build

      - name: Build vfs-explorer
        run: pnpm --filter @tearleads/vfs-explorer build

      - name: Build ai
        run: pnpm --filter @tearleads/ai build

      - name: Build audio
        run: pnpm --filter @tearleads/audio build

      - name: Build contacts
        run: pnpm --filter @tearleads/contacts build

      - name: Build db-test-utils
        run: pnpm --filter @tearleads/db-test-utils build

      - name: Build calendar
        run: pnpm --filter @tearleads/calendar build

      - name: Build photos
        run: pnpm --filter @tearleads/photos build

      - name: Setup App Store Connect API Key (macOS)
        if: runner.os == 'macOS'
        run: |
          mkdir -p .secrets
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY }}" | base64 -d > .secrets/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8

      - name: Sync macOS code signing certificates
        if: runner.os == 'macOS'
        run: bundle exec fastlane ios sync_desktop_certs
        working-directory: packages/client
        env:
          CI: true
          APPLE_ID: ${{ secrets.APPLE_ID }}
          TEAM_ID: ${{ secrets.TEAM_ID }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
          DESKTOP_APP_IDENTIFIER: ${{ env.DESKTOP_APP_IDENTIFIER }}

      - name: Verify macOS signing identity
        if: runner.os == 'macOS'
        run: |
          echo "Available signing identities:"
          security find-identity -v -p codesigning
          security find-identity -v -p codesigning | grep "Developer ID Application" || {
            echo "::error::No Developer ID Application signing identity found. Certificate import may have failed."
            exit 1
          }

      - name: Build desktop release artifacts
        if: runner.os != 'macOS'
        run: pnpm --filter @tearleads/client run electron:dist:unsigned
        env:
          VITE_API_URL: https://api.${{ secrets.DEPLOY_DOMAIN_PROD }}/v1

      - name: Build signed macOS release artifacts
        if: runner.os == 'macOS'
        run: pnpm --filter @tearleads/client run electron:dist
        env:
          VITE_API_URL: https://api.${{ secrets.DEPLOY_DOMAIN_PROD }}/v1
          APPLE_TEAM_ID: ${{ secrets.TEAM_ID }}
          APPLE_API_KEY: ${{ github.workspace }}/.secrets/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8
          APPLE_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APPLE_API_ISSUER: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}

      - name: Upload desktop artifacts
        uses: actions/upload-artifact@v4
        with:
          name: desktop-${{ matrix.os }}
          path: |
            packages/client/dist-electron/*.dmg
            packages/client/dist-electron/*.exe
            packages/client/dist-electron/*.AppImage
            packages/client/dist-electron/*.deb

  publish-downloads:
    name: Publish Desktop Downloads
    runs-on: ubuntu-latest
    needs: deploy
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}
          fetch-depth: 0

      - name: Resolve CI version
        id: ci_version
        run: |
          ./scripts/applyCiVersionFromSha.sh \
            --source-sha "${{ github.sha }}" \
            --github-output "$GITHUB_OUTPUT"

      - name: Resolve app version
        run: |
          APP_VERSION="${{ steps.ci_version.outputs.client_version }}"
          echo "APP_VERSION=$APP_VERSION" >> "$GITHUB_ENV"

      - name: Download desktop artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: desktop-*
          path: downloads

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy.key
          chmod 600 ~/.ssh/deploy.key
          ssh-keyscan -H download.${{ secrets.DEPLOY_DOMAIN_PROD }} >> ~/.ssh/known_hosts

      - name: Upload downloads
        run: |
          ssh -i ~/.ssh/deploy.key ${{ secrets.DEPLOY_USER }}@download.${{ secrets.DEPLOY_DOMAIN_PROD }} \
            "mkdir -p /var/www/downloads/desktop/${APP_VERSION}"
          rsync -avz -e "ssh -vvv -i ~/.ssh/deploy.key" \
            downloads/ ${{ secrets.DEPLOY_USER }}@download.${{ secrets.DEPLOY_DOMAIN_PROD }}:/var/www/downloads/desktop/${APP_VERSION}/
          ssh -i ~/.ssh/deploy.key ${{ secrets.DEPLOY_USER }}@download.${{ secrets.DEPLOY_DOMAIN_PROD }} \
            "ln -sfn /var/www/downloads/desktop/${APP_VERSION} /var/www/downloads/desktop/latest"

      - name: Cleanup old versions (keep last 5)
        run: |
          ssh -i ~/.ssh/deploy.key ${{ secrets.DEPLOY_USER }}@download.${{ secrets.DEPLOY_DOMAIN_PROD }} '
            cd /var/www/downloads/desktop
            # List version directories (exclude latest symlink), sort by version, keep newest 5
            ls -d 0.* 2>/dev/null | sort -V | head -n -5 | xargs -r rm -rf
          '
