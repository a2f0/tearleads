name: Deploy Desktop

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]

jobs:
  deploy:
    name: Deploy Desktop (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    env:
      DESKTOP_APP_IDENTIFIER: com.tearleads.desktop
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Setup Ruby (macOS)
        if: runner.os == 'macOS'
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3.0'
          bundler-cache: true
          working-directory: packages/client

      - name: Install dependencies
        run: pnpm install

      - name: Download SQLite WASM
        run: ./scripts/downloadSqliteWasm.sh
        shell: bash

      - name: Install ImageMagick (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y imagemagick

      - name: Install ImageMagick (macOS)
        if: runner.os == 'macOS'
        run: brew install imagemagick

      - name: Install ImageMagick (Windows)
        if: runner.os == 'Windows'
        run: choco install imagemagick --no-progress

      - name: Generate Electron image assets
        run: ./packages/client/scripts/buildElectronImageAssets.sh
        shell: bash

      - name: Setup App Store Connect API Key (macOS)
        if: runner.os == 'macOS'
        run: |
          mkdir -p .secrets
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY }}" | base64 -d > .secrets/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8

      - name: Sync macOS code signing certificates
        if: runner.os == 'macOS'
        run: bundle exec fastlane ios sync_desktop_certs
        working-directory: packages/client
        env:
          CI: true
          APPLE_ID: ${{ secrets.APPLE_ID }}
          TEAM_ID: ${{ secrets.TEAM_ID }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}

      - name: Build desktop release artifacts
        if: runner.os != 'macOS'
        run: pnpm --filter @rapid/client run electron:dist:unsigned
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}

      - name: Build signed macOS release artifacts
        if: runner.os == 'macOS'
        run: pnpm --filter @rapid/client run electron:dist
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.TEAM_ID }}
          APPLE_API_KEY: ${{ github.workspace }}/.secrets/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8
          APPLE_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APPLE_API_ISSUER: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}

      - name: Upload desktop artifacts
        uses: actions/upload-artifact@v4
        with:
          name: desktop-${{ matrix.os }}
          path: packages/client/dist-electron/**
