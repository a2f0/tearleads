name: build

on:
  push:
    branches: [main]
  pull_request:
  workflow_call:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  detect-impact:
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.impact.outputs.should-run }}
      impact-json: ${{ steps.impact.outputs.impact-json }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Install tsx
        run: npm install -g tsx

      - name: Analyze CI impact
        id: impact
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            HEAD_SHA="${{ github.sha }}"
            git fetch --no-tags --prune --depth=2 origin "$HEAD_SHA" || true
            BASE_SHA=$(git rev-list --parents -n 1 "$HEAD_SHA" | awk '{print $2}')
            if [ -n "$BASE_SHA" ]; then
              git fetch --no-tags --prune --depth=1 origin "$BASE_SHA" || true
            else
              BASE_SHA="$HEAD_SHA"
            fi
          fi

          tsx scripts/ciImpact/ciImpact.ts --base "$BASE_SHA" --head "$HEAD_SHA" > ci-impact.json
          SHOULD_RUN="$(jq -r '.jobs["build"].run' ci-impact.json)"
          echo "should-run=$SHOULD_RUN" >> "$GITHUB_OUTPUT"
          echo "impact-json<<JSON" >> "$GITHUB_OUTPUT"
          cat ci-impact.json >> "$GITHUB_OUTPUT"
          echo "JSON" >> "$GITHUB_OUTPUT"

      - name: Publish impact summary
        if: ${{ always() }}
        run: |
          echo "### CI impact (build)" >> "$GITHUB_STEP_SUMMARY"
          jq -r '"- build: " + (.jobs["build"].run|tostring) + " (" + (.jobs["build"].reasons|join(", ")) + ")"' ci-impact.json >> "$GITHUB_STEP_SUMMARY"
          jq -r '"- changed packages: " + (.changedPackages|join(", "))' ci-impact.json >> "$GITHUB_STEP_SUMMARY"
          jq -r 'if (.warnings|length) > 0 then "- warnings: " + (.warnings|join("; ")) else "- warnings: none" end' ci-impact.json >> "$GITHUB_STEP_SUMMARY"

  # Lint jobs run in parallel
  lint:
    needs: detect-impact
    if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        lint-type: [biome, scripts, markdown, rubocop, ansible, terraform]
    steps:
      - name: Report no impact detected
        if: ${{ github.event_name != 'workflow_dispatch' && needs.detect-impact.outputs.should-run != 'true' }}
        run: |
          echo "::notice::No code changes detected that impact this job - reporting success"

      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Setup Ruby
        if: matrix.lint-type == 'rubocop'
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3.0'
          bundler-cache: true
          working-directory: packages/client

      - name: Setup Python
        if: matrix.lint-type == 'ansible'
        uses: actions/setup-python@v5
        with:
          python-version-file: '.python-version'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: Install ansible-lint
        if: matrix.lint-type == 'ansible'
        run: pip3 install -r requirements.txt

      - name: Cache Ansible collections
        if: matrix.lint-type == 'ansible'
        uses: actions/cache@v4
        with:
          path: ~/.ansible/collections
          key: ansible-collections-${{ hashFiles('ansible/requirements.yml', 'tee/ansible/requirements.yml') }}

      - name: Install Ansible collections
        if: matrix.lint-type == 'ansible'
        run: |
          ansible-galaxy collection install -r ansible/requirements.yml
          ansible-galaxy collection install -r tee/ansible/requirements.yml

      - name: Lint (biome)
        if: matrix.lint-type == 'biome'
        run: pnpm lint

      - name: Lint scripts (shellcheck)
        if: matrix.lint-type == 'scripts'
        run: pnpm lint:scripts

      - name: Lint Markdown
        if: matrix.lint-type == 'markdown'
        run: pnpm lint:md

      - name: Lint RuboCop
        if: matrix.lint-type == 'rubocop'
        run: pnpm lint:rubocop

      - name: Lint Ansible
        if: matrix.lint-type == 'ansible'
        run: pnpm lint:ansible

      - name: Setup Terraform
        if: matrix.lint-type == 'terraform'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Setup TFLint
        if: matrix.lint-type == 'terraform'
        uses: terraform-linters/setup-tflint@v4

      - name: Init TFLint plugins
        if: matrix.lint-type == 'terraform'
        run: |
          tflint --chdir=terraform --init
          tflint --chdir=tuxedo/terraform --init

      - name: Lint Terraform
        if: matrix.lint-type == 'terraform'
        run: ./scripts/checkTerraform.sh

  # Check for binary/JS files and verify guardrails
  guardrails:
    needs: detect-impact
    if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Check for binary files
        run: ./scripts/checkBinaryFiles.sh --from-upstream

      - name: Check for plain JavaScript files
        run: ./scripts/checkJs.sh --from-upstream

      - name: Check preen ecosystem parity
        run: ./scripts/checkPreenEcosystem.sh --strict

      - name: Verify binary guardrails
        run: ./scripts/verifyBinaryGuardrails.sh

  # Typecheck and build (sequential dependency)
  typecheck-build:
    needs: [detect-impact, guardrails]
    if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
    runs-on: ${{ vars.USE_SELF_HOSTED == 'true' && 'self-hosted' || 'ubuntu-latest' }}
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Check for circular imports
        run: ./scripts/checkCircularImports.sh

      - name: Cache SQLite WASM
        uses: actions/cache@v4
        with:
          path: |
            packages/client/src/workers/sqlite-wasm
            packages/client/public/sqlite
            packages/client/public/assets/sqlite3-opfs-async-proxy.js
          key: sqlite-wasm-${{ hashFiles('scripts/downloadSqliteWasm.sh') }}

      - name: Download SQLite WASM
        run: ./scripts/downloadSqliteWasm.sh

      - name: Install Playwright for mermaid rendering
        run: pnpm --filter @tearleads/website exec playwright install chromium

      - name: Type check
        run: pnpm exec tsc -b

      - name: Build
        run: pnpm build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-dist
          path: |
            packages/*/dist
            !packages/*/node_modules
          retention-days: 1

  # Unit tests run in parallel matrix
  test:
    needs: [detect-impact, typecheck-build]
    if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
    runs-on: ${{ vars.USE_SELF_HOSTED == 'true' && 'self-hosted' || 'ubuntu-latest' }}
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        package:
          - shared
          - ui
          - window-manager
          - audio
          - terminal
          - keychain
          - api
          - smtp-listener
          - client
          - chrome-extension
          - website
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Setup Ruby
        if: ${{ vars.USE_SELF_HOSTED != 'true' }}
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3.0'
          bundler-cache: true
          working-directory: packages/client

      - name: Install Ruby dependencies (self-hosted)
        if: ${{ vars.USE_SELF_HOSTED == 'true' }}
        run: bundle install
        working-directory: packages/client

      - name: Install dependencies
        run: pnpm install

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-dist
          path: packages

      - name: Cache SQLite WASM
        if: matrix.package == 'client'
        uses: actions/cache@v4
        with:
          path: |
            packages/client/src/workers/sqlite-wasm
            packages/client/public/sqlite
            packages/client/public/assets/sqlite3-opfs-async-proxy.js
          key: sqlite-wasm-${{ hashFiles('scripts/downloadSqliteWasm.sh') }}

      - name: Download SQLite WASM
        if: matrix.package == 'client'
        run: ./scripts/downloadSqliteWasm.sh

      - name: Test with Coverage
        run: pnpm --filter @tearleads/${{ matrix.package }} test:coverage

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.package }}
          path: packages/${{ matrix.package }}/coverage/
          retention-days: 30

  # Tuxedo shell tests (separate job)
  test-tuxedo:
    needs: [detect-impact, typecheck-build]
    if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
    runs-on: ${{ vars.USE_SELF_HOSTED == 'true' && 'self-hosted' || 'ubuntu-latest' }}
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Setup Ruby
        if: ${{ vars.USE_SELF_HOSTED != 'true' }}
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3.0'
          bundler-cache: true
          working-directory: packages/client

      - name: Install dependencies
        run: pnpm install

      - name: Install bashcov
        run: gem install bashcov

      - name: Test with Coverage
        run: pnpm test:coverage

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-tuxedo
          path: tuxedo/tests/coverage/
          retention-days: 30

  # Aggregate coverage reports and create summary
  coverage-summary:
    needs: [detect-impact, test, test-tuxedo]
    if: ${{ always() && (github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true') }}
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Download all coverage artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-*
          path: coverage-reports

      - name: Reorganize coverage reports
        run: |
          mkdir -p packages
          for pkg in shared ui window-manager audio terminal keychain api smtp-listener client chrome-extension website; do
            if [ -d "coverage-reports/coverage-$pkg" ]; then
              mkdir -p "packages/$pkg/coverage"
              cp -r "coverage-reports/coverage-$pkg"/* "packages/$pkg/coverage/" 2>/dev/null || true
            fi
          done
          if [ -d "coverage-reports/coverage-tuxedo" ]; then
            mkdir -p "tuxedo/tests/coverage"
            cp -r "coverage-reports/coverage-tuxedo"/* "tuxedo/tests/coverage/" 2>/dev/null || true
          fi

      - name: Upload Combined Coverage Reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            packages/*/coverage/
            tuxedo/tests/coverage/
          retention-days: 30

      - name: Coverage Summary
        run: |
          echo "## Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for pkg in shared ui window-manager audio terminal keychain api smtp-listener client chrome-extension website; do
            if [ -f "packages/$pkg/coverage/coverage-summary.json" ]; then
              echo "### @tearleads/$pkg" >> $GITHUB_STEP_SUMMARY
              node -e "
                const summary = require('./packages/$pkg/coverage/coverage-summary.json');
                const total = summary.total;
                console.log('| Metric | Coverage |');
                console.log('|--------|----------|');
                console.log('| Lines | ' + total.lines.pct + '% |');
                console.log('| Statements | ' + total.statements.pct + '% |');
                console.log('| Functions | ' + total.functions.pct + '% |');
                console.log('| Branches | ' + total.branches.pct + '% |');
              " >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done

  # Final build status (for branch protection)
  build:
    needs: [detect-impact, lint, guardrails, typecheck-build, test, test-tuxedo, coverage-summary]
    if: ${{ always() }}
    runs-on: ubuntu-latest
    steps:
      - name: Report no impact detected
        if: ${{ github.event_name != 'workflow_dispatch' && needs.detect-impact.outputs.should-run != 'true' }}
        run: |
          echo "::notice::No code changes detected that impact this job - reporting success"
          echo "## Build Skipped" >> "$GITHUB_STEP_SUMMARY"
          echo "No code changes detected that require this job to run." >> "$GITHUB_STEP_SUMMARY"

      - name: Check job results
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.guardrails.result }}" != "success" ] || \
             [ "${{ needs.typecheck-build.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.test-tuxedo.result }}" != "success" ] || \
             [ "${{ needs.coverage-summary.result }}" != "success" ]; then
            echo "One or more jobs did not complete successfully"
            exit 1
          fi
          echo "All jobs passed successfully"
