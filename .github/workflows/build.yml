name: build

on:
  push:
    branches: [main]
  pull_request:
  workflow_call:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  detect-impact:
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.impact.outputs.should-run }}
      impact-json: ${{ steps.impact.outputs.impact-json }}
      test-packages: ${{ steps.impact.outputs.test-packages }}
      test-should-run: ${{ steps.impact.outputs.test-should-run }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Prepare ciImpact runtime
        run: echo "Using node --experimental-strip-types for CI impact scripts"

      - name: Analyze CI impact
        id: impact
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            HEAD_SHA="${{ github.sha }}"
            git fetch --no-tags --prune --depth=2 origin "$HEAD_SHA" || true
            BASE_SHA=$(git rev-list --parents -n 1 "$HEAD_SHA" | awk '{print $2}')
            if [ -n "$BASE_SHA" ]; then
              git fetch --no-tags --prune --depth=1 origin "$BASE_SHA" || true
            else
              BASE_SHA="$HEAD_SHA"
            fi
          fi

          node --experimental-strip-types scripts/ciImpact/ciImpact.ts --base "$BASE_SHA" --head "$HEAD_SHA" > ci-impact.json
          SHOULD_RUN="$(jq -r '.jobs["build"].run' ci-impact.json)"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TARGETS_JSON="$(node --experimental-strip-types scripts/ciImpact/runImpactedTests.ts --files "package.json" --dry-run --print-targets-json)"
          else
            TARGETS_JSON="$(node --experimental-strip-types scripts/ciImpact/runImpactedTests.ts --base "$BASE_SHA" --head "$HEAD_SHA" --dry-run --print-targets-json)"
          fi
          TEST_PACKAGES="$(printf '%s' "$TARGETS_JSON" | jq -cr '.targets | map(sub("^@tearleads/"; ""))')"
          TEST_SHOULD_RUN="$(printf '%s' "$TARGETS_JSON" | jq -r 'if (.targets | length) > 0 then "true" else "false" end')"
          echo "should-run=$SHOULD_RUN" >> "$GITHUB_OUTPUT"
          echo "test-packages=$TEST_PACKAGES" >> "$GITHUB_OUTPUT"
          echo "test-should-run=$TEST_SHOULD_RUN" >> "$GITHUB_OUTPUT"
          echo "impact-json<<JSON" >> "$GITHUB_OUTPUT"
          cat ci-impact.json >> "$GITHUB_OUTPUT"
          echo "JSON" >> "$GITHUB_OUTPUT"

      - name: Publish impact summary
        if: ${{ always() }}
        run: |
          echo "### CI impact (build)" >> "$GITHUB_STEP_SUMMARY"
          jq -r '"- build: " + (.jobs["build"].run|tostring) + " (" + (.jobs["build"].reasons|join(", ")) + ")"' ci-impact.json >> "$GITHUB_STEP_SUMMARY"
          jq -r '"- changed packages: " + (.changedPackages|join(", "))' ci-impact.json >> "$GITHUB_STEP_SUMMARY"
          jq -r 'if (.warnings|length) > 0 then "- warnings: " + (.warnings|join("; ")) else "- warnings: none" end' ci-impact.json >> "$GITHUB_STEP_SUMMARY"
          echo "- impacted test packages: ${{ steps.impact.outputs.test-packages }}" >> "$GITHUB_STEP_SUMMARY"

  # Lint jobs run in parallel
  lint:
    needs: detect-impact
    if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        lint-type: [biome, scripts, markdown, rubocop, ansible, terraform, audit]
    steps:
      - name: Report no impact detected
        if: ${{ github.event_name != 'workflow_dispatch' && needs.detect-impact.outputs.should-run != 'true' }}
        run: |
          echo "::notice::No code changes detected that impact this job - reporting success"

      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Setup Ruby
        if: matrix.lint-type == 'rubocop'
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3.0'
          bundler-cache: true
          working-directory: packages/client

      - name: Setup Python
        if: matrix.lint-type == 'ansible'
        uses: actions/setup-python@v5
        with:
          python-version-file: '.python-version'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: Install ansible-lint
        if: matrix.lint-type == 'ansible'
        run: pip3 install -r requirements.txt

      - name: Cache Ansible collections
        if: matrix.lint-type == 'ansible'
        uses: actions/cache@v4
        with:
          path: ~/.ansible/collections
          key: ansible-collections-${{ hashFiles('ansible/requirements.yml', 'terraform/stacks/staging/tee/ansible/requirements.yml', 'terraform/stacks/prod/tee/ansible/requirements.yml') }}

      - name: Install Ansible collections
        if: matrix.lint-type == 'ansible'
        run: |
          for requirements_file in \
            ansible/requirements.yml \
            terraform/stacks/staging/tee/ansible/requirements.yml \
            terraform/stacks/prod/tee/ansible/requirements.yml; do
            if [ -f "$requirements_file" ]; then
              ansible-galaxy collection install -r "$requirements_file"
            fi
          done

      - name: Lint (biome)
        if: matrix.lint-type == 'biome'
        run: pnpm lint

      - name: Lint scripts (shellcheck)
        if: matrix.lint-type == 'scripts'
        run: pnpm lint:scripts

      - name: Lint Markdown
        if: matrix.lint-type == 'markdown'
        run: pnpm lint:md

      - name: Lint RuboCop
        if: matrix.lint-type == 'rubocop'
        run: pnpm lint:rubocop

      - name: Lint Ansible
        if: matrix.lint-type == 'ansible'
        run: pnpm lint:ansible

      - name: Read Terraform version
        if: matrix.lint-type == 'terraform'
        id: terraform-version
        run: echo "version=$(cat .terraform-version)" >> "$GITHUB_OUTPUT"

      - name: Setup Terraform
        if: matrix.lint-type == 'terraform'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ steps.terraform-version.outputs.version }}
          terraform_wrapper: false

      - name: Setup TFLint
        if: matrix.lint-type == 'terraform'
        uses: terraform-linters/setup-tflint@v4

      - name: Init TFLint plugins
        if: matrix.lint-type == 'terraform'
        run: tflint --init

      - name: Lint Terraform
        if: matrix.lint-type == 'terraform'
        run: ./scripts/checks/checkTerraform.sh

      - name: Audit dependencies
        if: matrix.lint-type == 'audit'
        run: pnpm audit --audit-level critical

  # Check for binary/JS files and verify guardrails
  guardrails:
    needs: detect-impact
    if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Check for binary files
        run: ./scripts/checks/checkBinaryFiles.sh --from-upstream

      - name: Check for plain JavaScript files
        run: ./scripts/checks/checkJs.sh --from-upstream

      - name: Check TypeScript file naming
        run: ./scripts/checks/checkFileNames.sh --from-upstream

      - name: Check client package boundary
        run: ./scripts/checks/checkClientBoundary.sh --from-upstream

      - name: Check API package boundary
        run: ./scripts/checks/checkApiBoundary.sh --from-upstream

      - name: Check preen ecosystem parity
        run: npx -y tsx ./scripts/checks/preen/checkPreenEcosystem.ts --strict

      - name: Verify file guardrails
        run: ./scripts/verifyFileGuardrails.sh

  # Typecheck and build (sequential dependency)
  typecheck-build:
    needs: [detect-impact, guardrails]
    if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
    runs-on: ${{ vars.USE_SELF_HOSTED == 'true' && 'self-hosted' || 'ubuntu-latest' }}
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Run impacted ciImpact script tests
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            git fetch --no-tags --prune --depth=100 origin "$HEAD_SHA" || true
            git fetch --no-tags --prune --depth=100 origin "$BASE_SHA" || true
          else
            HEAD_SHA="${{ github.sha }}"
            git fetch --no-tags --prune --depth=2 origin "$HEAD_SHA" || true
            BASE_SHA=$(git rev-list --parents -n 1 "$HEAD_SHA" | awk '{print $2}')
            if [ -n "$BASE_SHA" ]; then
              git fetch --no-tags --prune --depth=1 origin "$BASE_SHA" || true
            else
              BASE_SHA="$HEAD_SHA"
            fi
          fi

          node --experimental-strip-types scripts/ciImpact/runImpactedTests.ts --base "$BASE_SHA" --head "$HEAD_SHA" --scripts-only

      - name: Check for circular imports
        run: ./scripts/checks/checkCircularImports.ts

      - name: Check dependency graph constraints
        run: ./scripts/checks/checkDependencyCruiser.sh

      - name: Cache SQLite WASM
        uses: actions/cache@v4
        with:
          path: |
            packages/client/src/workers/sqlite-wasm
            packages/client/public/sqlite
            packages/client/public/assets/sqlite3-opfs-async-proxy.js
          key: sqlite-wasm-${{ hashFiles('scripts/downloadSqliteWasm.sh') }}

      - name: Download SQLite WASM
        run: ./scripts/downloadSqliteWasm.sh

      - name: Install Playwright for mermaid rendering
        run: pnpm --filter @tearleads/website exec playwright install chromium

      - name: Generate app configs
        run: |
          npm install -g tsx
          cd packages/app-builder
          tsx src/cli.ts generate --app tearleads

      - name: Type check
        run: pnpm exec tsc -b

      - name: Build
        run: pnpm build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-dist
          path: |
            packages/*/dist
            !packages/*/node_modules
          retention-days: 1

  # Unit tests run in parallel matrix
  test:
    needs: [detect-impact, typecheck-build]
    if: ${{ (github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true') && needs.detect-impact.outputs.test-should-run == 'true' }}
    runs-on: ${{ vars.USE_SELF_HOSTED == 'true' && 'self-hosted' || 'ubuntu-latest' }}
    timeout-minutes: 25
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.detect-impact.outputs.test-packages) }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Setup Ruby
        if: ${{ vars.USE_SELF_HOSTED != 'true' }}
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3.0'
          bundler-cache: true
          working-directory: packages/client

      - name: Install Ruby dependencies (self-hosted)
        if: ${{ vars.USE_SELF_HOSTED == 'true' }}
        run: bundle install
        working-directory: packages/client

      - name: Install dependencies
        run: pnpm install

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-dist
          path: packages

      - name: Cache SQLite WASM
        uses: actions/cache@v4
        with:
          path: |
            packages/client/src/workers/sqlite-wasm
            packages/client/public/sqlite
            packages/client/public/assets/sqlite3-opfs-async-proxy.js
          key: sqlite-wasm-${{ hashFiles('scripts/downloadSqliteWasm.sh') }}

      - name: Download SQLite WASM
        run: ./scripts/downloadSqliteWasm.sh

      - name: Generate app configs
        if: matrix.package == 'client'
        run: |
          npm install -g tsx
          cd packages/app-builder
          tsx src/cli.ts generate --app tearleads

      - name: Test with Coverage
        run: pnpm --filter @tearleads/${{ matrix.package }} test:coverage

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.package }}
          path: packages/${{ matrix.package }}/coverage/
          retention-days: 30

  # Tuxedo shell tests (separate job)
  test-tuxedo:
    needs: [detect-impact, typecheck-build]
    if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
    runs-on: ${{ vars.USE_SELF_HOSTED == 'true' && 'self-hosted' || 'ubuntu-latest' }}
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Setup Ruby
        if: ${{ vars.USE_SELF_HOSTED != 'true' }}
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3.0'
          bundler-cache: true
          working-directory: packages/client

      - name: Install dependencies
        run: pnpm install

      - name: Install bashcov
        run: gem install bashcov

      - name: Test with Coverage
        run: pnpm test:coverage

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-tuxedo
          path: tuxedo/tests/coverage/
          retention-days: 30

  # Aggregate coverage reports and create summary
  coverage-summary:
    needs: [detect-impact, test, test-tuxedo]
    if: ${{ always() && (github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true') && needs.detect-impact.outputs.test-should-run == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Download all coverage artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-*
          path: coverage-reports

      - name: Reorganize coverage reports
        run: |
          mkdir -p packages
          for report_dir in coverage-reports/coverage-*; do
            if [ ! -d "$report_dir" ]; then
              continue
            fi
            pkg="$(basename "$report_dir")"
            pkg="${pkg#coverage-}"
            if [ "$pkg" = "tuxedo" ]; then
              continue
            fi
            mkdir -p "packages/$pkg/coverage"
            cp -r "$report_dir"/* "packages/$pkg/coverage/" 2>/dev/null || true
          done
          if [ -d "coverage-reports/coverage-tuxedo" ]; then
            mkdir -p "tuxedo/tests/coverage"
            cp -r "coverage-reports/coverage-tuxedo"/* "tuxedo/tests/coverage/" 2>/dev/null || true
          fi

      - name: Upload Combined Coverage Reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            packages/*/coverage/
            tuxedo/tests/coverage/
          retention-days: 30

      - name: Coverage Summary
        run: |
          echo "## Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for summary in packages/*/coverage/coverage-summary.json; do
            if [ ! -f "$summary" ]; then
              continue
            fi
            pkg="$(echo "$summary" | awk -F'/' '{print $2}')"
            echo "### @tearleads/$pkg" >> $GITHUB_STEP_SUMMARY
            node -e "
              const summary = require('./$summary');
              const total = summary.total;
              console.log('| Metric | Coverage |');
              console.log('|--------|----------|');
              console.log('| Lines | ' + total.lines.pct + '% |');
              console.log('| Statements | ' + total.statements.pct + '% |');
              console.log('| Functions | ' + total.functions.pct + '% |');
              console.log('| Branches | ' + total.branches.pct + '% |');
            " >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          done

  # Final build status (for branch protection)
  build:
    needs: [detect-impact, lint, guardrails, typecheck-build, test, test-tuxedo, coverage-summary]
    if: ${{ always() }}
    runs-on: ubuntu-latest
    steps:
      - name: Report no impact detected
        if: ${{ github.event_name != 'workflow_dispatch' && needs.detect-impact.outputs.should-run != 'true' }}
        run: |
          echo "::notice::No code changes detected that impact this job - reporting success"
          echo "## Build Skipped" >> "$GITHUB_STEP_SUMMARY"
          echo "No code changes detected that require this job to run." >> "$GITHUB_STEP_SUMMARY"

      - name: Check job results
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: |
          TEST_MATRIX_REQUIRED="${{ needs.detect-impact.outputs.test-should-run }}"

          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.guardrails.result }}" != "success" ] || \
             [ "${{ needs.typecheck-build.result }}" != "success" ] || \
             [ "${{ needs.test-tuxedo.result }}" != "success" ]; then
            echo "One or more jobs did not complete successfully"
            exit 1
          fi

          if [ "$TEST_MATRIX_REQUIRED" = "true" ]; then
            if [ "${{ needs.test.result }}" != "success" ] || \
               [ "${{ needs.coverage-summary.result }}" != "success" ]; then
              echo "One or more jobs did not complete successfully"
              exit 1
            fi
          else
            if [ "${{ needs.test.result }}" != "skipped" ] && \
               [ "${{ needs.test.result }}" != "success" ]; then
              echo "Unexpected test job result: ${{ needs.test.result }}"
              exit 1
            fi
            if [ "${{ needs.coverage-summary.result }}" != "skipped" ] && \
               [ "${{ needs.coverage-summary.result }}" != "success" ]; then
              echo "Unexpected coverage-summary job result: ${{ needs.coverage-summary.result }}"
              exit 1
            fi
          fi

          echo "All jobs passed successfully"
