name: build

on:
  pull_request:
  workflow_call:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-impact:
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.impact.outputs.should-run }}
      impact-json: ${{ steps.impact.outputs.impact-json }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Install tsx
        run: npm install -g tsx

      - name: Analyze CI impact
        id: impact
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            git fetch --no-tags --prune --depth=2 origin "${{ github.ref_name }}" || true
            BASE_SHA=$(git rev-parse HEAD^ 2>/dev/null || echo "${{ github.sha }}")
            HEAD_SHA="${{ github.sha }}"
          fi

          tsx scripts/ciImpact/ciImpact.ts --base "$BASE_SHA" --head "$HEAD_SHA" > ci-impact.json
          SHOULD_RUN="$(jq -r '.jobs["build"].run' ci-impact.json)"
          echo "should-run=$SHOULD_RUN" >> "$GITHUB_OUTPUT"
          echo "impact-json<<JSON" >> "$GITHUB_OUTPUT"
          cat ci-impact.json >> "$GITHUB_OUTPUT"
          echo "JSON" >> "$GITHUB_OUTPUT"

      - name: Publish impact summary
        if: ${{ always() }}
        run: |
          echo "### CI impact (build)" >> "$GITHUB_STEP_SUMMARY"
          jq -r '"- build: " + (.jobs["build"].run|tostring) + " (" + (.jobs["build"].reasons|join(", ")) + ")"' ci-impact.json >> "$GITHUB_STEP_SUMMARY"
          jq -r '"- changed packages: " + (.changedPackages|join(", "))' ci-impact.json >> "$GITHUB_STEP_SUMMARY"
          jq -r 'if (.warnings|length) > 0 then "- warnings: " + (.warnings|join("; ")) else "- warnings: none" end' ci-impact.json >> "$GITHUB_STEP_SUMMARY"

  build:
    needs: detect-impact
    runs-on: ${{ vars.USE_SELF_HOSTED == 'true' && 'self-hosted' || 'ubuntu-latest' }}
    timeout-minutes: 20

    steps:
      - name: Report no impact detected
        if: ${{ github.event_name != 'workflow_dispatch' && needs.detect-impact.outputs.should-run != 'true' }}
        run: |
          echo "::notice::No code changes detected that impact this job - reporting success"
          echo "## Build Skipped" >> "$GITHUB_STEP_SUMMARY"
          echo "No code changes detected that require this job to run." >> "$GITHUB_STEP_SUMMARY"

      - uses: actions/checkout@v4
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}

      - name: Check for binary files
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: ./scripts/checkBinaryFiles.sh --from-upstream

      - name: Check for plain JavaScript files
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: ./scripts/checkJs.sh --from-upstream

      - name: Verify binary guardrails
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: ./scripts/verifyBinaryGuardrails.sh

      - name: Setup pnpm
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Setup Ruby
        if: ${{ (github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true') && vars.USE_SELF_HOSTED != 'true' }}
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3.0'
          bundler-cache: true
          working-directory: packages/client

      - name: Install Ruby dependencies (self-hosted)
        if: ${{ (github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true') && vars.USE_SELF_HOSTED == 'true' }}
        run: bundle install
        working-directory: packages/client

      - name: Install dependencies
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: pnpm install

      - name: Cache SQLite WASM
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        uses: actions/cache@v4
        with:
          path: |
            packages/client/src/workers/sqlite-wasm
            packages/client/public/sqlite
            packages/client/public/assets/sqlite3-opfs-async-proxy.js
          key: sqlite-wasm-${{ hashFiles('scripts/downloadSqliteWasm.sh') }}

      - name: Download SQLite WASM
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: ./scripts/downloadSqliteWasm.sh

      - name: Install Playwright for mermaid rendering
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: pnpm --filter @tearleads/website exec playwright install chromium

      - name: Lint
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: pnpm lint

      - name: Lint scripts
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: pnpm lint:scripts

      - name: Lint Markdown
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: pnpm lint:md

      - name: Lint RuboCop
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: pnpm lint:rubocop

      - name: Setup Python
        if: ${{ (github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true') && vars.USE_SELF_HOSTED != 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version-file: '.python-version'
          cache: 'pip'

      - name: Install ansible-lint
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: pip3 install ansible-lint ansible passlib

      - name: Cache Ansible collections
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        uses: actions/cache@v4
        with:
          path: ~/.ansible/collections
          key: ansible-collections-${{ hashFiles('ansible/requirements.yml') }}

      - name: Install Ansible collections
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: ansible-galaxy collection install -r ansible/requirements.yml

      - name: Lint Ansible
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: pnpm lint:ansible

      - name: Type check
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: pnpm exec tsc -b

      - name: Build
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: pnpm build

      - name: Install bashcov
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: gem install bashcov

      - name: Test with Coverage
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: |
          pnpm --filter @tearleads/shared test:coverage
          pnpm --filter @tearleads/ui test:coverage
          pnpm --filter @tearleads/window-manager test:coverage
          pnpm --filter @tearleads/audio test:coverage
          pnpm --filter @tearleads/terminal test:coverage
          pnpm --filter @tearleads/keychain test:coverage
          pnpm --filter @tearleads/api test:coverage
          pnpm --filter @tearleads/smtp-listener test:coverage
          pnpm --filter @tearleads/client test:coverage
          pnpm --filter @tearleads/chrome-extension test:coverage
          pnpm --filter @tearleads/website test:coverage
          pnpm test:coverage

      - name: Upload Coverage Reports
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            packages/shared/coverage/
            packages/ui/coverage/
            packages/window-manager/coverage/
            packages/audio/coverage/
            packages/terminal/coverage/
            packages/keychain/coverage/
            packages/api/coverage/
            packages/smtp-listener/coverage/
            packages/client/coverage/
            packages/chrome-extension/coverage/
            packages/website/coverage/
            tuxedo/tests/coverage/
          retention-days: 30

      - name: Coverage Summary
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: |
          echo "## Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for pkg in shared ui window-manager audio terminal keychain api smtp-listener client chrome-extension website; do
            if [ -f "packages/$pkg/coverage/coverage-summary.json" ]; then
              echo "### @tearleads/$pkg" >> $GITHUB_STEP_SUMMARY
              node -e "
                const summary = require('./packages/$pkg/coverage/coverage-summary.json');
                const total = summary.total;
                console.log('| Metric | Coverage |');
                console.log('|--------|----------|');
                console.log('| Lines | ' + total.lines.pct + '% |');
                console.log('| Statements | ' + total.statements.pct + '% |');
                console.log('| Functions | ' + total.functions.pct + '% |');
                console.log('| Branches | ' + total.branches.pct + '% |');
              " >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done
