name: CI

on:
  push:
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.vscode/**'
      - 'LICENSE'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      core: ${{ steps.filter.outputs.core }}
      client-src: ${{ steps.filter.outputs.client-src }}
      api: ${{ steps.filter.outputs.api }}
      mobile: ${{ steps.filter.outputs.mobile }}
      electron: ${{ steps.filter.outputs.electron }}
      web-e2e-tests: ${{ steps.filter.outputs.web-e2e-tests }}
      website: ${{ steps.filter.outputs.website }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            core:
              - 'packages/shared/**'
              - 'packages/ui/**'
              - '.github/workflows/build.yml'
              - '.github/workflows/web-e2e.yml'
              - '.github/workflows/website-e2e.yml'
              - '.github/workflows/electron-e2e.yml'
              - '.github/workflows/android.yml'
              - '.github/workflows/android-maestro-release.yml'
              - '.github/workflows/ios-maestro-release.yml'
              - '.github/workflows/deploy-gate.yml'
              - 'package.json'
              - 'pnpm-lock.yaml'
              - 'pnpm-workspace.yaml'
              - 'turbo.json'
            client-src:
              - 'packages/client/src/**'
            api:
              - 'packages/api/**'
            mobile:
              - 'packages/client/android/**'
              - 'packages/client/ios/**'
              - 'packages/client/.maestro/**'
              - 'packages/client/capacitor.config.ts'
              - 'packages/client/fastlane/**'
            electron:
              - 'packages/client/electron/**'
              - 'packages/client/tests/electron/**'
            web-e2e-tests:
              - 'packages/client/tests/*.spec.ts'
              - 'packages/client/playwright.config.ts'
            website:
              - 'packages/website/**'

      - name: Write change summary
        run: |
          cat > changes.json <<EOF
          {
            "run_event": "${{ github.event_name }}",
            "core": "${{ steps.filter.outputs.core }}",
            "client-src": "${{ steps.filter.outputs.client-src }}",
            "api": "${{ steps.filter.outputs.api }}",
            "mobile": "${{ steps.filter.outputs.mobile }}",
            "electron": "${{ steps.filter.outputs.electron }}",
            "web-e2e-tests": "${{ steps.filter.outputs.web-e2e-tests }}",
            "website": "${{ steps.filter.outputs.website }}"
          }
          EOF

      - name: Upload change summary
        uses: actions/upload-artifact@v4
        with:
          name: detect-changes
          path: changes.json
          retention-days: 7

  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3.0'
          bundler-cache: true
          working-directory: packages/client

      - name: Install dependencies
        run: pnpm install

      - name: Download SQLite WASM
        run: ./scripts/downloadSqliteWasm.sh

      - name: Install Playwright for mermaid rendering
        run: pnpm --filter @rapid/website exec playwright install chromium

      - name: Lint
        run: pnpm lint

      - name: Lint scripts
        run: pnpm lint:scripts

      - name: Lint Markdown
        run: pnpm lint:md

      - name: Lint RuboCop
        run: pnpm lint:rubocop

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version-file: '.python-version'

      - name: Install ansible-lint
        run: pip install ansible-lint ansible

      - name: Install Ansible collections
        run: ansible-galaxy collection install -r ansible/requirements.yml

      - name: Lint Ansible
        run: pnpm lint:ansible

      - name: Type check
        run: pnpm exec tsc -b

      - name: Build
        run: pnpm build

      - name: Test with Coverage
        run: |
          pnpm --filter @rapid/shared test:coverage
          pnpm --filter @rapid/ui test:coverage
          pnpm --filter @rapid/api test:coverage
          pnpm --filter @rapid/client test:coverage
          pnpm --filter @rapid/chrome-extension test:coverage
          pnpm --filter @rapid/website test:coverage

      - name: Upload Coverage Reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            packages/shared/coverage/
            packages/ui/coverage/
            packages/api/coverage/
            packages/client/coverage/
            packages/chrome-extension/coverage/
            packages/website/coverage/
          retention-days: 30

      - name: Coverage Summary
        run: |
          echo "## Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for pkg in shared ui api client chrome-extension website; do
            if [ -f "packages/$pkg/coverage/coverage-summary.json" ]; then
              echo "### @rapid/$pkg" >> $GITHUB_STEP_SUMMARY
              node -e "
                const summary = require('./packages/$pkg/coverage/coverage-summary.json');
                const total = summary.total;
                console.log('| Metric | Coverage |');
                console.log('|--------|----------|');
                console.log('| Lines | ' + total.lines.pct + '% |');
                console.log('| Statements | ' + total.statements.pct + '% |');
                console.log('| Functions | ' + total.functions.pct + '% |');
                console.log('| Branches | ' + total.branches.pct + '% |');
              " >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done
