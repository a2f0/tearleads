name: Main Version Bump

on:
  workflow_run:
    workflows: ["build"]
    types: [completed]
    branches: [main]

permissions:
  contents: write

concurrency:
  group: main-version-bump
  cancel-in-progress: false

jobs:
  bump:
    name: Bump Versions On Main
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ${{ vars.USE_SELF_HOSTED == 'true' && 'self-hosted' || 'ubuntu-latest' }}
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          persist-credentials: false

      - name: Prepare source diff
        id: prepare
        env:
          SOURCE_SHA: ${{ github.event.workflow_run.head_sha }}
          SOURCE_MESSAGE: ${{ github.event.workflow_run.head_commit.message }}
        run: |
          set -eu

          if echo "$SOURCE_MESSAGE" | grep -Eq '^chore\(release\): bump versions'; then
            echo "skip_reason=bump_commit" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git fetch --no-tags origin "$SOURCE_SHA" main

          if git log --format=%B origin/main | grep -Fxq "source-sha: $SOURCE_SHA"; then
            echo "skip_reason=already_processed_source" >> "$GITHUB_OUTPUT"
            exit 0
          fi

      - name: Check merge-signing app credentials
        id: app-credentials
        if: steps.prepare.outputs.skip_reason == ''
        env:
          MERGE_SIGNING_APP_ID: ${{ secrets.MERGE_SIGNING_APP_ID }}
          MERGE_SIGNING_APP_PRIVATE_KEY: ${{ secrets.MERGE_SIGNING_APP_PRIVATE_KEY }}
        run: |
          set -eu

          if [ -n "$MERGE_SIGNING_APP_ID" ] && [ -n "$MERGE_SIGNING_APP_PRIVATE_KEY" ]; then
            echo "available=true" >> "$GITHUB_OUTPUT"
          else
            echo "available=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create merge-signing app token
        id: app-token
        if: steps.prepare.outputs.skip_reason == '' && steps.app-credentials.outputs.available == 'true'
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.MERGE_SIGNING_APP_ID }}
          private-key: ${{ secrets.MERGE_SIGNING_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Bump versions directly on main with retries
        if: steps.prepare.outputs.skip_reason == ''
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token || github.token }}
          HAS_APP_TOKEN: ${{ steps.app-token.outputs.token != '' && 'true' || 'false' }}
          SOURCE_SHA: ${{ github.event.workflow_run.head_sha }}
          SOURCE_RUN_ID: ${{ github.event.workflow_run.id }}
          REPO: ${{ github.repository }}
        run: |
          set -eu

          ATTEMPTS=5
          UPDATED=false
          APPLIED_COMMITS=0
          EXPECTED_MAIN_SHA=""

          for attempt in $(seq 1 "$ATTEMPTS"); do
            echo "Attempt $attempt/$ATTEMPTS" | tee -a "$GITHUB_STEP_SUMMARY"

            git fetch --no-tags origin main "$SOURCE_SHA" || true
            EXPECTED_MAIN_SHA=$(git rev-parse origin/main)
            git checkout -B ci/main-version-bump-work "$EXPECTED_MAIN_SHA"
            git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git"

            PROCESSED_SOURCES="$RUNNER_TEMP/processed-sources.txt"
            git log --format=%B origin/main | sed -n 's/^source-sha: //p' | awk 'NF' > "$PROCESSED_SOURCES"
            REV_RANGE="$SOURCE_SHA"
            LATEST_PROCESSED_SOURCE=$(git log --first-parent --format=%B origin/main | sed -n 's/^source-sha: //p' | head -n1 || true)
            if [ -n "$LATEST_PROCESSED_SOURCE" ] && git merge-base --is-ancestor "$LATEST_PROCESSED_SOURCE" "$SOURCE_SHA"; then
              REV_RANGE="${LATEST_PROCESSED_SOURCE}..${SOURCE_SHA}"
            fi
            PENDING_SOURCES="$RUNNER_TEMP/pending-sources.txt"
            : > "$PENDING_SOURCES"

            git rev-list --first-parent --reverse "$REV_RANGE" | while IFS= read -r candidate_sha; do
              [ -n "$candidate_sha" ] || continue

              if grep -Fxq "$candidate_sha" "$PROCESSED_SOURCES"; then
                continue
              fi

              CANDIDATE_MESSAGE=$(git show -s --format=%B "$candidate_sha")
              if echo "$CANDIDATE_MESSAGE" | grep -Eq '^chore\(release\): bump versions'; then
                continue
              fi

              CANDIDATE_PARENT_SHA=$(git rev-list --parents -n 1 "$candidate_sha" | awk '{print $2}')
              if [ -z "$CANDIDATE_PARENT_SHA" ]; then
                continue
              fi

              CURRENT_CHANGED_FILES="$RUNNER_TEMP/changed-$candidate_sha.txt"
              git diff --name-only "$CANDIDATE_PARENT_SHA" "$candidate_sha" > "$CURRENT_CHANGED_FILES"

              if grep -Eq '^packages/' "$CURRENT_CHANGED_FILES"; then
                echo "$candidate_sha" >> "$PENDING_SOURCES"
              fi
            done

            if [ ! -s "$PENDING_SOURCES" ]; then
              {
                echo "## Main Version Bump"
                echo "No pending source commits to process."
                echo "Source commit: $SOURCE_SHA"
                if [ "$HAS_APP_TOKEN" = "false" ]; then
                  echo "Authentication: GITHUB_TOKEN fallback"
                else
                  echo "Authentication: merge-signing GitHub App token"
                fi
              } >> "$GITHUB_STEP_SUMMARY"
              exit 0
            fi

            if [ "$HAS_APP_TOKEN" = "true" ]; then
              git config user.name "merge-signing[bot]"
              git config user.email "merge-signing[bot]@users.noreply.github.com"
            else
              git config user.name "github-actions[bot]"
              git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            fi

            APPLIED_COMMITS=0
            while IFS= read -r pending_source_sha; do
              [ -n "$pending_source_sha" ] || continue

              if ! git rev-parse --verify "$pending_source_sha^{commit}" >/dev/null 2>&1; then
                git fetch --no-tags origin "$pending_source_sha" || true
              fi

              if ! git rev-parse --verify "$pending_source_sha^{commit}" >/dev/null 2>&1; then
                echo "Unable to resolve source commit $pending_source_sha; skipping."
                continue
              fi

              PARENT_SHA=$(git rev-list --parents -n 1 "$pending_source_sha" | awk '{print $2}')
              if [ -z "$PARENT_SHA" ]; then
                continue
              fi

              CURRENT_CHANGED_FILES="$RUNNER_TEMP/changed-$pending_source_sha.txt"
              git diff --name-only "$PARENT_SHA" "$pending_source_sha" > "$CURRENT_CHANGED_FILES"

              if ! grep -Eq '^packages/' "$CURRENT_CHANGED_FILES"; then
                continue
              fi

              BASE_BRANCH=main CHANGED_FILES_FILE="$CURRENT_CHANGED_FILES" ./scripts/bumpVersion.sh

              if git diff --quiet; then
                continue
              fi

              git add -A
              if git diff --cached --quiet; then
                continue
              fi

              COMMIT_SOURCE_RUN_ID="replay"
              if [ "$pending_source_sha" = "$SOURCE_SHA" ]; then
                COMMIT_SOURCE_RUN_ID="$SOURCE_RUN_ID"
              fi

              git commit \
                -m "chore(release): bump versions" \
                -m "source-sha: $pending_source_sha" \
                -m "source-run-id: $COMMIT_SOURCE_RUN_ID"
              APPLIED_COMMITS=$((APPLIED_COMMITS + 1))
            done < "$PENDING_SOURCES"

            if [ "$APPLIED_COMMITS" -eq 0 ]; then
              {
                echo "## Main Version Bump"
                echo "No version changes were required for source $SOURCE_SHA."
              } >> "$GITHUB_STEP_SUMMARY"
              exit 0
            fi

            if git push --force-with-lease=refs/heads/main:"$EXPECTED_MAIN_SHA" origin HEAD:main; then
              UPDATED=true
              {
                echo "## Main Version Bump"
                echo "Updated main directly on attempt $attempt/$ATTEMPTS."
                echo "Source commit: $SOURCE_SHA"
                echo "Applied bump commits: $APPLIED_COMMITS"
                echo "Expected main before push: $EXPECTED_MAIN_SHA"
                if [ "$HAS_APP_TOKEN" = "false" ]; then
                  echo "Authentication: GITHUB_TOKEN fallback"
                else
                  echo "Authentication: merge-signing GitHub App token"
                fi
              } >> "$GITHUB_STEP_SUMMARY"
              break
            fi

            sleep $((attempt * 2))
          done

          if [ "$UPDATED" != "true" ]; then
            {
              echo "## Main Version Bump"
              echo "Failed to update main directly after $ATTEMPTS attempts."
              echo "Source commit: $SOURCE_SHA"
              echo "Last expected main SHA: $EXPECTED_MAIN_SHA"
            } >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi

      - name: Summarize skipped run
        if: steps.prepare.outputs.skip_reason != ''
        env:
          SKIP_REASON: ${{ steps.prepare.outputs.skip_reason }}
          SOURCE_SHA: ${{ github.event.workflow_run.head_sha }}
        run: |
          set -eu
          {
            echo "## Main Version Bump"
            echo "Skipped bump run."
            echo "Reason: $SKIP_REASON"
            echo "Source commit: $SOURCE_SHA"
          } >> "$GITHUB_STEP_SUMMARY"
