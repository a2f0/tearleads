name: Integration & Deploy

on:
  workflow_run:
    workflows: ["build"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

concurrency:
  group: integration-deploy-${{ github.ref_name }}
  cancel-in-progress: true

permissions:
  contents: write
  actions: read

jobs:
  check-build:
    name: Verify Build Success
    runs-on: ${{ vars.USE_SELF_HOSTED == 'true' && 'self-hosted' || 'ubuntu-latest' }}
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    steps:
      - run: echo "Build succeeded, proceeding with integration tests and deploy"

  web-e2e:
    name: Web E2E
    needs: check-build
    uses: ./.github/workflows/web-e2e.yml

  website-e2e:
    name: Website E2E
    needs: check-build
    uses: ./.github/workflows/website-e2e.yml

  electron-e2e:
    name: Electron E2E
    needs: check-build
    uses: ./.github/workflows/electron-e2e.yml

  android:
    name: Android Tests
    needs: check-build
    uses: ./.github/workflows/android.yml
    secrets: inherit

  android-maestro:
    name: Android Maestro
    needs: check-build
    uses: ./.github/workflows/android-maestro-release.yml
    secrets: inherit

  ios-maestro:
    name: iOS Maestro
    needs: check-build
    uses: ./.github/workflows/ios-maestro-release.yml
    secrets: inherit

  deploy-web:
    name: Deploy Web
    needs: [web-e2e, website-e2e, electron-e2e]
    uses: ./.github/workflows/deploy-web.yml
    secrets: inherit

  publish-staging-containers:
    name: Publish Staging Containers
    needs: [web-e2e, website-e2e, electron-e2e]
    uses: ./.github/workflows/publish-staging-containers.yml
    permissions:
      contents: read
      id-token: write
    secrets: inherit

  deploy-staging-k8s:
    name: Deploy Staging K8s
    needs: [publish-staging-containers]
    uses: ./.github/workflows/deploy-staging-k8s.yml
    permissions:
      contents: read
      id-token: write
    secrets: inherit

  deploy-android:
    name: Deploy Android
    needs: [android, android-maestro]
    uses: ./.github/workflows/deploy-android-play-store.yml
    secrets: inherit

  deploy-ios:
    name: Deploy iOS
    needs: [ios-maestro]
    uses: ./.github/workflows/deploy-ios-testflight.yml
    secrets: inherit

  deploy-desktop:
    name: Deploy Desktop
    needs: [web-e2e, electron-e2e]
    uses: ./.github/workflows/deploy-desktop.yml
    secrets: inherit
