name: iOS Maestro Tests (Release)

on:
  pull_request:
  workflow_call:

jobs:
  detect-impact:
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.impact.outputs.should-run }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Install tsx
        run: npm install -g tsx

      - name: Analyze CI impact
        id: impact
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          tsx scripts/ciImpact/ciImpact.ts --base "$BASE_SHA" --head "$HEAD_SHA" > ci-impact.json
          SHOULD_RUN="$(jq -r '.jobs["ios-maestro-release"].run' ci-impact.json)"
          echo "should-run=$SHOULD_RUN" >> "$GITHUB_OUTPUT"
          cat ci-impact.json

  ios-maestro-release:
    name: iOS Maestro Tests (Release)
    needs: detect-impact
    if: ${{ github.event_name == 'workflow_call' || needs.detect-impact.outputs.should-run == 'true' }}
    runs-on: macos-latest
    timeout-minutes: 35
    env:
      XCODE_VERSION: 'latest-stable'

    steps:
      - uses: actions/checkout@v4

      - name: Capture runner hardware specs
        run: |
          mkdir -p packages/client/maestro-debug
          {
            echo "=== Runner Hardware Specs ==="
            echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo ""
            echo "=== CPU ==="
            sysctl -n machdep.cpu.brand_string
            echo "CPU cores: $(sysctl -n hw.ncpu)"
            echo "Physical CPUs: $(sysctl -n hw.physicalcpu)"
            echo ""
            echo "=== Memory ==="
            echo "Total RAM: $(( $(sysctl -n hw.memsize) / 1024 / 1024 / 1024 )) GB"
            vm_stat | head -10
            echo ""
            echo "=== Disk ==="
            df -h /
            echo ""
            echo "=== Load Average ==="
            uptime
            echo ""
            echo "=== Runner Info ==="
            echo "Runner OS: $RUNNER_OS"
            echo "Runner Arch: $RUNNER_ARCH"
            echo "Runner Name: $RUNNER_NAME"
            sw_vers
          } > packages/client/maestro-debug/hardware-specs.txt
          cat packages/client/maestro-debug/hardware-specs.txt

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3.0'
          bundler-cache: true
          working-directory: packages/client

      - name: Install dependencies
        run: pnpm install

      - name: Download SQLite WASM
        run: ./scripts/downloadSqliteWasm.sh

      - name: Build API (for OpenAPI spec)
        run: pnpm --filter @tearleads/api build

      - name: Build window-manager
        run: pnpm --filter @tearleads/window-manager build

      - name: Build UI
        run: pnpm --filter @tearleads/ui build

      - name: Build notes
        run: pnpm --filter @tearleads/notes build

      - name: Build email
        run: pnpm --filter @tearleads/email build

      - name: Build vfs-explorer
        run: pnpm --filter @tearleads/vfs-explorer build

      - name: Build audio
        run: pnpm --filter @tearleads/audio build

      - name: Build contacts
        run: pnpm --filter @tearleads/contacts build

      - name: Build db-test-utils
        run: pnpm --filter @tearleads/db-test-utils build

      - name: Build web assets
        run: pnpm --filter @tearleads/client build

      - name: Install ImageMagick
        run: brew install imagemagick

      - name: Generate iOS images
        run: ./packages/client/scripts/buildIosImageAssets.sh

      - name: Install CocoaPods dependencies
        run: pod install
        working-directory: packages/client/ios/App

      - name: Sync Capacitor
        run: pnpm --filter @tearleads/client run cap:sync

      - name: Build iOS release app for simulator
        run: bundle exec fastlane ios build_release_simulator
        working-directory: packages/client

      - name: Install Maestro
        run: curl -Ls "https://get.maestro.mobile.dev" | bash

      - name: Boot iOS simulator
        run: |
          # List available devices for debugging
          echo "Available simulators:"
          xcrun simctl list devices available | head -20

          # Prefer iPhone SE for faster boot and lower resource usage
          DEVICE=$(xcrun simctl list devices available | grep "iPhone SE" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')

          if [ -z "$DEVICE" ]; then
            echo "No iPhone SE found, trying iPhone 16/15"
            DEVICE=$(xcrun simctl list devices available | grep -E "iPhone (16|15)" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')
          fi

          if [ -z "$DEVICE" ]; then
            echo "No iPhone 15/16 found, trying any iPhone"
            DEVICE=$(xcrun simctl list devices available | grep "iPhone" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')
          fi

          if [ -z "$DEVICE" ]; then
            echo "ERROR: No iPhone simulator found"
            exit 1
          fi

          echo "Using simulator: $DEVICE"
          xcrun simctl shutdown "$DEVICE" || true
          xcrun simctl erase "$DEVICE"
          xcrun simctl boot "$DEVICE"
          xcrun simctl bootstatus "$DEVICE" -b
          echo "SIMULATOR_UDID=$DEVICE" >> $GITHUB_ENV

      - name: Install app on simulator
        run: |
          # Release build outputs to DerivedData-Release
          APP_PATH="packages/client/build/DerivedData-Release/Build/Products/Release-iphonesimulator/App.app"
          if [ ! -d "$APP_PATH" ]; then
            echo "App not found at expected path, searching..."
            APP_PATH=$(find . -name "App.app" -path "*Release-iphonesimulator*" -type d | head -1)
          fi
          echo "Installing release app from: $APP_PATH"
          xcrun simctl install "$SIMULATOR_UDID" "$APP_PATH"

      - name: Preflight app launch
        run: |
          xcrun simctl launch "$SIMULATOR_UDID" com.tearleads.app
          sleep 3
          xcrun simctl terminate "$SIMULATOR_UDID" com.tearleads.app || true

      - name: Run Maestro tests
        env:
          MAESTRO_DRIVER_STARTUP_TIMEOUT: 600000
        run: |
          # Run Maestro tests (capture exit code before || continues execution)
          MAESTRO_EXIT=0
          $HOME/.maestro/bin/maestro test .maestro/ --output maestro-debug/report.xml --debug-output maestro-debug --format junit || MAESTRO_EXIT=$?

          # Capture final screenshot
          xcrun simctl io "$SIMULATOR_UDID" screenshot maestro-debug/02-after-tests.png || true

          # Get device logs
          xcrun simctl spawn "$SIMULATOR_UDID" log show --last 5m --predicate 'subsystem contains "com.tearleads"' > maestro-debug/device-logs.txt 2>&1 || true

          # Copy crash reports from DiagnosticReports
          mkdir -p maestro-debug/crash-reports
          cp -r ~/Library/Logs/DiagnosticReports/* maestro-debug/crash-reports/ 2>/dev/null || true

          exit $MAESTRO_EXIT
        working-directory: packages/client

      - name: Upload Maestro artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ios-maestro-release-artifacts
          path: packages/client/maestro-debug/
          retention-days: 7
          if-no-files-found: ignore
