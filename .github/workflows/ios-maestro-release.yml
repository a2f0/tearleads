name: iOS Maestro Tests (Release)

on:
  pull_request:
  workflow_call:
  workflow_dispatch:

jobs:
  detect-impact:
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.impact.outputs.should-run }}
      impact-json: ${{ steps.impact.outputs.impact-json }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Analyze CI impact
        id: impact
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            HEAD_SHA="${{ github.sha }}"
            git fetch --no-tags --prune --depth=2 origin "$HEAD_SHA" || true
            BASE_SHA=$(git rev-list --parents -n 1 "$HEAD_SHA" | awk '{print $2}')
            if [ -n "$BASE_SHA" ]; then
              git fetch --no-tags --prune --depth=1 origin "$BASE_SHA" || true
            else
              BASE_SHA="$HEAD_SHA"
            fi
          fi

          pnpm exec tsx scripts/ciImpact/ciImpact.ts --base "$BASE_SHA" --head "$HEAD_SHA" > ci-impact.json
          SHOULD_RUN="$(jq -r '.jobs["ios-maestro-release"].run' ci-impact.json)"
          echo "should-run=$SHOULD_RUN" >> "$GITHUB_OUTPUT"
          echo "impact-json<<JSON" >> "$GITHUB_OUTPUT"
          cat ci-impact.json >> "$GITHUB_OUTPUT"
          echo "JSON" >> "$GITHUB_OUTPUT"

      - name: Publish impact summary
        if: ${{ always() }}
        run: |
          echo "### CI impact (ios-maestro-release)" >> "$GITHUB_STEP_SUMMARY"
          jq -r '"- ios-maestro-release: " + (.jobs["ios-maestro-release"].run|tostring) + " (" + (.jobs["ios-maestro-release"].reasons|join(", ")) + ")"' ci-impact.json >> "$GITHUB_STEP_SUMMARY"
          jq -r '"- changed packages: " + (.changedPackages|join(", "))' ci-impact.json >> "$GITHUB_STEP_SUMMARY"
          jq -r 'if (.warnings|length) > 0 then "- warnings: " + (.warnings|join("; ")) else "- warnings: none" end' ci-impact.json >> "$GITHUB_STEP_SUMMARY"

  ios-maestro-release:
    name: iOS Maestro Tests (Release)
    needs: detect-impact
    runs-on: macos-latest
    timeout-minutes: 35
    env:
      XCODE_VERSION: 'latest-stable'

    steps:
      - name: Report no impact detected
        if: ${{ github.event_name != 'workflow_dispatch' && needs.detect-impact.outputs.should-run != 'true' }}
        run: |
          echo "::notice::No code changes detected that impact this job - reporting success"
          echo "## iOS Maestro Tests Skipped" >> "$GITHUB_STEP_SUMMARY"
          echo "No code changes detected that require this job to run." >> "$GITHUB_STEP_SUMMARY"

      - uses: actions/checkout@v4
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}

      - name: Capture runner hardware specs
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: |
          mkdir -p packages/client/maestro-debug
          {
            echo "=== Runner Hardware Specs ==="
            echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo ""
            echo "=== CPU ==="
            sysctl -n machdep.cpu.brand_string
            echo "CPU cores: $(sysctl -n hw.ncpu)"
            echo "Physical CPUs: $(sysctl -n hw.physicalcpu)"
            echo ""
            echo "=== Memory ==="
            echo "Total RAM: $(( $(sysctl -n hw.memsize) / 1024 / 1024 / 1024 )) GB"
            vm_stat | head -10
            echo ""
            echo "=== Disk ==="
            df -h /
            echo ""
            echo "=== Load Average ==="
            uptime
            echo ""
            echo "=== Runner Info ==="
            echo "Runner OS: $RUNNER_OS"
            echo "Runner Arch: $RUNNER_ARCH"
            echo "Runner Name: $RUNNER_NAME"
            sw_vers
          } > packages/client/maestro-debug/hardware-specs.txt
          cat packages/client/maestro-debug/hardware-specs.txt

      - name: Setup Xcode
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Setup pnpm
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Setup Ruby
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3.0'
          bundler-cache: true
          working-directory: packages/client

      - name: Install dependencies
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: pnpm install

      - name: Download SQLite WASM
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: ./scripts/downloadSqliteWasm.sh

      - name: Build API (for OpenAPI spec)
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: pnpm --filter @tearleads/api build

      - name: Build window-manager
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: pnpm --filter @tearleads/window-manager build

      - name: Build UI
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: pnpm --filter @tearleads/ui build

      - name: Build notes
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: pnpm --filter @tearleads/notes build

      - name: Build email
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: pnpm --filter @tearleads/email build

      - name: Build vfs-explorer
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: pnpm --filter @tearleads/vfs-explorer build

      - name: Build ai
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: pnpm --filter @tearleads/ai build

      - name: Build audio
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: pnpm --filter @tearleads/audio build

      - name: Build contacts
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: pnpm --filter @tearleads/contacts build

      - name: Build db-test-utils
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: pnpm --filter @tearleads/db-test-utils build

      - name: Build health
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: pnpm --filter @tearleads/health build

      - name: Build calendar
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: pnpm --filter @tearleads/calendar build

      - name: Build photos
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: pnpm --filter @tearleads/photos build

      - name: Generate app configs
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: |
          npm install -g tsx
          cd packages/app-builder
          tsx src/cli.ts generate --app tearleads

      - name: Build web assets
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: pnpm --filter @tearleads/client build

      - name: Install ImageMagick
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: brew install imagemagick

      - name: Generate iOS images
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: ./packages/client/scripts/buildIosImageAssets.sh

      - name: Install CocoaPods dependencies
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: pod install
        working-directory: packages/client/ios/App

      - name: Sync Capacitor
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: pnpm --filter @tearleads/client run cap:sync

      - name: Build iOS release app for simulator
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: bundle exec fastlane ios build_release_simulator
        working-directory: packages/client

      - name: Install Maestro
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: curl -Ls "https://get.maestro.mobile.dev" | bash

      - name: Boot iOS simulator
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        env:
          # Allow overriding from workflow_call; default to a stable device to reduce churn.
          SIM_DEVICE_NAME: ${{ env.SIM_DEVICE_NAME || '' }}
        run: |
          echo "Available simulators:"
          xcrun simctl list devices available | head -20

          TARGET_NAME="${SIM_DEVICE_NAME:-iPhone 15}"
          DEVICE=$(xcrun simctl list devices available | grep "$TARGET_NAME" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')

          if [ -z "$DEVICE" ]; then
            echo "Preferred device $TARGET_NAME not found, falling back to iPhone 15/14"
            DEVICE=$(xcrun simctl list devices available | grep -E "iPhone (15|14)" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')
          fi

          if [ -z "$DEVICE" ]; then
            echo "No iPhone 14/15 found, choosing any available iPhone"
            DEVICE=$(xcrun simctl list devices available | grep "iPhone" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')
          fi

          if [ -z "$DEVICE" ]; then
            echo "ERROR: No iPhone simulator found"
            exit 1
          fi

          echo "Using simulator: $DEVICE"
          # Avoid erase to reduce boot churn; just ensure it's booted and clean install will overwrite the app.
          BOOT_STATUS=$(xcrun simctl list devices | grep "$DEVICE" | grep -c "(Booted)" || true)
          if [ "$BOOT_STATUS" -eq 0 ]; then
            xcrun simctl boot "$DEVICE"
          fi
          xcrun simctl bootstatus "$DEVICE" -b
          echo "SIMULATOR_UDID=$DEVICE" >> $GITHUB_ENV

      - name: Install app on simulator
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: |
          # Release build outputs to DerivedData-Release
          APP_PATH="packages/client/build/DerivedData-Release/Build/Products/Release-iphonesimulator/App.app"
          if [ ! -d "$APP_PATH" ]; then
            echo "App not found at expected path, searching..."
            APP_PATH=$(find . -name "App.app" -path "*Release-iphonesimulator*" -type d | head -1)
          fi
          echo "Installing release app from: $APP_PATH"
          xcrun simctl install "$SIMULATOR_UDID" "$APP_PATH"

      - name: Preflight app launch
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        run: |
          xcrun simctl launch "$SIMULATOR_UDID" com.tearleads.app
          sleep 3
          xcrun simctl terminate "$SIMULATOR_UDID" com.tearleads.app || true

      - name: Run Maestro tests
        if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true' }}
        env:
          MAESTRO_DRIVER_STARTUP_TIMEOUT: 600000
        run: |
          # Run Maestro tests (capture exit code before || continues execution)
          MAESTRO_EXIT=0
          $HOME/.maestro/bin/maestro test .maestro/ --output maestro-debug/report.xml --debug-output maestro-debug --format junit || MAESTRO_EXIT=$?

          # Capture final screenshot
          xcrun simctl io "$SIMULATOR_UDID" screenshot maestro-debug/02-after-tests.png || true

          # Get device logs
          xcrun simctl spawn "$SIMULATOR_UDID" log show --last 5m --predicate 'subsystem contains "com.tearleads"' > maestro-debug/device-logs.txt 2>&1 || true

          # Copy crash reports from DiagnosticReports
          mkdir -p maestro-debug/crash-reports
          cp -r ~/Library/Logs/DiagnosticReports/* maestro-debug/crash-reports/ 2>/dev/null || true

          exit $MAESTRO_EXIT
        working-directory: packages/client

      - name: Summarize crash reports
        if: ${{ always() && (github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true') }}
        run: |
          REPORT_DIR=packages/client/maestro-debug/crash-reports
          echo "Crash summary (if any):" >> "$GITHUB_STEP_SUMMARY"
          if ls "$REPORT_DIR"/*.ips 1>/dev/null 2>&1; then
            for f in "$REPORT_DIR"/*.ips; do
              name=$(basename "$f")
              proc=$(sed -n 's/^Process: *//p' "$f" | head -1)
              exception=$(sed -n 's/^Exception Type: *//p' "$f" | head -1)
              thread=$(awk '/^Thread [0-9]+ Crashed|^Triggered by Thread/ {print; getline; print; exit}' "$f")
              echo "- ${name}: ${proc:-unknown} â€” ${exception:-no exception recorded}" >> "$GITHUB_STEP_SUMMARY"
              if [ -n "$thread" ]; then
                echo "  - ${thread}" >> "$GITHUB_STEP_SUMMARY"
              fi
            done
          else
            echo "- No crash reports collected." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload Maestro artifacts
        uses: actions/upload-artifact@v4
        if: ${{ always() && (github.event_name == 'workflow_dispatch' || needs.detect-impact.outputs.should-run == 'true') }}
        with:
          name: ios-maestro-release-artifacts
          path: packages/client/maestro-debug/
          retention-days: 7
          if-no-files-found: ignore
