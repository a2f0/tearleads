# Tuxedo tmux configuration
# Use a login shell so nvm and other tools initialize properly
set -g default-command "${SHELL} -l"

# Enable true color (24-bit) support for proper Tokyo Night colors
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",tmux-256color:Tc,screen-256color:Tc,xterm-256color:Tc,xterm-ghostty:Tc,ghostty:Tc"

# Set COLORTERM globally for truecolor support (required for Claude Code colors)
# Note: Don't add COLORTERM to update-environment, as SSH clients without it
# would cause tmux to mark it as "remove", overriding the global setting
set-environment -g COLORTERM truecolor

setw -g mode-keys vi

# Prevent shell from overwriting window names
set -g allow-rename off
set -g automatic-rename off

# Top status bar (main navigation)
set -g status on
set-option -g status-position top

# Bottom status bar using pane border (shows keybindings help)
# NOTE: Keybindings are hardcoded in pane-border-format. Update if bindings change.
set -g pane-border-status bottom
set -g pane-border-format '#[fg=#bb9af7]#(basename "#{pane_current_path}")#[fg=#565f89]:#[fg=#9ece6a]#(cd "#{pane_current_path}"; git rev-parse --abbrev-ref HEAD 2>/dev/null) #[align=centre,fg=#565f89]Ctrl+T: new tab │ Cmd+←/→: switch tabs │ Ctrl+R: reload │ Ctrl+K: clear '

# Tokyo Night color palette
# bg: #1a1b26, fg: #c0caf5, blue: #7aa2f7, purple: #bb9af7
# cyan: #7dcfff, orange: #ff9e64, green: #9ece6a

# Status bar styling (Tokyo Night)
set -g status-style "bg=#1a1b26,fg=#c0caf5"
# Show tmux server memory usage (helps detect memory leaks) + session name.
# Prefer the server PID from `tmux info`; fall back to tmux format PID if needed.
set -g status-left '#[fg=#ff9e64]#(pid=$(tmux info 2>/dev/null | awk "/^tmux server /{print \$3; exit}"); [ -n "$pid" ] || pid=$(tmux display-message -p "#{pid}" 2>/dev/null || true); [ -n "$pid" ] && ps -p "$pid" -o rss 2>/dev/null | awk "NR>1 {printf \"%%.0fM\", \$1/1024}") #[fg=#7aa2f7,bold][#S] '
set -g status-left-length 30

# cntrl + t to create a new window ('tab')
bind -n C-t run-shell 'tmux new-window -c "#{pane_current_path}"'

# Override default split bindings to inherit working directory
bind '"' run-shell 'tmux split-window -v -c "#{pane_current_path}"'
bind % run-shell 'tmux split-window -h -c "#{pane_current_path}"'

# cmd + left/right - move window left / right (via Ghostty keybind)
# Always focus the terminal pane (left side, pane 0) after switching
bind-key -n M-Left previous-window \; select-pane -t 0
bind-key -n M-Right next-window \; select-pane -t 0

# ctrl + number - jump to window by index (via Ghostty keybind)
# Always focus the terminal pane (left side, pane 0) after switching
bind-key -n M-0 select-window -t 0 \; select-pane -t 0
bind-key -n M-1 select-window -t 1 \; select-pane -t 0
bind-key -n M-2 select-window -t 2 \; select-pane -t 0
bind-key -n M-3 select-window -t 3 \; select-pane -t 0
bind-key -n M-4 select-window -t 4 \; select-pane -t 0
bind-key -n M-5 select-window -t 5 \; select-pane -t 0
bind-key -n M-6 select-window -t 6 \; select-pane -t 0
bind-key -n M-7 select-window -t 7 \; select-pane -t 0
bind-key -n M-8 select-window -t 8 \; select-pane -t 0
bind-key -n M-9 select-window -t 9 \; select-pane -t 0

# reload config (uses TUXEDO_TMUX_CONF env var set by tuxedo.sh)
bind-key -n C-r run-shell 'tmux source-file "${TUXEDO_TMUX_CONF:-$HOME/.tmux.conf}" && tmux display-message "Config reloaded"'

bind-key -n C-k clear-history \; send-keys clear Enter

# The refresh-client call forces pane borders to update (for branch display)
set -g status-right '#(tmux refresh-client 2>/dev/null; echo "")'
set -g status-right-length 0
set -g status-interval 5

# Window status styling
# Use simple named colors for compatibility
set -g window-status-style 'fg=brightblack'
set -g window-status-current-style 'fg=cyan,bold'
set -g window-status-format ' #W '
set -g window-status-current-format ' #W '
set -g window-status-separator "  "

# Pane border styling (Tokyo Night)
set -g pane-border-style "fg=#3b4261"
set -g pane-active-border-style "fg=#7aa2f7"

# Message styling
set -g message-style "bg=#1a1b26,fg=#7aa2f7"

# Mouse support
set -g mouse on
# In screen-backed panes, alternate_on can stay true and break drag selection.
# Detect GNU screen via regex to support screen, screen-5.0.1, etc.
bind -n MouseDown1Pane select-pane -t= \; send-keys -M
bind -n MouseDrag1Pane if-shell -F "#{||:#{pane_in_mode},#{&&:#{alternate_on},#{!=:#{m/r:^screen,#{pane_current_command}},1}}}" { send-keys -M } { copy-mode -M }

# Scrollback buffer - keep small since screen also has scrollback
# Large buffers across 20+ workspaces can cause memory issues
set -g history-limit 2000

# Scroll 3 lines at a time in copy-mode
bind -T copy-mode-vi WheelUpPane send-keys -X -N 3 scroll-up
bind -T copy-mode-vi WheelDownPane send-keys -X -N 3 scroll-down
# Copy selected text to tmux buffer when releasing mouse drag in copy-mode.
bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-selection-and-cancel

# Workaround: If Ghostty sends arrow keys in alternate screen mode,
# use them to scroll in copy-mode
bind -T copy-mode-vi Up send-keys -X scroll-up
bind -T copy-mode-vi Down send-keys -X scroll-down

# Right-click context menu
bind-key -n MouseDown3Pane display-menu -T "#[align=centre]Tuxedo" -x M -y M \
    "Reload Config       (Ctrl+R)" r 'run-shell "tmux source-file \"${TUXEDO_TMUX_CONF:-$HOME/.tmux.conf}\" && tmux display-message \"Config reloaded\""' \
    "" \
    "New Window          (Ctrl+T)" n 'run-shell "tmux new-window -c \"#{pane_current_path}\""' \
    "Kill Window                k" k "kill-window" \
    "" \
    "Split Horizontal           h" h 'run-shell "tmux split-window -h -c \"#{pane_current_path}\""' \
    "Split Vertical             v" v 'run-shell "tmux split-window -v -c \"#{pane_current_path}\""' \
    "Neovim (Tuxedo config)     N" N 'run-shell "tmux split-window -h -c \"#{pane_current_path}\" \"nvim -u \\\"$(dirname \\\"${TUXEDO_TMUX_CONF:?TUXEDO_TMUX_CONF not set}\\\")/neovim.lua\\\"\""' \
    "" \
    "Detach                     d" d "detach-client" \
    "" \
    "Kill Session               K" K "kill-session"
